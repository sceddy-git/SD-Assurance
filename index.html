<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ThousandEyes Endpoint Agents Budget Calculator and Operational Enablement</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0b0c10;
            --panel: #15161a;
            --text: #e8ecef;
            --muted: #9aa4ad;
            --accent: #2ea8ff;
            --accent-2: #7bd389;
            --border: #24262c;
            --danger: #ef476f;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            background: linear-gradient(180deg, #0b0c10 0%, #0f1117 100%);
            color: var(--text);
            min-height: 100svh;
            display: grid;
            place-items: start center;
            padding: 24px;
        }

        .container {
            width: 100%;
            max-width: 880px;
            background: color-mix(in oklab, var(--panel) 92%, black 8%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 4px 4px 16px 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            letter-spacing: 0.2px;
        }

        .subtle {
            color: var(--muted);
            font-size: 13px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 760px) {
            .grid {
                grid-template-columns: 1.2fr 1fr;
            }
        }

        .panel {
            background: color-mix(in oklab, var(--panel) 94%, black 6%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .row-1 { display: grid; grid-template-columns: 1fr; gap: 12px; }

        label { font-size: 13px; color: var(--muted); }
        .control { display: grid; gap: 6px; }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 12px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0f1117;
            color: var(--text);
            outline: none;
        }
        input::placeholder { color: #6b7280; }
        select { cursor: pointer; }

        .hint { font-size: 12px; color: var(--muted); }

        .results {
            display: grid;
            gap: 12px;
        }

        .result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #0f1218;
        }

        .result h3 { margin: 0; font-size: 14px; font-weight: 600; color: var(--muted); }
        .result .value { font-size: 28px; font-weight: 700; letter-spacing: 0.4px; }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
            background: #0f1218;
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 999px;
        }

        footer { margin-top: 8px; color: var(--muted); font-size: 12px; text-align: right; }
        .danger { color: var(--danger); }
        .ok { color: var(--accent-2); }
        .accent { color: var(--accent); }

        .stack { display: grid; gap: 10px; }
        .stack-lg { display: grid; gap: 16px; }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <main class="container" role="main">
        <header>
            <div>
                <h1>ThousandEyes Endpoint Agents Budget Calculator and Operational Enablement</h1>
                <div class="subtle">Enter your budget and per‑agent costs to estimate how many Endpoint Agents you can purchase for Advantage and Essentials.</div>
            </div>
            <div class="tag" aria-live="polite" id="currencyTag">Currency: <strong class="accent" id="currencyTagValue">USD</strong></div>
        </header>

        <nav style="display:flex; gap:8px; margin:8px 0 16px 0;">
            <button class="tab-btn" data-tab="calc" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#0f1218; color:var(--text);">EPA Calculator</button>
            <button class="tab-btn" data-tab="flows" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted);">EPA Licensing</button>
            <button class="tab-btn" data-tab="scheduler" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted);">EPA Scheduler</button>
        </nav>

        <section id="tab-calc" class="grid" aria-label="Calculator">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="budget">Total budget</label>
                        <input id="budget" name="budget" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 25000" aria-describedby="budgetHint">
                        <div class="hint" id="budgetHint">Total amount available to spend (same billing term as prices).</div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="priceAdv">Advantage price per agent (flat)</label>
                        <input id="priceAdv" name="priceAdv" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 50">
                        <div class="hint">Used only if tiers are empty. Otherwise the tiered scale applies.</div>
                    </div>
                    <div class="control">
                        <label for="priceEss">Essentials price per agent (flat)</label>
                        <input id="priceEss" name="priceEss" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 35">
                        <div class="hint">Used only if tiers are empty. Otherwise the tiered scale applies.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="panel">
                        <div class="stack">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <label>Advantage tiers</label>
                                <button id="addTierAdv" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0f1218; color:var(--text);">Add tier</button>
                            </div>
                            <div class="hint">Define blocks where price decreases as you buy more. "Up to" is the cumulative agent count for that tier. Leave last "Up to" empty for no cap.</div>
                            <div id="tiers-adv" class="stack"></div>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="panel">
                        <div class="stack">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <label>Essentials tiers</label>
                                <button id="addTierEss" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0f1218; color:var(--text);">Add tier</button>
                            </div>
                            <div class="hint">Define blocks where price decreases as you buy more. "Up to" is the cumulative agent count for that tier. Leave last "Up to" empty for no cap.</div>
                            <div id="tiers-ess" class="stack"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="currency">Currency</label>
                        <select id="currency" name="currency" aria-describedby="curHint">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro (Europe)</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="MXN">MXN - Mexican Peso</option>
                        </select>
                        <div class="hint" id="curHint">Select currency for price formatting. <button id="fetchRates" type="button" style="margin-top:4px; padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:#0f1218; color:var(--text); font-size:11px;">Update exchange rates</button></div>
                    </div>
                    <div class="control">
                        <label for="rounding">Rounding</label>
                        <input id="rounding" name="rounding" type="text" value="down" aria-describedby="roundHint">
                        <div class="hint" id="roundHint">"down" to floor to whole agents, "nearest" to round to nearest.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="showAvg">Display options</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="showAvg" name="showAvg" type="checkbox">
                            <span class="hint">Show effective average price at computed quantity</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result" id="res-adv">
                    <h3>Advantage agents</h3>
                    <div class="value" id="advCount">–</div>
                </div>
                <div class="result" id="res-ess">
                    <h3>Essentials agents</h3>
                    <div class="value" id="essCount">–</div>
                </div>
                <div class="result" id="res-leftover-adv">
                    <h3>Unspent budget (Advantage)</h3>
                    <div class="value" id="leftoverAdv">–</div>
                </div>
                <div class="result" id="res-leftover-ess">
                    <h3>Unspent budget (Essentials)</h3>
                    <div class="value" id="leftoverEss">–</div>
                </div>
                <div class="result" id="res-avg-adv" style="display:none;">
                    <h3>Effective average price (Advantage)</h3>
                    <div class="value" id="avgPriceAdv">–</div>
                </div>
                <div class="result" id="res-avg-ess" style="display:none;">
                    <h3>Effective average price (Essentials)</h3>
                    <div class="value" id="avgPriceEss">–</div>
                </div>
                <div class="result" id="res-rates" style="display:none;">
                    <h3>Exchange rates (vs USD)</h3>
                    <div class="value" id="ratesDisplay" style="font-size:14px; line-height:1.6;">–</div>
                </div>
            </div>
        </section>

        <section id="tab-flows" class="stack-lg" aria-label="EPA Licensing" style="display:none;">
            <div class="panel stack-lg">
                <div class="row">
                    <div class="control">
                        <label for="apiBase">ThousandEyes API base URL</label>
                        <input id="apiBase" name="apiBase" type="text" placeholder="https://api.thousandeyes.com">
                        <div class="hint">Set your API base. Must allow CORS in browser context.</div>
                    </div>
                    <div class="control">
                        <label for="apiToken">API Token</label>
                        <input id="apiToken" name="apiToken" type="text" placeholder="TE Bearer token">
                        <div class="hint">Stored only in your browser. Do not share.</div>
                    </div>
                </div>
                <div class="row">
                    <div class="control">
                        <label for="accountGroupId">Account Group ID</label>
                        <input id="accountGroupId" name="accountGroupId" type="text" placeholder="e.g. 12345">
                    </div>
                    <div class="control">
                        <label for="switchEndpoint">License switch endpoint path</label>
                        <input id="switchEndpoint" name="switchEndpoint" type="text" placeholder="/v6/endpoint-agents/license">
                        <div class="hint">Full URL will be base + path. Body will include desired license.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="agentTags">Endpoint agent tags</label>
                        <input id="agentTags" name="agentTags" type="text" placeholder="tagA, tagB">
                        <div class="hint">Comma-separated tags to include when switching licenses or counting agents.</div>
                    </div>
                    <div class="control">
                        <label for="agentsEndpoint">Agents list endpoint path</label>
                        <input id="agentsEndpoint" name="agentsEndpoint" type="text" placeholder="/v6/endpoint-agents">
                        <div class="hint">Used for counting licenses per type.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="dryRun">Dry run mode</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="dryRun" name="dryRun" type="checkbox">
                            <span class="hint">Skip live API calls and just log what would happen.</span>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <button id="refreshCounts" type="button" style="padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:#0f1218; color:var(--text); width:100%;">Refresh license counts</button>
                        <div class="hint">Runs the ThousandEyes agent list endpoint (filtered by tags) and summarizes Advantage vs Essentials counts.</div>
                    </div>
                </div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result">
                    <h3>Advantage agents (current)</h3>
                    <div class="value" id="currentAdvCount">–</div>
                </div>
                <div class="result">
                    <h3>Essentials agents (current)</h3>
                    <div class="value" id="currentEssCount">–</div>
                </div>
                <div class="result">
                    <h3>Last refresh status</h3>
                    <div class="value" id="lastCountStatus">–</div>
                </div>
            </div>
        </section>

        <section id="tab-scheduler" class="stack-lg" aria-label="EPA Scheduler" style="display:none;">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="schedulerEnabled">Scheduler</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="schedulerEnabled" name="schedulerEnabled" type="checkbox">
                            <span class="hint">Enable automatic EPA endpoint toggling while this page is open. Uses API base/token + dry run toggle from EPA Licensing.</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="control">
                        <label for="stateEndpoint">Endpoint control API path</label>
                        <input id="stateEndpoint" name="stateEndpoint" type="text" placeholder="/v6/endpoint-agents/state">
                        <div class="hint">POST target that accepts { label, action } with action = enable | disable.</div>
                    </div>
                    <div class="control">
                        <label for="schedulerFrequency">Check frequency (seconds)</label>
                        <input id="schedulerFrequency" name="schedulerFrequency" type="number" min="15" step="15" value="60">
                        <div class="hint">How often to evaluate schedules. Minimum 15s.</div>
                    </div>
                </div>
            </div>

            <div class="panel stack-lg">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <label>EPA schedules</label>
                    <button id="addSchedulerEntry" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0f1218; color:var(--text);">Add schedule</button>
                </div>
                <div class="hint">Each row controls endpoints matching a label for the specified time window. Leave “to” earlier than “from” to span midnight.</div>
                <div id="schedulerList" class="stack"></div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result">
                    <h3>Active instructions right now</h3>
                    <div class="value" id="schedulerSnapshot">–</div>
                </div>
                <div class="result">
                    <h3>Scheduler log</h3>
                    <div class="value" id="schedulerLog">–</div>
                </div>
            </div>
        </section>

        <footer>
            Sample calculator. Enter your actual ThousandEyes pricing for accurate results.
        </footer>
    </main>

    <script>
        (function() {
            // Tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabCalc = document.getElementById('tab-calc');
            const tabFlows = document.getElementById('tab-flows');
            const tabScheduler = document.getElementById('tab-scheduler');
            let activeTab = 'calc';
            function setTab(tab) {
                activeTab = tab;
                tabCalc.style.display = tab === 'calc' ? '' : 'none';
                tabFlows.style.display = tab === 'flows' ? '' : 'none';
                tabScheduler.style.display = tab === 'scheduler' ? '' : 'none';
                tabButtons.forEach(btn => {
                    const isActive = btn.dataset.tab === tab;
                    btn.style.background = isActive ? '#0f1218' : 'transparent';
                    btn.style.color = isActive ? 'var(--text)' : 'var(--muted)';
                });
                try {
                    const state = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    state.activeTab = activeTab;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(state));
                } catch {}
            }
            tabButtons.forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
            const budgetEl = document.getElementById('budget');
            const priceAdvEl = document.getElementById('priceAdv');
            const priceEssEl = document.getElementById('priceEss');
            const currencyEl = document.getElementById('currency');
            const roundingEl = document.getElementById('rounding');
            const showAvgEl = document.getElementById('showAvg');
            const fetchRatesBtn = document.getElementById('fetchRates');
            const ratesDisplayEl = document.getElementById('ratesDisplay');
            const resRates = document.getElementById('res-rates');

            const advCountEl = document.getElementById('advCount');
            const essCountEl = document.getElementById('essCount');
            const leftoverAdvEl = document.getElementById('leftoverAdv');
            const leftoverEssEl = document.getElementById('leftoverEss');
            const currencyTagValue = document.getElementById('currencyTagValue');
            const avgPriceAdvEl = document.getElementById('avgPriceAdv');
            const avgPriceEssEl = document.getElementById('avgPriceEss');
            const resAvgAdv = document.getElementById('res-avg-adv');
            const resAvgEss = document.getElementById('res-avg-ess');

            const tiersAdvContainer = document.getElementById('tiers-adv');
            const tiersEssContainer = document.getElementById('tiers-ess');
            const addTierAdvBtn = document.getElementById('addTierAdv');
            const addTierEssBtn = document.getElementById('addTierEss');

            // Workflows elements
            const apiBaseEl = document.getElementById('apiBase');
            const apiTokenEl = document.getElementById('apiToken');
            const accountGroupIdEl = document.getElementById('accountGroupId');
            const switchEndpointEl = document.getElementById('switchEndpoint');
            const agentTagsEl = document.getElementById('agentTags');
            const agentsEndpointEl = document.getElementById('agentsEndpoint');
            const dryRunEl = document.getElementById('dryRun');
            const refreshCountsBtn = document.getElementById('refreshCounts');
            const currentAdvCountEl = document.getElementById('currentAdvCount');
            const currentEssCountEl = document.getElementById('currentEssCount');
            const lastCountStatusEl = document.getElementById('lastCountStatus');
            // Scheduler elements
            const schedulerEnabledEl = document.getElementById('schedulerEnabled');
            const stateEndpointEl = document.getElementById('stateEndpoint');
            const schedulerFrequencyEl = document.getElementById('schedulerFrequency');
            const schedulerListEl = document.getElementById('schedulerList');
            const addSchedulerEntryBtn = document.getElementById('addSchedulerEntry');
            const schedulerSnapshotEl = document.getElementById('schedulerSnapshot');
            const schedulerLogEl = document.getElementById('schedulerLog');

            // Defaults you can adjust
            const defaults = {
                budget: '',
                priceAdv: '',
                priceEss: '',
                currency: 'USD',
                rounding: 'down',
                showAvg: false,
                tiersAdv: [
                    { upTo: 500, price: 50 },
                    { upTo: 2000, price: 45 },
                    { upTo: null, price: 40 }
                ],
                tiersEss: [
                    { upTo: 500, price: 35 },
                    { upTo: 2000, price: 30 },
                    { upTo: null, price: 25 }
                ],
                // workflows defaults
                activeTab: 'calc',
                apiBase: 'https://api.thousandeyes.com',
                apiToken: '',
                accountGroupId: '',
                switchEndpoint: '/v6/endpoint-agents/license',
                agentTags: '',
                agentsEndpoint: '/v6/endpoint-agents',
                dryRun: true,
                schedulerEnabled: false,
                stateEndpoint: '/v6/endpoint-agents/state',
                schedulerFrequency: 60,
                schedulerEntries: [
                    { label: 'EPA-Branch-1', from: '08:00', to: '18:00', action: 'enable' },
                    { label: 'EPA-Branch-1', from: '18:00', to: '08:00', action: 'disable' }
                ]
            };

            // Load saved values from localStorage
            try {
                const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                const blended = { ...defaults, ...saved };
                for (const [k, v] of Object.entries(blended)) {
                    const el = document.getElementById(k);
                    if (!el || typeof v === 'undefined' || v === null) continue;
                    if (el.type === 'checkbox') el.checked = Boolean(v); else el.value = v;
                }
                // render tiers from saved
                renderTierEditor('adv', blended.tiersAdv || defaults.tiersAdv);
                renderTierEditor('ess', blended.tiersEss || defaults.tiersEss);
                // set active tab
                setTab(blended.activeTab || 'calc');
                // seed API/config to inputs
                apiBaseEl.value = blended.apiBase || defaults.apiBase;
                apiTokenEl.value = blended.apiToken || defaults.apiToken;
                accountGroupIdEl.value = blended.accountGroupId || defaults.accountGroupId;
                switchEndpointEl.value = blended.switchEndpoint || defaults.switchEndpoint;
                agentTagsEl.value = blended.agentTags || defaults.agentTags;
                agentsEndpointEl.value = blended.agentsEndpoint || defaults.agentsEndpoint;
                dryRunEl.checked = blended.dryRun !== undefined ? !!blended.dryRun : defaults.dryRun;
                schedulerEnabledEl.checked = blended.schedulerEnabled || false;
                stateEndpointEl.value = blended.stateEndpoint || defaults.stateEndpoint;
                schedulerFrequencyEl.value = blended.schedulerFrequency || defaults.schedulerFrequency;
                renderSchedulerEntries(blended.schedulerEntries || defaults.schedulerEntries);
            } catch {}

            function save() {
                const data = {
                    budget: budgetEl.value,
                    priceAdv: priceAdvEl.value,
                    priceEss: priceEssEl.value,
                    currency: (currencyEl.value || 'USD').toUpperCase(),
                    rounding: (roundingEl.value || 'down').toLowerCase(),
                    showAvg: !!showAvgEl.checked,
                    tiersAdv: readTiers('adv'),
                    tiersEss: readTiers('ess'),
                    // workflows
                    activeTab,
                    apiBase: apiBaseEl.value,
                    apiToken: apiTokenEl.value,
                    accountGroupId: accountGroupIdEl.value,
                    switchEndpoint: switchEndpointEl.value,
                    agentTags: agentTagsEl.value,
                    agentsEndpoint: agentsEndpointEl.value,
                    dryRun: !!dryRunEl.checked,
                    schedulerEnabled: !!schedulerEnabledEl.checked,
                    stateEndpoint: stateEndpointEl.value,
                    schedulerFrequency: schedulerFrequencyEl.value,
                    schedulerEntries: readSchedulerEntries()
                };
                localStorage.setItem('teBudgetCalc', JSON.stringify(data));
            }

            function fmtCurrency(n, currency) {
                if (!isFinite(n)) return '–';
                try {
                    return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(n);
                } catch {
                    return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(n);
                }
            }

            function fmtInt(n) {
                if (!isFinite(n)) return '–';
                return new Intl.NumberFormat().format(n);
            }

            function parseNum(input) {
                const val = typeof input === 'string' ? input.trim() : (input?.toString?.() ?? '');
                if (val === '') return NaN;
                const n = Number(val);
                return isFinite(n) ? n : NaN;
            }

            function normalizeTiers(tiersRaw) {
                const tiers = (tiersRaw || [])
                    .map(t => ({ upTo: (t.upTo === null || t.upTo === '' || t.upTo === undefined) ? null : Number(t.upTo), price: Number(t.price) }))
                    .filter(t => isFinite(t.price) && t.price > 0 && (t.upTo === null || (isFinite(t.upTo) && t.upTo > 0)));
                tiers.sort((a, b) => {
                    if (a.upTo === null) return 1;
                    if (b.upTo === null) return -1;
                    return a.upTo - b.upTo;
                });
                // ensure last tier is open-ended
                if (!tiers.length || tiers[tiers.length - 1].upTo !== null) tiers.push({ upTo: null, price: tiers.length ? tiers[tiers.length - 1].price : NaN });
                // remove duplicates with same upTo keeping lowest price
                const compact = [];
                for (const t of tiers) {
                    const last = compact[compact.length - 1];
                    if (last && last.upTo === t.upTo) last.price = Math.min(last.price, t.price); else compact.push(t);
                }
                return compact.filter(t => isFinite(t.price));
            }

            function costForQuantity(quantity, tiers) {
                // Block/step pricing: first block up to tiers[0].upTo at price, next block at next price, etc.
                let remaining = quantity;
                let prevCap = 0;
                let total = 0;
                for (const tier of tiers) {
                    const cap = tier.upTo === null ? Infinity : tier.upTo;
                    const block = Math.max(0, Math.min(remaining, cap - prevCap));
                    if (block <= 0) { prevCap = cap; continue; }
                    total += block * tier.price;
                    remaining -= block;
                    prevCap = cap;
                    if (remaining <= 0) break;
                }
                return total;
            }

            function maxAgentsUnderBudget(budget, tiers, roundingMode) {
                if (!isFinite(budget) || budget <= 0 || !tiers.length) return { agents: NaN, spent: NaN, leftover: NaN };
                const tiersNorm = normalizeTiers(tiers);
                // Exponential then binary search to find maximum agents where cost <= budget
                let low = 0, high = 1;
                while (costForQuantity(high, tiersNorm) <= budget && high < 1e9) {
                    low = high;
                    high *= 2;
                }
                while (low < high) {
                    const mid = Math.floor((low + high + 1) / 2);
                    const cost = costForQuantity(mid, tiersNorm);
                    if (cost <= budget) low = mid; else high = mid - 1;
                }
                let agents = low;
                if (roundingMode === 'nearest') {
                    // Try +/- 1 around low to approximate nearest under monotonic cost
                    const costLow = costForQuantity(low, tiersNorm);
                    const costUp = costForQuantity(low + 1, tiersNorm);
                    if (Math.abs(budget - costUp) < Math.abs(budget - costLow) && costUp <= budget) agents = low + 1;
                }
                const spent = costForQuantity(agents, tiersNorm);
                const leftover = budget - spent;
                return { agents, spent, leftover };
            }

            function makeTierRow(kind, idx, tier) {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr auto';
                row.style.gap = '8px';
                row.dataset.index = String(idx);

                const upTo = document.createElement('input');
                upTo.type = 'number';
                upTo.min = '1';
                upTo.step = '1';
                upTo.placeholder = 'Up to (qty)';
                upTo.value = tier.upTo == null ? '' : String(tier.upTo);
                upTo.setAttribute('aria-label', 'Up to quantity');

                const price = document.createElement('input');
                price.type = 'number';
                price.min = '0';
                price.step = '0.01';
                price.placeholder = 'Price per agent';
                price.value = tier.price != null ? String(tier.price) : '';
                price.setAttribute('aria-label', 'Price');

                const del = document.createElement('button');
                del.type = 'button';
                del.textContent = 'Remove';
                del.style.padding = '8px 10px';
                del.style.borderRadius = '8px';
                del.style.border = '1px solid var(--border)';
                del.style.background = '#0f1218';
                del.style.color = 'var(--text)';

                del.addEventListener('click', () => {
                    const arr = readTiers(kind);
                    arr.splice(idx, 1);
                    renderTierEditor(kind, arr);
                    compute();
                });

                for (const el of [upTo, price]) {
                    el.addEventListener('input', () => {
                        const arr = readTiers(kind);
                        arr[idx] = { upTo: upTo.value === '' ? null : Number(upTo.value), price: Number(price.value) };
                        renderTierEditor(kind, arr);
                        compute();
                    });
                    el.addEventListener('change', () => {
                        compute();
                    });
                }

                row.appendChild(upTo);
                row.appendChild(price);
                row.appendChild(del);
                return row;
            }

            function renderTierEditor(kind, tiers) {
                const container = kind === 'adv' ? tiersAdvContainer : tiersEssContainer;
                container.innerHTML = '';
                const current = tiers && tiers.length ? tiers : [{ upTo: 500, price: 50 }, { upTo: null, price: 40 }];
                current.forEach((t, i) => container.appendChild(makeTierRow(kind, i, t)));
                // Save to storage after render
                save();
            }

            function readTiers(kind) {
                const container = kind === 'adv' ? tiersAdvContainer : tiersEssContainer;
                const rows = Array.from(container.children);
                return rows.map(row => {
                    const [upToEl, priceEl] = row.querySelectorAll('input');
                    const upToVal = upToEl.value === '' ? null : Number(upToEl.value);
                    const priceVal = Number(priceEl.value);
                    return { upTo: upToVal, price: priceVal };
                });
            }

            function compute() {
                const budget = parseNum(budgetEl.value);
                const priceAdv = parseNum(priceAdvEl.value);
                const priceEss = parseNum(priceEssEl.value);
                const currency = (currencyEl.value || 'USD').toUpperCase();
                let rounding = (roundingEl.value || 'down').toLowerCase();
                if (rounding !== 'down' && rounding !== 'nearest') rounding = 'down';
                const showAvg = !!showAvgEl.checked;

                currencyTagValue.textContent = currency;

                const tiersAdv = normalizeTiers(readTiers('adv'));
                const tiersEss = normalizeTiers(readTiers('ess'));

                let advAgents, advSpent, advLeft;
                if (tiersAdv.length && isFinite(budget)) {
                    const res = maxAgentsUnderBudget(budget, tiersAdv, rounding);
                    advAgents = res.agents; advSpent = res.spent; advLeft = res.leftover;
                } else {
                    const raw = (isFinite(budget) && isFinite(priceAdv) && priceAdv > 0) ? budget / priceAdv : NaN;
                    advAgents = rounding === 'nearest' ? Math.round(raw) : Math.floor(raw);
                    advSpent = isFinite(advAgents) ? advAgents * priceAdv : NaN;
                    advLeft = isFinite(budget) ? budget - advSpent : NaN;
                }

                let essAgents, essSpent, essLeft;
                if (tiersEss.length && isFinite(budget)) {
                    const res = maxAgentsUnderBudget(budget, tiersEss, rounding);
                    essAgents = res.agents; essSpent = res.spent; essLeft = res.leftover;
                } else {
                    const raw = (isFinite(budget) && isFinite(priceEss) && priceEss > 0) ? budget / priceEss : NaN;
                    essAgents = rounding === 'nearest' ? Math.round(raw) : Math.floor(raw);
                    essSpent = isFinite(essAgents) ? essAgents * priceEss : NaN;
                    essLeft = isFinite(budget) ? budget - essSpent : NaN;
                }

                advCountEl.textContent = fmtInt(advAgents);
                essCountEl.textContent = fmtInt(essAgents);
                leftoverAdvEl.textContent = fmtCurrency(advLeft, currency);
                leftoverEssEl.textContent = fmtCurrency(essLeft, currency);

                // Effective average price (spent / agents)
                const avgAdv = isFinite(advSpent) && isFinite(advAgents) && advAgents > 0 ? (advSpent / advAgents) : NaN;
                const avgEss = isFinite(essSpent) && isFinite(essAgents) && essAgents > 0 ? (essSpent / essAgents) : NaN;
                avgPriceAdvEl.textContent = isFinite(avgAdv) ? fmtCurrency(avgAdv, currency) : '–';
                avgPriceEssEl.textContent = isFinite(avgEss) ? fmtCurrency(avgEss, currency) : '–';
                resAvgAdv.style.display = showAvg ? '' : 'none';
                resAvgEss.style.display = showAvg ? '' : 'none';

                save();
            }

            const inputs = [budgetEl, priceAdvEl, priceEssEl, currencyEl, roundingEl, showAvgEl];
            for (const el of inputs) {
                el.addEventListener('input', compute);
                el.addEventListener('change', compute);
            }

            addTierAdvBtn.addEventListener('click', () => {
                const tiers = readTiers('adv');
                tiers.push({ upTo: '', price: '' });
                renderTierEditor('adv', tiers);
                compute();
            });

            addTierEssBtn.addEventListener('click', () => {
                const tiers = readTiers('ess');
                tiers.push({ upTo: '', price: '' });
                renderTierEditor('ess', tiers);
                compute();
            });

            // Exchange rate fetching
            async function fetchExchangeRates() {
                const CACHE_KEY = 'teExchangeRates';
                const CACHE_DURATION = 60 * 60 * 1000; // 1 hour
                
                // Check cache first
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < CACHE_DURATION)) {
                        displayRates(cached.rates);
                        return;
                    }
                } catch {}

                fetchRatesBtn.textContent = 'Updating...';
                fetchRatesBtn.disabled = true;
                
                try {
                    // Using exchangerate-api.io free tier (no API key needed for basic usage)
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    const rates = data.rates || {};
                    
                    // Cache the rates
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        rates,
                        timestamp: Date.now()
                    }));
                    
                    displayRates(rates);
                } catch (err) {
                    ratesDisplayEl.textContent = 'Error: ' + (err.message || 'Failed to fetch rates');
                    resRates.style.display = '';
                } finally {
                    fetchRatesBtn.textContent = 'Update exchange rates';
                    fetchRatesBtn.disabled = false;
                }
            }

            function displayRates(rates) {
                const currencies = ['EUR', 'JPY', 'AUD', 'MXN'];
                const lines = currencies.map(code => {
                    const rate = rates[code];
                    if (!rate) return null;
                    return `${code}: ${rate.toFixed(4)}`;
                }).filter(Boolean);
                
                if (lines.length > 0) {
                    ratesDisplayEl.textContent = lines.join(' • ');
                    resRates.style.display = '';
                } else {
                    ratesDisplayEl.textContent = 'No rates available';
                    resRates.style.display = '';
                }
            }

            fetchRatesBtn.addEventListener('click', fetchExchangeRates);
            
            // Load cached rates on page load
            try {
                const cached = JSON.parse(localStorage.getItem('teExchangeRates') || '{}');
                if (cached.rates) displayRates(cached.rates);
            } catch {}

            function getTagList() {
                return (agentTagsEl.value || '')
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(Boolean);
            }
            dryRunEl.addEventListener('change', () => { save(); });

            const workflowInputs = [
                apiBaseEl,
                apiTokenEl,
                accountGroupIdEl,
                switchEndpointEl,
                agentTagsEl,
                agentsEndpointEl,
                stateEndpointEl,
                schedulerFrequencyEl
            ];
            workflowInputs.forEach(el => {
                el.addEventListener('input', () => save());
                el.addEventListener('change', () => save());
            });

            async function fetchLicenseCounts() {
                const tags = getTagList();
                if (dryRunEl.checked) {
                    const simulated = {
                        Advantage: Math.max(0, Number(advCountEl.textContent.replace(/[^0-9]/g, '')) || 0),
                        Essentials: Math.max(0, Number(essCountEl.textContent.replace(/[^0-9]/g, '')) || 0)
                    };
                    currentAdvCountEl.textContent = fmtInt(simulated.Advantage);
                    currentEssCountEl.textContent = fmtInt(simulated.Essentials);
                    lastCountStatusEl.textContent = 'Dry run at ' + new Date().toLocaleTimeString();
                    return;
                }
                const base = (apiBaseEl.value || '').replace(/\/$/, '');
                const path = agentsEndpointEl.value || '';
                const token = apiTokenEl.value.trim();
                if (!base || !path || !token) {
                    lastCountStatusEl.textContent = 'Missing API configuration';
                    return;
                }
                const url = new URL(base + path, window.location.origin);
                const params = new URLSearchParams();
                tags.forEach(tag => params.append('tag', tag));
                const finalUrl = params.toString() ? `${base + path}?${params.toString()}` : base + path;
                try {
                    lastCountStatusEl.textContent = 'Fetching…';
                    const resp = await fetch(finalUrl, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!resp.ok) {
                        const text = await resp.text().catch(() => '');
                        throw new Error(`API ${resp.status}: ${text || resp.statusText}`);
                    }
                    const data = await resp.json();
                    const agents = data?.endpointAgents || data?.agents || data?.items || [];
                    const counts = { Advantage: 0, Essentials: 0 };
                    agents.forEach(agent => {
                        const type = agent?.licenseType || agent?.license || '';
                        if (type && counts[type] !== undefined) counts[type] += 1;
                    });
                    currentAdvCountEl.textContent = fmtInt(counts.Advantage);
                    currentEssCountEl.textContent = fmtInt(counts.Essentials);
                    lastCountStatusEl.textContent = `Updated at ${new Date().toLocaleTimeString()}`;
                } catch (err) {
                    lastCountStatusEl.textContent = 'Error: ' + (err?.message || String(err));
                }
            }

            refreshCountsBtn.addEventListener('click', fetchLicenseCounts);

            // ---------- EPA Scheduler ----------
            function timeToMinutes(t) {
                const m = /^([0-1]?\\d|2[0-3]):([0-5]\\d)$/.exec((t || '').trim());
                if (!m) return NaN;
                return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
            }

            function makeSchedulerEntryRow(entry = {}) {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1.2fr 1fr 1fr 1fr auto';
                row.style.gap = '8px';
                row.className = 'scheduler-row';

                const labelEl = document.createElement('input');
                labelEl.type = 'text';
                labelEl.placeholder = 'Label (case-sensitive)';
                labelEl.value = entry.label || '';

                const fromEl = document.createElement('input');
                fromEl.type = 'text';
                fromEl.placeholder = 'From HH:MM';
                fromEl.value = entry.from || '';

                const toEl = document.createElement('input');
                toEl.type = 'text';
                toEl.placeholder = 'To HH:MM';
                toEl.value = entry.to || '';

                const actionEl = document.createElement('select');
                ['enable', 'disable'].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
                    actionEl.appendChild(option);
                });
                actionEl.value = entry.action || 'enable';

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.textContent = 'Remove';
                delBtn.style.padding = '8px 10px';
                delBtn.style.borderRadius = '8px';
                delBtn.style.border = '1px solid var(--border)';
                delBtn.style.background = '#0f1218';
                delBtn.style.color = 'var(--text)';

                delBtn.addEventListener('click', () => {
                    row.remove();
                    save();
                    resetSchedulerState();
                });

                [labelEl, fromEl, toEl, actionEl].forEach(el => {
                    el.addEventListener('input', () => { save(); resetSchedulerState(); });
                    el.addEventListener('change', () => { save(); resetSchedulerState(); });
                });

                row.append(labelEl, fromEl, toEl, actionEl, delBtn);
                return row;
            }

            function renderSchedulerEntries(entries) {
                schedulerListEl.innerHTML = '';
                (entries && entries.length ? entries : []).forEach(entry => {
                    schedulerListEl.appendChild(makeSchedulerEntryRow(entry));
                });
                if (!schedulerListEl.children.length) {
                    schedulerListEl.appendChild(makeSchedulerEntryRow());
                }
            }

            function readSchedulerEntries() {
                const rows = Array.from(schedulerListEl.querySelectorAll('.scheduler-row'));
                return rows.map(row => {
                    const [labelEl, fromEl, toEl, actionEl] = row.querySelectorAll('input, select');
                    return {
                        label: labelEl.value.trim(),
                        from: fromEl.value.trim(),
                        to: toEl.value.trim(),
                        action: actionEl.value
                    };
                }).filter(e => e.label && e.from && e.to && e.action);
            }

            addSchedulerEntryBtn.addEventListener('click', () => {
                schedulerListEl.appendChild(makeSchedulerEntryRow());
                save();
                resetSchedulerState();
            });

            function getSchedulerFrequencyMs() {
                const freq = Number(schedulerFrequencyEl.value);
                const safe = isFinite(freq) && freq >= 15 ? freq : 60;
                return safe * 1000;
            }

            function logScheduler(message) {
                schedulerLogEl.textContent = message;
            }

            function formatSnapshot(instructions) {
                const entries = Object.entries(instructions || {});
                if (!entries.length) return '–';
                return entries.map(([label, action]) => `${label}: ${action}`).join(', ');
            }

            function computeCurrentInstructions(entries) {
                const now = new Date();
                const minutes = now.getHours() * 60 + now.getMinutes();
                const instructions = {};
                for (const entry of entries) {
                    const fromM = timeToMinutes(entry.from);
                    const toM = timeToMinutes(entry.to);
                    if (!isFinite(fromM) || !isFinite(toM)) continue;
                    const wraps = toM <= fromM;
                    const inRange = wraps ? (minutes >= fromM || minutes < toM) : (minutes >= fromM && minutes < toM);
                    if (inRange && instructions[entry.label] === undefined) {
                        instructions[entry.label] = entry.action;
                    }
                }
                return instructions;
            }

            const lastSchedulerActions = new Map();
            function resetSchedulerState() {
                lastSchedulerActions.clear();
                schedulerSnapshotEl.textContent = '–';
            }

            async function updateEndpointState(label, action) {
                if (dryRunEl.checked) {
                    await new Promise(resolve => setTimeout(resolve, 150));
                    return { dryRun: true, label, action };
                }
                const base = (apiBaseEl.value || '').replace(/\/$/, '');
                const path = stateEndpointEl.value || '';
                const token = apiTokenEl.value.trim();
                if (!base || !path || !token) throw new Error('Missing API configuration');
                const url = base + path;
                const body = {
                    label,
                    action,
                    accountGroupId: accountGroupIdEl.value || undefined
                };
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    throw new Error(`API ${resp.status}: ${text || resp.statusText}`);
                }
                return resp.json().catch(() => ({}));
            }

            let schedulerTimer = null;
            let schedulerTickInFlight = false;

            async function runScheduler() {
                if (schedulerTickInFlight) return;
                if (!schedulerEnabledEl.checked) {
                    schedulerSnapshotEl.textContent = '–';
                    return;
                }
                schedulerTickInFlight = true;
                try {
                    const entries = readSchedulerEntries();
                    const instructions = computeCurrentInstructions(entries);
                    schedulerSnapshotEl.textContent = formatSnapshot(instructions);
                    const labels = Object.keys(instructions);
                    if (!labels.length) {
                        schedulerTickInFlight = false;
                        return;
                    }
                    for (const label of labels) {
                        const action = instructions[label];
                        if (!action) continue;
                        if (lastSchedulerActions.get(label) === action) continue;
                        try {
                            await updateEndpointState(label, action);
                            lastSchedulerActions.set(label, action);
                            logScheduler(`Set ${label} → ${action} at ${new Date().toLocaleTimeString()}`);
                        } catch (err) {
                            logScheduler(`Error ${label}: ${err?.message || err}`);
                        }
                    }
                } finally {
                    schedulerTickInFlight = false;
                }
            }

            function restartSchedulerTimer() {
                if (schedulerTimer) clearInterval(schedulerTimer);
                schedulerTimer = setInterval(runScheduler, getSchedulerFrequencyMs());
            }

            schedulerEnabledEl.addEventListener('change', () => {
                save();
                resetSchedulerState();
                runScheduler();
            });

            schedulerFrequencyEl.addEventListener('change', () => {
                save();
                restartSchedulerTimer();
            });

            stateEndpointEl.addEventListener('change', () => {
                save();
                resetSchedulerState();
            });

            restartSchedulerTimer();
            runScheduler();

            compute();
        })();
    </script>
</body>
</html>


