<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ThousandEyes Endpoint Agents Budget Calculator and Operational Enablement</title>
    <style>
        :root {
            color-scheme: light dark;
            /* Dark Mode: ThousandEyes Dark Blue Theme */
            --bg: #0d1b2a;
            --panel: #1b263b;
            --text: #e0e1dd;
            --muted: #778da9;
            --accent: #0080ff;
            --accent-2: #7bd389;
            --border: #415a77;
            --danger: #ef476f;
        }

        :root[data-theme="light"] {
            /* Light Mode: ThousandEyes Light Orange Theme */
            --bg: #fff4e6;
            --panel: #ffffff;
            --text: #2d1810;
            --muted: #8b6f47;
            --accent: #ff6b35;
            --accent-2: #059669;
            --border: #f4d19e;
            --danger: #dc2626;
        }

        :root[data-theme="light"] body {
            background: linear-gradient(180deg, #fff4e6 0%, #ffe8cc 100%);
        }

        :root[data-theme="light"] .container {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        :root[data-theme="light"] input[type="number"],
        :root[data-theme="light"] input[type="text"],
        :root[data-theme="light"] select {
            background: #ffffff;
            border-color: #f4d19e;
            color: var(--text);
        }

        :root[data-theme="light"] .panel {
            background: #ffffff;
        }

        :root[data-theme="light"] .result {
            background: #ffffff;
        }

        :root[data-theme="light"] .tag {
            background: #fff8f0;
            border-color: #f4d19e;
        }

        :root[data-theme="light"] button {
            background: var(--panel);
        }

        :root[data-theme="light"] button:hover {
            background: #fff8f0;
        }

        :root[data-theme="light"] .sidebar {
            background: #fff8f0;
        }

        :root[data-theme="light"] .sidebar-nav button.active {
            background: var(--accent);
            color: white;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            background: linear-gradient(180deg, #0d1b2a 0%, #1b263b 100%);
            color: var(--text);
            min-height: 100svh;
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 0;
        }

        .sidebar {
            background: color-mix(in oklab, var(--panel) 96%, black 4%);
            border-right: 1px solid var(--border);
            padding: 20px;
            min-height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 16px;
            margin: 0 0 16px 0;
            color: var(--text);
            font-weight: 600;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-nav button {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--muted);
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .sidebar-nav button:hover {
            background: color-mix(in oklab, var(--panel) 90%, black 10%);
            color: var(--text);
        }

        .sidebar-nav button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .main-content {
            padding: 24px;
            overflow-y: auto;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .container {
            width: 100%;
            max-width: 880px;
            background: color-mix(in oklab, var(--panel) 92%, black 8%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 4px 4px 16px 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            letter-spacing: 0.2px;
        }

        .subtle {
            color: var(--muted);
            font-size: 13px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 760px) {
            .grid {
                grid-template-columns: 1.2fr 1fr;
            }
        }

        .panel {
            background: color-mix(in oklab, var(--panel) 94%, black 6%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .row-1 { display: grid; grid-template-columns: 1fr; gap: 12px; }

        label { font-size: 13px; color: var(--muted); }
        .control { display: grid; gap: 6px; }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 12px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--panel);
            color: var(--text);
            outline: none;
        }
        input::placeholder { color: #6b7280; }
        select { cursor: pointer; }

        .hint { font-size: 12px; color: var(--muted); }

        .results {
            display: grid;
            gap: 12px;
        }

        .result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--panel);
        }

        .result h3 { margin: 0; font-size: 14px; font-weight: 600; color: var(--muted); }
        .result .value { font-size: 28px; font-weight: 700; letter-spacing: 0.4px; }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 999px;
        }

        footer { margin-top: 8px; color: var(--muted); font-size: 12px; text-align: right; }
        .danger { color: var(--danger); }
        .ok { color: var(--accent-2); }
        .accent { color: var(--accent); }

        .stack { display: grid; gap: 10px; }
        .stack-lg { display: grid; gap: 16px; }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        #configList table {
            width: 100%;
            border-collapse: collapse;
        }

        #configList table tbody tr:hover {
            background: color-mix(in oklab, var(--panel) 95%, black 5%);
        }

        #configList table th,
        #configList table td {
            padding: 12px 8px;
        }

        #configList table th {
            font-size: 13px;
            color: var(--muted);
            font-weight: 500;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        #configList table th:last-child {
            text-align: center;
            width: 60px;
        }

        #configList table td {
            font-size: 13px;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }

        #configList table td:last-child {
            text-align: center;
        }

        .remove-config-btn:hover {
            background: color-mix(in oklab, var(--panel) 90%, black 10%) !important;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <h2>ThousandEyes</h2>
        <nav class="sidebar-nav">
            <button class="nav-btn active" data-page="endpoint">Endpoint Experience</button>
            <button class="nav-btn" data-page="synthetics">Cloud and App Synthetics</button>
            <button class="nav-btn" data-page="flowcalc">Cloud and Traffic Insight Flow Calculator</button>
        </nav>
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
            <label style="font-size: 12px; color: var(--muted); margin-bottom: 8px; display: block;">Currency</label>
            <select id="unifiedCurrency" style="width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel); color: var(--text); font-size: 13px; cursor: pointer;">
                <option value="USD">USD - US Dollar</option>
                <option value="EUR">EUR - Euro</option>
                <option value="JPY">JPY - Japanese Yen</option>
                <option value="AUD">AUD - Australian Dollar</option>
                <option value="MXN">MXN - Mexican Peso</option>
            </select>
            <button id="unifiedFetchRates" type="button" style="margin-top: 8px; width: 100%; padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: var(--text); font-size: 11px; cursor: pointer;">Update Rates</button>
        </div>
    </aside>
    <div class="main-content">
        <div id="page-endpoint" class="page-content">
            <main class="container" role="main">
        <header>
            <div>
                <h1>ThousandEyes Endpoint Agents Budget Calculator and Operational Enablement</h1>
                <div class="subtle">Enter your budget and per‚Äëagent costs to estimate how many Endpoint Agents you can purchase for Advantage and Essentials.</div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="tag" aria-live="polite" id="currencyTag">Currency: <strong class="accent" id="currencyTagValue">USD</strong></div>
                <button id="themeToggle" type="button" style="padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;" title="Toggle light/dark mode">üåô</button>
            </div>
        </header>

        <nav style="display:flex; gap:8px; margin:8px 0 16px 0;">
            <button class="tab-btn" data-tab="calc" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text);">EPA Calculator</button>
            <button class="tab-btn" data-tab="flows" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted);">EPA Licensing</button>
            <button class="tab-btn" data-tab="scheduler" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted);">EPA Scheduler</button>
        </nav>

        <section id="tab-calc" class="grid" aria-label="Calculator">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="budget">Total budget</label>
                        <input id="budget" name="budget" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 25000" aria-describedby="budgetHint">
                        <div class="hint" id="budgetHint">Total amount available to spend (same billing term as prices).</div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="priceAdv">Advantage price per agent (flat)</label>
                        <input id="priceAdv" name="priceAdv" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 50">
                        <div class="hint">Used only if tiers are empty. Otherwise the tiered scale applies.</div>
                    </div>
                    <div class="control">
                        <label for="priceEss">Essentials price per agent (flat)</label>
                        <input id="priceEss" name="priceEss" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 35">
                        <div class="hint">Used only if tiers are empty. Otherwise the tiered scale applies.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="panel">
                        <div class="stack">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <label>Advantage tiers</label>
                                <div style="display:flex; gap:8px;">
                                    <button id="resetTierAdv" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:12px;" title="Reset to default tiers">Reset to Default</button>
                                    <button id="addTierAdv" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text);">Add tier</button>
                                </div>
                            </div>
                            <div class="hint">Threshold-based pricing: "Up to" defines the maximum quantity for that tier. If you cross a threshold, ALL agents are priced at that tier's rate. Leave last "Up to" empty for no cap.</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:8px; padding:8px; background:var(--bg); border-radius:6px; margin-bottom:8px; font-size:12px; font-weight:600; color:var(--muted);">
                                <div>Up to (qty)</div>
                                <div id="tier-price-header-adv">Price per agent</div>
                                <div></div>
                            </div>
                            <div id="tiers-adv" class="stack"></div>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="panel">
                        <div class="stack">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <label>Essentials tiers</label>
                                <div style="display:flex; gap:8px;">
                                    <button id="resetTierEss" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:12px;" title="Reset to default tiers">Reset to Default</button>
                                    <button id="addTierEss" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text);">Add tier</button>
                                </div>
                            </div>
                            <div class="hint">Threshold-based pricing: "Up to" defines the maximum quantity for that tier. If you cross a threshold, ALL agents are priced at that tier's rate. Leave last "Up to" empty for no cap.</div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:8px; padding:8px; background:var(--bg); border-radius:6px; margin-bottom:8px; font-size:12px; font-weight:600; color:var(--muted);">
                                <div>Up to (qty)</div>
                                <div id="tier-price-header-ess">Price per agent</div>
                                <div></div>
                            </div>
                            <div id="tiers-ess" class="stack"></div>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="rounding">Rounding</label>
                        <input id="rounding" name="rounding" type="text" value="down" aria-describedby="roundHint">
                        <div class="hint" id="roundHint">"down" to floor to whole agents, "nearest" to round to nearest.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="showAvg">Display options</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="showAvg" name="showAvg" type="checkbox">
                            <span class="hint">Show effective average price at computed quantity</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result" id="res-adv">
                    <h3>Advantage agents</h3>
                    <div class="value" id="advCount">‚Äì</div>
                </div>
                <div class="result" id="res-ess">
                    <h3>Essentials agents</h3>
                    <div class="value" id="essCount">‚Äì</div>
                </div>
                <div class="result" id="res-leftover-adv">
                    <h3>Unspent budget (Advantage)</h3>
                    <div class="value" id="leftoverAdv">‚Äì</div>
                </div>
                <div class="result" id="res-leftover-ess">
                    <h3>Unspent budget (Essentials)</h3>
                    <div class="value" id="leftoverEss">‚Äì</div>
                </div>
                <div class="result" id="res-avg-adv" style="display:none;">
                    <h3>Effective average price (Advantage)</h3>
                    <div class="value" id="avgPriceAdv">‚Äì</div>
                </div>
                <div class="result" id="res-avg-ess" style="display:none;">
                    <h3>Effective average price (Essentials)</h3>
                    <div class="value" id="avgPriceEss">‚Äì</div>
                </div>
                <div class="result" id="res-rates" style="display:none;">
                    <h3>Exchange rates (vs USD)</h3>
                    <div class="value" id="ratesDisplay" style="font-size:14px; line-height:1.6;">‚Äì</div>
                </div>
            </div>

            <div class="panel" id="multiCurrencyPanel" style="display:none;">
                <div class="stack">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                        <label>Multi-currency view</label>
                        <input id="showMultiCurrency" name="showMultiCurrency" type="checkbox">
                    </div>
                    <div class="hint">Display all values converted to all supported currencies using real-time exchange rates.</div>
                    <div id="multiCurrencyDisplay" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-top:8px;"></div>
                </div>
            </div>
        </section>

        <section id="tab-flows" class="stack-lg" aria-label="EPA Licensing" style="display:none;">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="apiToken">API Key</label>
                        <input id="apiToken" name="apiToken" type="text" placeholder="TE Bearer token">
                        <div class="hint">Stored only in your browser. Do not share. Enter token and click "Load Account Groups" to populate dropdowns.</div>
                        <button id="loadAccountGroups" type="button" style="margin-top: 8px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--panel); color: var(--text); cursor: pointer; font-size: 13px;">Load Account Groups</button>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="accountGroupId">Account Group</label>
                        <select id="accountGroupId" name="accountGroupId" style="width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); outline: none;">
                            <option value="">-- Select Account Group --</option>
                        </select>
                        <div class="hint">Select an account group to load available labels. Labels will update automatically.</div>
                    </div>
                    <div class="control">
                        <label for="agentTags">Labels</label>
                        <select id="agentTags" name="agentTags" multiple size="5" style="width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); outline: none;">
                            <option value="">-- Select Account Group first --</option>
                        </select>
                        <div class="hint">Hold Ctrl/Cmd to select multiple labels. Leave empty to include all agents.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="dryRun">Dry run mode</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="dryRun" name="dryRun" type="checkbox">
                            <span class="hint">Skip live API calls and just log what would happen.</span>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <button id="refreshCounts" type="button" style="padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); width:100%;">Refresh license counts</button>
                        <div class="hint">Runs the ThousandEyes agent list endpoint (filtered by labels) and summarizes Advantage vs Essentials counts.</div>
                    </div>
                </div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result">
                    <h3>Advantage agents (current)</h3>
                    <div class="value" id="currentAdvCount">‚Äì</div>
                </div>
                <div class="result">
                    <h3>Essentials agents (current)</h3>
                    <div class="value" id="currentEssCount">‚Äì</div>
                </div>
                <div class="result">
                    <h3>Last refresh status</h3>
                    <div class="value" id="lastCountStatus">‚Äì</div>
                </div>
            </div>
        </section>

        <section id="tab-scheduler" class="stack-lg" aria-label="EPA Scheduler" style="display:none;">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="schedulerEnabled">Scheduler</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="schedulerEnabled" name="schedulerEnabled" type="checkbox">
                            <span class="hint">Enable automatic EPA endpoint toggling while this page is open. Uses API base/token + dry run toggle from EPA Licensing.</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="control">
                        <label for="schedulerFrequency">Check frequency (seconds)</label>
                        <input id="schedulerFrequency" name="schedulerFrequency" type="number" min="15" step="15" value="60">
                        <div class="hint">How often to evaluate schedules. Minimum 15s.</div>
                    </div>
                </div>
            </div>

            <div class="panel stack-lg">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <label>EPA schedules</label>
                    <button id="addSchedulerEntry" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text);">Add schedule</button>
                </div>
                <div class="hint">Each row controls endpoints matching a label for the specified time window. Leave ‚Äúto‚Äù earlier than ‚Äúfrom‚Äù to span midnight.</div>
                <div id="schedulerList" class="stack"></div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result">
                    <h3>Active instructions right now</h3>
                    <div class="value" id="schedulerSnapshot">‚Äì</div>
                </div>
                <div class="result">
                    <h3>Scheduler log</h3>
                    <textarea id="schedulerLog" class="value" rows="10" style="width: 100%; font-family: monospace; resize: vertical;" readonly></textarea>
                </div>
            </div>
        </section>

        <footer>
            Sample calculator. Enter your actual ThousandEyes pricing for accurate results.
        </footer>
            </main>
        </div>

        <div id="page-synthetics" class="page-content" style="display:none;">
            <main class="container" role="main">
                <header>
                    <div>
                        <h1>Cloud and App Synthetics Units Calculator</h1>
                        <div class="subtle">Calculate units based on agent type, test interval, and test type.</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="tag" aria-live="polite" id="syntheticsCurrencyTag">Currency: <strong class="accent" id="syntheticsCurrencyTagValue">USD</strong></div>
                        <button id="syntheticsThemeToggle" type="button" style="padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;" title="Toggle light/dark mode">üåô</button>
                    </div>
                </header>

                <section class="grid" aria-label="Synthetics Calculator">
                    <div class="panel stack-lg">
                        <div class="row">
                            <div class="control">
                                <label for="agentType">Agent Type</label>
                                <select id="agentType" name="agentType">
                                    <option value="enterprise">Enterprise</option>
                                    <option value="cloud">Cloud</option>
                                </select>
                                <div class="hint">Cloud agents use 2x the unit calculation.</div>
                            </div>
                            <div class="control">
                                <label for="testInterval">Test Interval (minutes)</label>
                                <select id="testInterval" name="testInterval">
                                    <option value="1">1 minute</option>
                                    <option value="2">2 minutes</option>
                                    <option value="5">5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="15">15 minutes</option>
                                </select>
                            </div>
                        </div>

                        <div class="row-1">
                            <div class="control">
                                <label for="testType">Test Type</label>
                                <select id="testType" name="testType">
                                    <option value="bgp">BGP Routing</option>
                                    <option value="network-agent-server">Network, Agent to Server</option>
                                    <option value="network-agent-agent">Network, Agent to Agent</option>
                                    <option value="dns-server">DNS Server</option>
                                    <option value="dns-trace">DNS Trace, DNSSEC</option>
                                    <option value="http-server">HTTP Server</option>
                                    <option value="page-load">Page Load</option>
                                    <option value="transaction">Transaction</option>
                                    <option value="sip-rtp">SIP Server, RTP Stream</option>
                                    <option value="voice-calls">Voice Calls</option>
                                </select>
                            </div>
                        </div>

                        <div id="testTypeParams" class="stack-lg"></div>
                    </div>

                    <div class="panel results" aria-live="polite">
                        <div class="result">
                            <h3>Units (C)</h3>
                            <div class="value" id="unitsResult">‚Äì</div>
                        </div>
                        <div class="result">
                            <h3>Monthly Units</h3>
                            <div class="value" id="monthlyUnitsResult">‚Äì</div>
                        </div>
                    </div>
                </section>

                <div class="panel" style="margin-top:16px;">
                    <div class="stack">
                        <label>Calculation Breakdown</label>
                        <div id="calculationDisplay" style="font-family:monospace; font-size:13px; line-height:1.8; color:var(--muted); padding:12px; background:color-mix(in oklab, var(--panel) 90%, black 10%); border-radius:8px; border:1px solid var(--border);">
                            Select test type and enter parameters to see calculation
                        </div>
                        <button id="addToConfigList" type="button" style="margin-top:12px; padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--accent); color:white; cursor:pointer; font-size:14px; font-weight:500;">
                            Add to Configuration List
                        </button>
                    </div>
                </div>

                <div class="panel" style="margin-top:16px;">
                    <div class="stack-lg">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                            <label style="margin:0;">Test Configurations</label>
                            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <label for="contractDuration" style="font-size:13px; color:var(--muted);">Contract:</label>
                                    <select id="contractDuration" style="padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:13px; cursor:pointer;">
                                        <option value="12">1 Year</option>
                                        <option value="36">3 Years</option>
                                        <option value="60">5 Years</option>
                                    </select>
                                </div>
                                <div style="font-size:14px; color:var(--muted);">
                                    Total Units (√ó1000): <strong class="accent" id="totalUnitsDisplay">0</strong>
                                </div>
                                <div style="font-size:14px; color:var(--muted);">
                                    <span id="totalCostLabel">Total Cost (1 Year):</span> <strong class="accent" id="totalCostDisplay">$0.00</strong>
                                </div>
                                <button id="clearConfigList" type="button" style="padding:6px 12px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        <div id="configList" style="min-height:100px;">
                            <div style="text-align:center; padding:40px; color:var(--muted); font-size:14px;">
                                No configurations added yet. Configure a test above and click "Add to Configuration List".
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border); display: flex; justify-content: flex-end;">
                            <button id="createCCWEstimate" type="button" style="padding: 12px 24px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                                <span>üìã</span> Create CCW Estimate
                            </button>
                        </div>
                    </div>
                </div>

                <footer>
                    Units calculator for Cloud and App Synthetics tests.
                </footer>
            </main>
        </div>

        <div id="page-flowcalc" class="page-content" style="display:none;">
            <main class="container" role="main">
                <header>
                    <div>
                        <h1>Cloud and Traffic Insight Flow Calculator</h1>
                        <div class="subtle">Calculate flow units and estimate AWS costs for ThousandEyes Cloud Insights Flow Logs integration.</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="tag" aria-live="polite" id="flowcalcCurrencyTag">Currency: <strong class="accent" id="flowcalcCurrencyTagValue">USD</strong></div>
                        <button id="flowcalcThemeToggle" type="button" style="padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;" title="Toggle light/dark mode">üåô</button>
                    </div>
                </header>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <!-- Flow Estimator -->
                    <div class="panel stack-lg">
                        <h2>ThousandEyes Flow Cost Estimator</h2>
                        
                        <!-- Daily Flow Estimate Section -->
                        <div class="stack-md" style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 2px solid var(--border);">
                            <h3 style="margin-bottom: 12px; font-size: 1.1em; color: var(--accent);">Daily Flow Estimate</h3>
                            <div class="control">
                                <label for="dailyFlows">Daily Flows</label>
                                <input id="dailyFlows" type="number" min="0" value="0" step="1">
                                <div class="hint">Total number of flows per day</div>
                            </div>
                            <div class="control">
                                <label for="flowUnitCost">Unit Cost (USD/unit/month)</label>
                                <input id="flowUnitCost" type="number" min="0" value="0.85" step="0.01">
                                <div class="hint">Base cost per unit per month in USD (converted to selected currency for display)</div>
                            </div>
                        </div>

                        <!-- Cloud Size Estimate Section -->
                        <div class="stack-md">
                            <h3 style="margin-bottom: 12px; font-size: 1.1em; color: var(--accent);">Cloud Size Estimate</h3>
                            <div class="control">
                                <label for="flowVpcCount">Number of VPCs</label>
                                <input id="flowVpcCount" type="number" min="1" value="10" step="1">
                                <div class="hint">Total number of VPCs with flow logs enabled</div>
                            </div>
                            <div class="control">
                                <label for="flowTrafficGB">Monthly Traffic Volume (GB)</label>
                                <input id="flowTrafficGB" type="number" min="0" value="100" step="1">
                                <div class="hint">Total network traffic volume per month in GB</div>
                            </div>
                            <div class="control">
                                <label for="flowLogRetention">Log Retention (months)</label>
                                <input id="flowLogRetention" type="number" min="1" value="3" step="1">
                                <div class="hint">How long to retain flow logs in S3</div>
                            </div>
                        </div>
                        <div class="result">
                            <h3>Flow Calculations</h3>
                            <div class="stack-sm" style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>Calculation Method:</span>
                                    <strong id="flowMethodResult" style="color: var(--accent);">‚Äì</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>Flows Per Second (FPS):</span>
                                    <strong id="flowFPSResult">‚Äì</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>Estimated Flow Units:</span>
                                    <strong id="flowUnitsResult">‚Äì</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>Monthly Unit Cost:</span>
                                    <strong id="flowMonthlyCostResult">‚Äì</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px; border-top: 2px solid var(--accent);">
                                    <span style="font-weight: 600;">Yearly Unit Cost:</span>
                                    <strong class="accent" id="flowYearlyCostResult" style="font-size: 1.2em;">‚Äì</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AWS Cost Calculator -->
                    <div class="panel stack-lg">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2>AWS Cost Calculator <span style="color: var(--accent); font-size: 0.8em; font-weight: normal;">(ESTIMATE)</span></h2>
                            <button id="viewIntegrationGuide" type="button" style="padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel); color: var(--text); cursor: pointer; font-size: 14px;" title="View Integration Guide">
                                üìñ View Integration Guide
                            </button>
                        </div>
                        <div class="stack-md">
                            <div class="control">
                                <label for="awsFlowLogGB">Flow Log Data Captured (GB/month)</label>
                                <input id="awsFlowLogGB" type="number" min="0" value="100" step="1">
                                <div class="hint">Volume of flow log data captured per month</div>
                            </div>
                            <div class="control">
                                <label for="awsS3StorageGB">S3 Storage (GB)</label>
                                <input id="awsS3StorageGB" type="number" min="0" value="500" step="1">
                                <div class="hint">Total storage in S3 bucket (including retention)</div>
                            </div>
                            <div class="control">
                                <label for="awsPutRequests">S3 PUT Requests (per 1,000)</label>
                                <input id="awsPutRequests" type="number" min="0" value="10" step="1">
                                <div class="hint">Number of PUT requests in thousands</div>
                            </div>
                            <div class="control">
                                <label for="awsSNSRequests">SNS Requests (per million)</label>
                                <input id="awsSNSRequests" type="number" min="0" value="1" step="0.1">
                                <div class="hint">Number of SNS notifications in millions</div>
                            </div>
                            <div class="control">
                                <label for="awsDataTransferGB">Data Transfer Out (GB)</label>
                                <input id="awsDataTransferGB" type="number" min="0" value="50" step="1">
                                <div class="hint">Data transfer from S3 to ThousandEyes (outbound)</div>
                            </div>
                        </div>
                        <div class="result">
                            <h3>Monthly AWS Costs</h3>
                            <div class="stack-sm" style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>VPC Flow Logs Capture:</span>
                                    <strong id="awsFlowLogCost">$0.00</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>S3 Storage:</span>
                                    <strong id="awsS3StorageCost">$0.00</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>S3 PUT Requests:</span>
                                    <strong id="awsPutCost">$0.00</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>SNS Notifications:</span>
                                    <strong id="awsSNSCost">$0.00</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                    <span>Data Transfer:</span>
                                    <strong id="awsTransferCost">$0.00</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px 0; margin-top: 8px; border-top: 2px solid var(--accent);">
                                    <span style="font-weight: 600;">Total Monthly Cost <span style="color: var(--accent); font-size: 0.9em; font-weight: normal;">(ESTIMATE)</span>:</span>
                                    <strong class="accent" id="awsTotalCost" style="font-size: 1.2em;">$0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 24px;">
                    <h3>AWS Cost Breakdown</h3>
                    <div class="stack-sm" style="margin-top: 12px;">
                        <div class="hint">
                            <strong>VPC Flow Logs Capture:</strong> $0.50 per GB of flow log data captured
                        </div>
                        <div class="hint">
                            <strong>S3 Storage:</strong> ~$0.023 per GB/month (Standard storage, first 50 TB)
                        </div>
                        <div class="hint">
                            <strong>S3 PUT Requests:</strong> $0.005 per 1,000 requests
                        </div>
                        <div class="hint">
                            <strong>SNS Notifications:</strong> $0.50 per 1 million requests
                        </div>
                        <div class="hint">
                            <strong>Data Transfer:</strong> $0.09 per GB (first 10 TB/month, S3 to Internet)
                        </div>
                        <div class="hint" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <strong>Note:</strong> These are estimated costs based on standard AWS pricing. Actual costs may vary based on your AWS region, usage patterns, and any applicable discounts. Use the <a href="https://calculator.aws/#/" target="_blank" style="color: var(--accent);">AWS Pricing Calculator</a> for more accurate estimates.
                        </div>
                    </div>
                </div>

                <footer>
                    Flow calculator for ThousandEyes Cloud Insights. AWS costs are estimates based on standard pricing.
                </footer>
            </main>
        </div>

        <!-- Integration Guide Modal -->
        <div id="integrationGuideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; overflow-y: auto;">
            <div style="max-width: 900px; margin: 40px auto; background: var(--panel); border-radius: 12px; padding: 32px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative;">
                <button id="closeIntegrationGuide" type="button" style="position: absolute; top: 16px; right: 16px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; font-size: 18px;" title="Close">√ó</button>
                <div style="max-height: 80vh; overflow-y: auto; padding-right: 16px;">
                    <h1 style="margin-bottom: 24px; color: var(--accent);">ThousandEyes Cloud Insights AWS Integration Script Guide</h1>
                    
                    <div class="stack-lg">
                        <section>
                            <h2>1. Introduction and Purpose</h2>
                            <p>The <code>ThousandEyes_Cloud_Insights.sh</code> script is a <strong>Bash utility</strong> designed to simplify and accelerate the deployment and maintenance of the necessary AWS Identity and Access Management (IAM) resources required for <strong>ThousandEyes Cloud Insights</strong> integrations (specifically for Inventory and FlowLogs).</p>
                            
                            <h3>Key Features</h3>
                            <ul>
                                <li><strong>Multi-Account Support</strong>: The script allows the operator to select one or more configured AWS CLI profiles (representing different AWS accounts) to execute creation or update tasks simultaneously.</li>
                                <li><strong>Automated Policy Management</strong>: It hardcodes the latest required Trust and Permissions policies, ensuring consistency and compliance with ThousandEyes requirements.</li>
                                <li><strong>Comprehensive Remediation</strong>: It includes functions to search and automatically update policies based on fixed naming conventions (InventoryUpdate) or based on specific policy content (InventoryUpdateCustom).</li>
                            </ul>
                        </section>

                        <section>
                            <h2>2. Business Case and Impact</h2>
                            <h3>Value Proposition: Speed, Compliance, and Resolution</h3>
                            <p>The ThousandEyes_Cloud_Insights.sh script is not just a utility; it is a critical tool designed to accelerate time-to-value and ensure compliance for the ThousandEyes Cloud Insights integration.</p>
                            
                            <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
                                <thead>
                                    <tr style="background: var(--bg); border-bottom: 2px solid var(--border);">
                                        <th style="padding: 12px; text-align: left;">Category</th>
                                        <th style="padding: 12px; text-align: left;">Impact Statement</th>
                                        <th style="padding: 12px; text-align: left;">Benefit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><strong>Operational Speed</strong></td>
                                        <td style="padding: 12px;">Reduces deployment time from hours to minutes across single or multiple AWS accounts.</td>
                                        <td style="padding: 12px;">Customers can start collecting and visualizing cloud network data faster, significantly accelerating their Time-to-Value (TTV).</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><strong>Compliance & Quality</strong></td>
                                        <td style="padding: 12px;">Guarantees all AWS security and format requirements are met by hardcoding the latest IAM policies and the mandatory VPC Flow Log fields.</td>
                                        <td style="padding: 12px;">Eliminates integration failure due to misconfiguration. The reliable, correct setup directly reduces the Mean Time To Resolution (MTTR).</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px;"><strong>Adoption & Business Case</strong></td>
                                        <td style="padding: 12px;">Removes the primary technical barrier to adoption for ThousandEyes Cloud Insights.</td>
                                        <td style="padding: 12px;">By making deployment simple and reliable, it encourages greater feature usage across the customer base.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <section>
                            <h2>3. Prerequisites and Requirements</h2>
                            <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
                                <thead>
                                    <tr style="background: var(--bg); border-bottom: 2px solid var(--border);">
                                        <th style="padding: 12px; text-align: left;">Requirement</th>
                                        <th style="padding: 12px; text-align: left;">Description</th>
                                        <th style="padding: 12px; text-align: left;">Installation Check</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><strong>Bash Shell</strong></td>
                                        <td style="padding: 12px;">Standard on macOS and most Linux distributions.</td>
                                        <td style="padding: 12px;"><code>bash --version</code></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><strong>AWS CLI</strong></td>
                                        <td style="padding: 12px;">The AWS Command Line Interface must be installed and configured.</td>
                                        <td style="padding: 12px;"><code>aws --version</code></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><strong>AWS Profiles</strong></td>
                                        <td style="padding: 12px;">The AWS CLI configuration file (~/.aws/config or ~/.aws/credentials) must contain the profiles (accounts) you intend to target.</td>
                                        <td style="padding: 12px;"><code>aws configure list-profiles</code></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px;"><strong>jq Utility</strong></td>
                                        <td style="padding: 12px;">A lightweight and flexible command-line JSON processor, essential for parsing policy documents during updates.</td>
                                        <td style="padding: 12px;"><code>jq --version</code></td>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <section>
                            <h2>4. Script Execution and Usage</h2>
                            <p>The script is executed using the following syntax:</p>
                            <pre style="background: var(--bg); padding: 16px; border-radius: 6px; overflow-x: auto; margin: 16px 0;"><code>./ThousandEyes_Cloud_Insights.sh &lt;mode&gt;</code></pre>
                            
                            <h3>Modes of Operation</h3>
                            <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
                                <thead>
                                    <tr style="background: var(--bg); border-bottom: 2px solid var(--border);">
                                        <th style="padding: 12px; text-align: left;">Mode Argument</th>
                                        <th style="padding: 12px; text-align: left;">Intended Action</th>
                                        <th style="padding: 12px; text-align: left;">Target Resources</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><code>Inventory</code></td>
                                        <td style="padding: 12px;">Creation Mode: Creates a new IAM Role and an associated Inline Permissions Policy for the Cloud Insights Inventory integration.</td>
                                        <td style="padding: 12px;">New IAM Role: <code>Role_TE_Inventory_*</code></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><code>FlowLogs</code></td>
                                        <td style="padding: 12px;">Creation Mode: Creates the complete infrastructure for Flow Logs delivery and notification.</td>
                                        <td style="padding: 12px;">New IAM Role: <code>Role_TE_FlowLogs_*</code></td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;"><code>InventoryUpdate</code></td>
                                        <td style="padding: 12px;">Update Mode (Legacy/Simple): Finds and updates Inventory roles based only on the naming convention established during creation.</td>
                                        <td style="padding: 12px;">Inline Policies attached to roles matching the <code>Role_TE_Inventory_*</code> pattern.</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px;"><code>InventoryUpdateCustom</code></td>
                                        <td style="padding: 12px;">Remediation/Custom Update Mode: Scans all roles to verify both the ThousandEyes Trust ARN and the presence of a specific permissions policy Sid.</td>
                                        <td style="padding: 12px;">Both Inline and Attached Managed Policies that match the specified criteria.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </section>

                        <section>
                            <h2>5. FlowLogs (Creation) Details</h2>
                            <p>This mode automates the entire FlowLogs data pipeline, which is necessary for ThousandEyes to reliably ingest network data.</p>
                            
                            <p>The script performs the following sequence of steps for each selected AWS profile:</p>
                            <ol style="padding-left: 24px;">
                                <li><strong>Create IAM Role</strong> (<code>Role_TE_FlowLogs_*</code>) - Provides a secured identity for ThousandEyes to assume and read data.</li>
                                <li><strong>Create S3 Bucket</strong> (<code>s3-te-*</code>) - Creates the storage location for all VPC Flow Logs.</li>
                                <li><strong>Create SNS Topic</strong> (<code>Topic_TE_FlowLogs_*</code>) - Creates the notification channel for log delivery alerts.</li>
                                <li><strong>Configure SNS Policy</strong> - Allows the new S3 bucket to Publish messages and allows the ThousandEyes IAM principal to Subscribe to messages.</li>
                                <li><strong>Configure S3 Notification</strong> - Instructs the S3 bucket to send a notification to the SNS Topic every time a new log file is created.</li>
                                <li><strong>Attach Permissions</strong> (<code>Policy_TE_FlowLogs_*</code>) - Creates and attaches a Managed IAM policy to the role, granting read-only access to the S3 bucket.</li>
                                <li><strong>Create VPC Flow Logs</strong> - Enables Flow Logging on all existing VPCs in the region, pointing them to the new S3 bucket.</li>
                            </ol>
                        </section>

                        <section>
                            <h2>6. AWS Cost Considerations</h2>
                            <p>In addition to ThousandEyes subscription costs, integrating with AWS may incur charges for:</p>
                            <ul>
                                <li><strong>S3 Storage</strong>: Costs associated with storing flow logs in S3 buckets (~$0.023 per GB/month)</li>
                                <li><strong>SNS Notifications</strong>: Charges for sending notifications via SNS ($0.50 per 1 million requests)</li>
                                <li><strong>VPC Flow Logs Capture</strong>: $0.50 per GB of flow log data captured</li>
                                <li><strong>Data Transfer</strong>: Fees for data transfer between AWS services ($0.09 per GB for first 10 TB/month)</li>
                            </ul>
                            <p style="margin-top: 16px;"><strong>Note:</strong> For a comprehensive understanding of AWS costs, consult the <a href="https://calculator.aws/#/" target="_blank" style="color: var(--accent);">AWS Pricing Calculator</a>.</p>
                        </section>

                        <section>
                            <h2>7. Support</h2>
                            <p>ThousandEyes CE Support Team - <a href="mailto:support@thousandeyes.com" style="color: var(--accent);">support@thousandeyes.com</a></p>
                            <p style="margin-top: 16px; font-size: 0.9em; color: var(--muted);"><em>This document is available under preview and subject to change.</em></p>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Label Management Modal -->
    <div id="labelManagementModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10001; overflow-y: auto;">
        <div style="max-width: 700px; margin: 40px auto; background: var(--panel); border-radius: 12px; padding: 32px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); position: relative;">
            <button id="closeLabelModal" type="button" style="position: absolute; top: 16px; right: 16px; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; font-size: 18px;" title="Close">√ó</button>
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <span style="font-size: 24px;">üè∑Ô∏è</span>
                <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: var(--text);">Label Management</h2>
            </div>
            <p style="margin: 0 0 24px 36px; color: var(--muted); font-size: 14px;">Create, update and manage scheduled labels.</p>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border);">
                <button id="tabCreateLabel" class="label-modal-tab" style="padding: 12px 20px; border: none; border-bottom: 2px solid var(--accent); background: var(--panel); color: var(--text); cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 0;">Create Label</button>
                <button id="tabUpdateLabel" class="label-modal-tab" style="padding: 12px 20px; border: none; border-bottom: 2px solid transparent; background: transparent; color: var(--muted); cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 0;">Update Label</button>
            </div>
            
            <!-- Create Label Content -->
            <div id="createLabelContent" class="label-modal-content">
                <!-- Authentication Section -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="font-size: 18px;">üõ°Ô∏è</span>
                        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text);">Authentication</h3>
                    </div>
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text);">Account ID <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="modalAccountId" placeholder="Enter your account ID" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text);">Token <span style="color: var(--danger);">*</span></label>
                            <input type="password" id="modalToken" placeholder="Enter your authentication token" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none;">
                        </div>
                    </div>
                </div>
                
                <!-- Creation Mode Section -->
                <div style="margin-bottom: 24px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: var(--text);">Creation Mode</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="creationMode" value="single" checked style="cursor: pointer;">
                            <span style="color: var(--text); font-size: 14px;">Create single label</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="creationMode" value="multiple" style="cursor: pointer;">
                            <span style="color: var(--text); font-size: 14px;">Create multiple labels</span>
                        </label>
                    </div>
                </div>
                
                <!-- Labels Schedule Section -->
                <div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="font-size: 18px;">üìÖ</span>
                        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text);">Labels Schedule</h3>
                    </div>
                    <div id="labelScheduleContainer">
                        <!-- Label entries will be dynamically added here -->
                    </div>
                    <button type="button" id="addAnotherLabel" style="margin-top: 16px; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; font-size: 14px; display: none;">
                        <span style="margin-right: 6px;">+</span> Add Another Label
                    </button>
                </div>
                
                <div style="margin-top: 32px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" id="cancelCreateLabel" style="padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 14px;">Cancel</button>
                    <button type="button" id="submitCreateLabel" style="padding: 12px 24px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-size: 14px; font-weight: 500;">Create Label</button>
                </div>
            </div>
            
            <!-- Update Label Content -->
            <div id="updateLabelContent" class="label-modal-content" style="display: none;">
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="font-size: 18px;">üîç</span>
                        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text);">Retrieve Label</h3>
                    </div>
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text);">Account ID <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="updateAccountId" placeholder="Enter account ID" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text);">Transaction ID <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="updateTransactionId" placeholder="Enter transaction ID" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none;">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 32px; display: flex; justify-content: flex-end;">
                    <button type="button" id="retrieveLabel" style="padding: 12px 24px; border-radius: 8px; border: none; background: var(--accent); color: white; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <span>üîç</span> Retrieve Label
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // Page navigation
            const navButtons = document.querySelectorAll('.nav-btn');
            const pageEndpoint = document.getElementById('page-endpoint');
            const pageSynthetics = document.getElementById('page-synthetics');
            const pageFlowcalc = document.getElementById('page-flowcalc');
            let activePage = 'endpoint';

            function setPage(page) {
                activePage = page;
                pageEndpoint.style.display = page === 'endpoint' ? '' : 'none';
                pageSynthetics.style.display = page === 'synthetics' ? '' : 'none';
                pageFlowcalc.style.display = page === 'flowcalc' ? '' : 'none';
                navButtons.forEach(btn => {
                    const isActive = btn.dataset.page === page;
                    btn.classList.toggle('active', isActive);
                });
                try {
                    const state = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    state.activePage = activePage;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(state));
                } catch {}
            }

            navButtons.forEach(btn => btn.addEventListener('click', () => setPage(btn.dataset.page)));

            // Load saved page
            try {
                const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                if (saved.activePage) setPage(saved.activePage);
            } catch {}

            // Tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabCalc = document.getElementById('tab-calc');
            const tabFlows = document.getElementById('tab-flows');
            const tabScheduler = document.getElementById('tab-scheduler');
            let activeTab = 'calc';
            function setTab(tab) {
                activeTab = tab;
                tabCalc.style.display = tab === 'calc' ? '' : 'none';
                tabFlows.style.display = tab === 'flows' ? '' : 'none';
                tabScheduler.style.display = tab === 'scheduler' ? '' : 'none';
                tabButtons.forEach(btn => {
                    const isActive = btn.dataset.tab === tab;
                    btn.style.background = isActive ? 'var(--panel)' : 'transparent';
                    btn.style.color = isActive ? 'var(--text)' : 'var(--muted)';
                });
                try {
                    const state = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    state.activeTab = activeTab;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(state));
                } catch {}
            }
            tabButtons.forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            const syntheticsThemeToggle = document.getElementById('syntheticsThemeToggle');
            const flowcalcThemeToggle = document.getElementById('flowcalcThemeToggle');
            const root = document.documentElement;
            const THEME_KEY = 'teTheme';
            
            function setTheme(theme) {
                root.setAttribute('data-theme', theme);
                const icon = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                const title = theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode';
                if (themeToggle) {
                    themeToggle.textContent = icon;
                    themeToggle.title = title;
                }
                if (syntheticsThemeToggle) {
                    syntheticsThemeToggle.textContent = icon;
                    syntheticsThemeToggle.title = title;
                }
                if (flowcalcThemeToggle) {
                    flowcalcThemeToggle.textContent = icon;
                    flowcalcThemeToggle.title = title;
                }
                try {
                    localStorage.setItem(THEME_KEY, theme);
                } catch {}
            }
            
            function initTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved === 'light' || saved === 'dark') {
                        setTheme(saved);
                    } else {
                        // Default to dark, or detect system preference
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        setTheme(prefersDark ? 'dark' : 'light');
                    }
                } catch {
                    setTheme('dark');
                }
            }
            
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const current = root.getAttribute('data-theme') || 'dark';
                    setTheme(current === 'light' ? 'dark' : 'light');
                });
            }
            
            if (syntheticsThemeToggle) {
                syntheticsThemeToggle.addEventListener('click', () => {
                    const current = root.getAttribute('data-theme') || 'dark';
                    setTheme(current === 'light' ? 'dark' : 'light');
                });
            }
            
            if (flowcalcThemeToggle) {
                flowcalcThemeToggle.addEventListener('click', () => {
                    const current = root.getAttribute('data-theme') || 'dark';
                    setTheme(current === 'light' ? 'dark' : 'light');
                });
            }
            
            initTheme();
            
            // Unified currency selector (used across all pages)
            const unifiedCurrencyEl = document.getElementById('unifiedCurrency');
            const unifiedFetchRatesBtn = document.getElementById('unifiedFetchRates');
            // For backward compatibility, alias currencyEl to unifiedCurrencyEl
            const currencyEl = unifiedCurrencyEl;
            const fetchRatesBtn = unifiedFetchRatesBtn;
            
            const budgetEl = document.getElementById('budget');
            const priceAdvEl = document.getElementById('priceAdv');
            const priceEssEl = document.getElementById('priceEss');
            const roundingEl = document.getElementById('rounding');
            const showAvgEl = document.getElementById('showAvg');
            const ratesDisplayEl = document.getElementById('ratesDisplay');
            const resRates = document.getElementById('res-rates');

            const advCountEl = document.getElementById('advCount');
            const essCountEl = document.getElementById('essCount');
            const leftoverAdvEl = document.getElementById('leftoverAdv');
            const leftoverEssEl = document.getElementById('leftoverEss');
            const currencyTagValue = document.getElementById('currencyTagValue');
            const avgPriceAdvEl = document.getElementById('avgPriceAdv');
            const avgPriceEssEl = document.getElementById('avgPriceEss');
            const resAvgAdv = document.getElementById('res-avg-adv');
            const resAvgEss = document.getElementById('res-avg-ess');
            const showMultiCurrencyEl = document.getElementById('showMultiCurrency');
            const multiCurrencyPanel = document.getElementById('multiCurrencyPanel');
            const multiCurrencyDisplay = document.getElementById('multiCurrencyDisplay');

            const tiersAdvContainer = document.getElementById('tiers-adv');
            const tiersEssContainer = document.getElementById('tiers-ess');
            const addTierAdvBtn = document.getElementById('addTierAdv');
            const addTierEssBtn = document.getElementById('addTierEss');
            const resetTierAdvBtn = document.getElementById('resetTierAdv');
            const resetTierEssBtn = document.getElementById('resetTierEss');
            
            // Verify containers exist
            if (!tiersAdvContainer || !tiersEssContainer) {
                console.error('Tier containers not found!', { tiersAdvContainer, tiersEssContainer });
            }
            
            // Store USD base values for tier prices (will be initialized after defaults is defined)
            let tiersAdvUSD;
            let tiersEssUSD;

            // Workflows elements
            // API base URL - use local proxy server if available, otherwise direct API (may have CORS issues)
            // To use Python proxy: 1) Install: pip install flask flask-cors requests
            //                       2) Run: python3 api_proxy.py
            //                       3) Set API_PROXY_BASE to 'http://localhost:5000/api'
            const API_PROXY_BASE = 'http://localhost:5000/api';  // Change this if proxy runs on different port
            const USE_PROXY = true;  // Set to false to use direct API (will likely fail due to CORS)
            const API_BASE = USE_PROXY ? API_PROXY_BASE : 'https://api.thousandeyes.com/v7';
            const AGENTS_ENDPOINT = '/endpoint/agents';
            const ENDPOINT_STATE_ENDPOINT = '/v6/endpoint-agents/state';
            
            const apiTokenEl = document.getElementById('apiToken');
            const accountGroupIdEl = document.getElementById('accountGroupId');
            const agentTagsEl = document.getElementById('agentTags');
            const dryRunEl = document.getElementById('dryRun');
            const refreshCountsBtn = document.getElementById('refreshCounts');
            const loadAccountGroupsBtn = document.getElementById('loadAccountGroups');
            const currentAdvCountEl = document.getElementById('currentAdvCount');
            const currentEssCountEl = document.getElementById('currentEssCount');
            const lastCountStatusEl = document.getElementById('lastCountStatus');
            // Scheduler elements
            const schedulerEnabledEl = document.getElementById('schedulerEnabled');
            const schedulerFrequencyEl = document.getElementById('schedulerFrequency');
            const schedulerListEl = document.getElementById('schedulerList');
            const addSchedulerEntryBtn = document.getElementById('addSchedulerEntry');
            const schedulerSnapshotEl = document.getElementById('schedulerSnapshot');
            const schedulerLogEl = document.getElementById('schedulerLog');

            // Defaults you can adjust
            const defaults = {
                budget: '',
                priceAdv: '',
                priceEss: '',
                currency: 'USD',
                rounding: 'down',
                showAvg: false,
                showMultiCurrency: false,
                tiersAdv: [
                    { upTo: 249, price: 14.60 },
                    { upTo: 499, price: 13.00 },
                    { upTo: 999, price: 11.75 },
                    { upTo: 2499, price: 8.75 },
                    { upTo: 4999, price: 7.50 },
                    { upTo: 9999, price: 6.40 },
                    { upTo: 24999, price: 5.30 },
                    { upTo: null, price: 4.20 }
                ],
                tiersEss: [
                    { upTo: 249, price: 6.00 },
                    { upTo: 499, price: 6.00 },
                    { upTo: 999, price: 4.79 },
                    { upTo: 2499, price: 3.18 },
                    { upTo: 4999, price: 3.01 },
                    { upTo: 9999, price: 2.50 },
                    { upTo: 24999, price: 2.38 },
                    { upTo: null, price: 1.95 }
                ],
                // workflows defaults
                activeTab: 'calc',
                apiToken: '',
                accountGroupId: '',
                agentTags: '',
                dryRun: true,
                schedulerEnabled: false,
                schedulerFrequency: 60,
                schedulerEntries: []
            };

            // Initialize USD base values for tier prices (default tiers are in USD)
            tiersAdvUSD = [...defaults.tiersAdv];
            tiersEssUSD = [...defaults.tiersEss];

            // Load saved values from localStorage
            try {
                const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                const blended = { ...defaults, ...saved };
                for (const [k, v] of Object.entries(blended)) {
                    const el = document.getElementById(k);
                    if (!el || typeof v === 'undefined' || v === null) continue;
                    if (el.type === 'checkbox') el.checked = Boolean(v); else el.value = v;
                }
                // render tiers from saved, but use defaults if tiers are missing or empty
                // Check if saved tiers exist and have valid data
                const hasValidAdvTiers = saved.tiersAdv && Array.isArray(saved.tiersAdv) && saved.tiersAdv.length > 0 && saved.tiersAdv.some(t => t.price != null && isFinite(t.price));
                const hasValidEssTiers = saved.tiersEss && Array.isArray(saved.tiersEss) && saved.tiersEss.length > 0 && saved.tiersEss.some(t => t.price != null && isFinite(t.price));
                
                const tiersAdv = hasValidAdvTiers ? saved.tiersAdv : defaults.tiersAdv;
                const tiersEss = hasValidEssTiers ? saved.tiersEss : defaults.tiersEss;
                
                // Initialize USD base values (assume saved tiers are in the saved currency, convert to USD if needed)
                const savedCurrency = (saved.currency || 'USD').toUpperCase();
                if (savedCurrency === 'USD') {
                    tiersAdvUSD = tiersAdv.map(t => ({ upTo: t.upTo, price: t.price }));
                    tiersEssUSD = tiersEss.map(t => ({ upTo: t.upTo, price: t.price }));
                } else {
                    // If saved currency is not USD, try to convert back to USD using cached rates
                    try {
                        const CACHE_KEY = `teExchangeRates_USD`;
                        const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                        if (cached.rates && cached.rates[savedCurrency]) {
                            const rate = cached.rates[savedCurrency];
                            tiersAdvUSD = tiersAdv.map(t => ({
                                upTo: t.upTo,
                                price: t.price != null && isFinite(t.price) ? t.price / rate : t.price
                            }));
                            tiersEssUSD = tiersEss.map(t => ({
                                upTo: t.upTo,
                                price: t.price != null && isFinite(t.price) ? t.price / rate : t.price
                            }));
                        } else {
                            // No cached rates, use defaults as USD base
                            tiersAdvUSD = [...defaults.tiersAdv];
                            tiersEssUSD = [...defaults.tiersEss];
                        }
                    } catch {
                        // Error, use defaults as USD base
                        tiersAdvUSD = [...defaults.tiersAdv];
                        tiersEssUSD = [...defaults.tiersEss];
                    }
                }
                
                // Ensure USD base values are never empty
                if (!tiersAdvUSD || tiersAdvUSD.length === 0) {
                    tiersAdvUSD = [...defaults.tiersAdv];
                }
                if (!tiersEssUSD || tiersEssUSD.length === 0) {
                    tiersEssUSD = [...defaults.tiersEss];
                }
                
                // Use saved tiers if valid, otherwise use USD defaults
                const tiersToRenderAdv = (tiersAdv && tiersAdv.length > 0 && tiersAdv.some(t => t.price != null && isFinite(t.price))) 
                    ? tiersAdv 
                    : (tiersAdvUSD && tiersAdvUSD.length > 0 ? tiersAdvUSD : defaults.tiersAdv);
                const tiersToRenderEss = (tiersEss && tiersEss.length > 0 && tiersEss.some(t => t.price != null && isFinite(t.price))) 
                    ? tiersEss 
                    : (tiersEssUSD && tiersEssUSD.length > 0 ? tiersEssUSD : defaults.tiersEss);
                
                renderTierEditor('adv', tiersToRenderAdv);
                renderTierEditor('ess', tiersToRenderEss);
                // set active tab
                setTab(blended.activeTab || 'calc');
                // seed API/config to inputs
                apiTokenEl.value = blended.apiToken || defaults.apiToken;
                accountGroupIdEl.value = blended.accountGroupId || defaults.accountGroupId;
                
                // Handle multi-select labels - restore selected values
                if (agentTagsEl.multiple && blended.agentTags) {
                    const selectedLabels = Array.isArray(blended.agentTags) 
                        ? blended.agentTags 
                        : blended.agentTags.split(',').map(s => s.trim()).filter(Boolean);
                    Array.from(agentTagsEl.options).forEach(option => {
                        option.selected = selectedLabels.includes(option.value);
                    });
                } else if (!agentTagsEl.multiple) {
                    agentTagsEl.value = blended.agentTags || defaults.agentTags;
                }
                
                dryRunEl.checked = blended.dryRun !== undefined ? !!blended.dryRun : defaults.dryRun;
                
                // Load labels if account group is selected
                if (accountGroupIdEl.value && apiTokenEl.value.trim()) {
                    setTimeout(() => loadLabels(), 100);
                }
                schedulerEnabledEl.checked = blended.schedulerEnabled || false;
                schedulerFrequencyEl.value = blended.schedulerFrequency || defaults.schedulerFrequency;
                renderSchedulerEntries(blended.schedulerEntries || defaults.schedulerEntries);
            } catch {
                // If loading fails, initialize with defaults
                tiersAdvUSD = [...defaults.tiersAdv];
                tiersEssUSD = [...defaults.tiersEss];
                renderTierEditor('adv', defaults.tiersAdv);
                renderTierEditor('ess', defaults.tiersEss);
            }

            // Ensure USD base values are initialized (use defaults if empty)
            if (!tiersAdvUSD || tiersAdvUSD.length === 0) {
                tiersAdvUSD = [...defaults.tiersAdv];
            }
            if (!tiersEssUSD || tiersEssUSD.length === 0) {
                tiersEssUSD = [...defaults.tiersEss];
            }

            // ALWAYS ensure tiers are rendered - force render defaults if containers are empty
            if (!tiersAdvContainer || !tiersAdvContainer.children.length) {
                console.log('Initializing Advantage tiers with defaults');
                renderTierEditor('adv', defaults.tiersAdv);
                tiersAdvUSD = [...defaults.tiersAdv];
            }
            if (!tiersEssContainer || !tiersEssContainer.children.length) {
                console.log('Initializing Essentials tiers with defaults');
                renderTierEditor('ess', defaults.tiersEss);
                tiersEssUSD = [...defaults.tiersEss];
            }

            // Initialize tier headers with current currency
            const initialCurrency = (currencyEl?.value || 'USD').toUpperCase();
            if (currencyEl) currencyEl.dataset.previousCurrency = initialCurrency;
            
            // On initial load, ensure tiers are rendered
            // If currency is USD, just update headers without conversion
            // Otherwise, convert from USD defaults to the selected currency
            if (initialCurrency === 'USD') {
                // Ensure tiers are rendered (they should be, but double-check)
                if (!tiersAdvContainer.children.length) {
                    renderTierEditor('adv', tiersAdvUSD.length > 0 ? tiersAdvUSD : defaults.tiersAdv);
                }
                if (!tiersEssContainer.children.length) {
                    renderTierEditor('ess', tiersEssUSD.length > 0 ? tiersEssUSD : defaults.tiersEss);
                }
                // Just update headers, tiers are already in USD
                const symbol = getCurrencySymbol('USD');
                const headerAdv = document.getElementById('tier-price-header-adv');
                const headerEss = document.getElementById('tier-price-header-ess');
                if (headerAdv) headerAdv.textContent = `Price per agent (${symbol})`;
                if (headerEss) headerEss.textContent = `Price per agent (${symbol})`;
            } else {
                // Convert from USD defaults to selected currency
                // But first ensure we have tiers to convert
                if (!tiersAdvContainer.children.length || !tiersEssContainer.children.length) {
                    renderTierEditor('adv', tiersAdvUSD.length > 0 ? tiersAdvUSD : defaults.tiersAdv);
                    renderTierEditor('ess', tiersEssUSD.length > 0 ? tiersEssUSD : defaults.tiersEss);
                }
                updateTierHeaders();
            }

            // Final safety check: ensure tiers are rendered after a short delay
            setTimeout(() => {
                console.log('=== TIER INITIALIZATION CHECK ===');
                console.log('Containers:', {
                    advContainer: tiersAdvContainer ? 'found' : 'MISSING',
                    essContainer: tiersEssContainer ? 'found' : 'MISSING',
                    advChildren: tiersAdvContainer ? tiersAdvContainer.children.length : 0,
                    essChildren: tiersEssContainer ? tiersEssContainer.children.length : 0
                });
                console.log('Default tiers:', {
                    advCount: defaults.tiersAdv.length,
                    essCount: defaults.tiersEss.length,
                    advSample: defaults.tiersAdv[0],
                    essSample: defaults.tiersEss[0]
                });
                
                if (!tiersAdvContainer || !tiersAdvContainer.children.length) {
                    console.log('Safety check: Rendering default Advantage tiers');
                    tiersAdvUSD = [...defaults.tiersAdv];
                    renderTierEditor('adv', defaults.tiersAdv);
                    console.log('After render - adv children:', tiersAdvContainer ? tiersAdvContainer.children.length : 'null');
                }
                if (!tiersEssContainer || !tiersEssContainer.children.length) {
                    console.log('Safety check: Rendering default Essentials tiers');
                    tiersEssUSD = [...defaults.tiersEss];
                    renderTierEditor('ess', defaults.tiersEss);
                    console.log('After render - ess children:', tiersEssContainer ? tiersEssContainer.children.length : 'null');
                }
                
                // Final verification
                console.log('Final state:', {
                    advContainer: tiersAdvContainer ? tiersAdvContainer.children.length : 'null',
                    essContainer: tiersEssContainer ? tiersEssContainer.children.length : 'null',
                    advUSD: tiersAdvUSD.length,
                    essUSD: tiersEssUSD.length
                });
                console.log('=== END CHECK ===');
            }, 100);

            function save() {
                const data = {
                    budget: budgetEl.value,
                    priceAdv: priceAdvEl.value,
                    priceEss: priceEssEl.value,
                    currency: (currencyEl.value || 'USD').toUpperCase(),
                    rounding: (roundingEl.value || 'down').toLowerCase(),
                    showAvg: !!showAvgEl.checked,
                    showMultiCurrency: !!showMultiCurrencyEl.checked,
                    tiersAdv: readTiers('adv'),
                    tiersEss: readTiers('ess'),
                    // workflows
                    activeTab,
                    apiToken: apiTokenEl.value,
                    accountGroupId: accountGroupIdEl.value,
                    agentTags: agentTagsEl.multiple 
                        ? Array.from(agentTagsEl.selectedOptions).map(opt => opt.value).filter(Boolean)
                        : agentTagsEl.value,
                    dryRun: !!dryRunEl.checked,
                    schedulerEnabled: !!schedulerEnabledEl.checked,
                    schedulerFrequency: schedulerFrequencyEl.value,
                    schedulerEntries: readSchedulerEntries()
                };
                localStorage.setItem('teBudgetCalc', JSON.stringify(data));
            }

            function fmtCurrency(n, currency) {
                if (!isFinite(n)) return '‚Äì';
                try {
                    return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(n);
                } catch {
                    return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(n);
                }
            }

            function fmtInt(n) {
                if (!isFinite(n)) return '‚Äì';
                return new Intl.NumberFormat().format(n);
            }

            function getCurrencySymbol(currency) {
                try {
                    const formatter = new Intl.NumberFormat(undefined, { style: 'currency', currency: currency || 'USD' });
                    const parts = formatter.formatToParts(1);
                    const symbol = parts.find(part => part.type === 'currency');
                    return symbol ? symbol.value : currency || 'USD';
                } catch {
                    return currency || 'USD';
                }
            }

            // Update USD base values when tiers are manually edited
            function updateUSDBaseValues() {
                const currentCurrency = (currencyEl?.value || 'USD').toUpperCase();
                if (currentCurrency === 'USD') {
                    // Already in USD, just save current values
                    tiersAdvUSD = readTiers('adv').map(t => ({ upTo: t.upTo, price: t.price }));
                    tiersEssUSD = readTiers('ess').map(t => ({ upTo: t.upTo, price: t.price }));
                } else {
                    // Try to get cached rates synchronously
                    try {
                        const CACHE_KEY = `teExchangeRates_USD`;
                        const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                        if (cached.rates && cached.rates[currentCurrency]) {
                            const rate = cached.rates[currentCurrency];
                            const currentAdv = readTiers('adv');
                            const currentEss = readTiers('ess');
                            
                            tiersAdvUSD = currentAdv.map(t => ({
                                upTo: t.upTo,
                                price: t.price != null && isFinite(t.price) ? t.price / rate : t.price
                            }));
                            tiersEssUSD = currentEss.map(t => ({
                                upTo: t.upTo,
                                price: t.price != null && isFinite(t.price) ? t.price / rate : t.price
                            }));
                        } else {
                            // No cached rates, assume current values are in USD (fallback)
                            tiersAdvUSD = readTiers('adv').map(t => ({ upTo: t.upTo, price: t.price }));
                            tiersEssUSD = readTiers('ess').map(t => ({ upTo: t.upTo, price: t.price }));
                        }
                    } catch {
                        // Error reading cache, assume current values are in USD
                        tiersAdvUSD = readTiers('adv').map(t => ({ upTo: t.upTo, price: t.price }));
                        tiersEssUSD = readTiers('ess').map(t => ({ upTo: t.upTo, price: t.price }));
                    }
                }
            }

            async function updateTierHeaders() {
                const currency = (currencyEl?.value || 'USD').toUpperCase();
                const symbol = getCurrencySymbol(currency);
                const headerAdv = document.getElementById('tier-price-header-adv');
                const headerEss = document.getElementById('tier-price-header-ess');
                if (headerAdv) headerAdv.textContent = `Price per agent (${symbol})`;
                if (headerEss) headerEss.textContent = `Price per agent (${symbol})`;
                
                // Get exchange rates (always from USD base for tier conversion)
                const CACHE_KEY = `teExchangeRates_USD`;
                let rates = null;
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < 60 * 60 * 1000)) {
                        rates = cached.rates;
                    } else {
                        // Fetch USD-based rates
                        const response = await fetch(`https://api.exchangerate-api.com/v4/latest/USD`);
                        if (response.ok) {
                            const data = await response.json();
                            rates = data.rates || {};
                            localStorage.setItem(CACHE_KEY, JSON.stringify({
                                rates,
                                timestamp: Date.now(),
                                base: 'USD'
                            }));
                        }
                    }
                } catch {}
                
                const exchangeRates = rates ? { rates, base: 'USD' } : null;
                if (!exchangeRates || !exchangeRates.rates) {
                    // If no rates available, use USD base values or defaults
                    const tiersAdv = readTiers('adv');
                    const tiersEss = readTiers('ess');
                    const advToRender = tiersAdv.length > 0 ? tiersAdv : (tiersAdvUSD.length > 0 ? tiersAdvUSD : defaults.tiersAdv);
                    const essToRender = tiersEss.length > 0 ? tiersEss : (tiersEssUSD.length > 0 ? tiersEssUSD : defaults.tiersEss);
                    renderTierEditor('adv', advToRender);
                    renderTierEditor('ess', essToRender);
                    return;
                }

                const usdRates = exchangeRates.rates;
                const previousCurrency = currencyEl?.dataset?.previousCurrency || 'USD';
                
                // If currency changed, update USD base values from current tiers (convert from previous currency to USD)
                if (previousCurrency !== currency) {
                    if (previousCurrency === 'USD') {
                        // Was in USD, just save current values
                        tiersAdvUSD = readTiers('adv').map(t => ({ upTo: t.upTo, price: t.price }));
                        tiersEssUSD = readTiers('ess').map(t => ({ upTo: t.upTo, price: t.price }));
                    } else if (usdRates[previousCurrency]) {
                        // Convert from previous currency back to USD
                        const prevRate = usdRates[previousCurrency];
                        const currentAdv = readTiers('adv');
                        const currentEss = readTiers('ess');
                        
                        tiersAdvUSD = currentAdv.map(t => ({
                            upTo: t.upTo,
                            price: t.price != null && isFinite(t.price) ? t.price / prevRate : t.price
                        }));
                        tiersEssUSD = currentEss.map(t => ({
                            upTo: t.upTo,
                            price: t.price != null && isFinite(t.price) ? t.price / prevRate : t.price
                        }));
                    }
                }
                
                // Convert from USD base to target currency
                // Use defaults if USD base values are empty (shouldn't happen, but safety check)
                let baseAdv = (tiersAdvUSD && tiersAdvUSD.length > 0) ? tiersAdvUSD : defaults.tiersAdv;
                let baseEss = (tiersEssUSD && tiersEssUSD.length > 0) ? tiersEssUSD : defaults.tiersEss;
                
                let convertedAdv = baseAdv;
                let convertedEss = baseEss;
                
                if (currency !== 'USD' && usdRates[currency]) {
                    // Convert Advantage tiers from USD to target currency
                    convertedAdv = baseAdv.map(tier => {
                        if (tier.price == null || !isFinite(tier.price)) return tier;
                        let convertedPrice = tier.price * usdRates[currency];
                        
                        // Round to appropriate decimal places
                        if (currency === 'JPY') {
                            convertedPrice = Math.round(convertedPrice);
                        } else {
                            convertedPrice = Math.round(convertedPrice * 100) / 100;
                        }
                        
                        return { ...tier, price: convertedPrice };
                    });
                    
                    // Convert Essentials tiers from USD to target currency
                    convertedEss = baseEss.map(tier => {
                        if (tier.price == null || !isFinite(tier.price)) return tier;
                        let convertedPrice = tier.price * usdRates[currency];
                        
                        if (currency === 'JPY') {
                            convertedPrice = Math.round(convertedPrice);
                        } else {
                            convertedPrice = Math.round(convertedPrice * 100) / 100;
                        }
                        
                        return { ...tier, price: convertedPrice };
                    });
                }
                
                // Render converted tiers
                if (convertedAdv.length > 0) renderTierEditor('adv', convertedAdv);
                if (convertedEss.length > 0) renderTierEditor('ess', convertedEss);
                
                // Store current currency for next change
                if (currencyEl) currencyEl.dataset.previousCurrency = currency;
                
                compute();
            }

            function parseNum(input) {
                const val = typeof input === 'string' ? input.trim() : (input?.toString?.() ?? '');
                if (val === '') return NaN;
                const n = Number(val);
                return isFinite(n) ? n : NaN;
            }

            function normalizeTiers(tiersRaw) {
                const tiers = (tiersRaw || [])
                    .map(t => ({ upTo: (t.upTo === null || t.upTo === '' || t.upTo === undefined) ? null : Number(t.upTo), price: Number(t.price) }))
                    .filter(t => isFinite(t.price) && t.price > 0 && (t.upTo === null || (isFinite(t.upTo) && t.upTo > 0)));
                tiers.sort((a, b) => {
                    if (a.upTo === null) return 1;
                    if (b.upTo === null) return -1;
                    return a.upTo - b.upTo;
                });
                // ensure last tier is open-ended
                if (!tiers.length || tiers[tiers.length - 1].upTo !== null) tiers.push({ upTo: null, price: tiers.length ? tiers[tiers.length - 1].price : NaN });
                // remove duplicates with same upTo keeping lowest price
                const compact = [];
                for (const t of tiers) {
                    const last = compact[compact.length - 1];
                    if (last && last.upTo === t.upTo) last.price = Math.min(last.price, t.price); else compact.push(t);
                }
                return compact.filter(t => isFinite(t.price));
            }

            function costForQuantity(quantity, tiers) {
                // Threshold-based pricing: find the tier the quantity qualifies for, apply that price to ALL agents
                if (!tiers.length || quantity <= 0) return 0;
                // Tiers are sorted by upTo ascending
                // Find the first tier where quantity <= upTo (or upTo is null for open-ended)
                let applicableTier = tiers[tiers.length - 1]; // Default to last tier (open-ended)
                for (const tier of tiers) {
                    const threshold = tier.upTo === null ? Infinity : tier.upTo;
                    if (quantity <= threshold) {
                        applicableTier = tier;
                        break; // Found the applicable tier
                    }
                }
                // Apply the tier price to ALL agents
                return quantity * applicableTier.price;
            }

            function maxAgentsUnderBudget(budget, tiers, roundingMode) {
                if (!isFinite(budget) || budget <= 0 || !tiers.length) return { agents: NaN, spent: NaN, leftover: NaN };
                const tiersNorm = normalizeTiers(tiers);
                // Exponential then binary search to find maximum agents where cost <= budget
                let low = 0, high = 1;
                while (costForQuantity(high, tiersNorm) <= budget && high < 1e9) {
                    low = high;
                    high *= 2;
                }
                while (low < high) {
                    const mid = Math.floor((low + high + 1) / 2);
                    const cost = costForQuantity(mid, tiersNorm);
                    if (cost <= budget) low = mid; else high = mid - 1;
                }
                let agents = low;
                if (roundingMode === 'nearest') {
                    // Try +/- 1 around low to approximate nearest under monotonic cost
                    const costLow = costForQuantity(low, tiersNorm);
                    const costUp = costForQuantity(low + 1, tiersNorm);
                    if (Math.abs(budget - costUp) < Math.abs(budget - costLow) && costUp <= budget) agents = low + 1;
                }
                const spent = costForQuantity(agents, tiersNorm);
                const leftover = budget - spent;
                return { agents, spent, leftover };
            }

            function makeTierRow(kind, idx, tier) {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr auto';
                row.style.gap = '8px';
                row.dataset.index = String(idx);

                const upTo = document.createElement('input');
                upTo.type = 'number';
                upTo.min = '1';
                upTo.step = '1';
                upTo.placeholder = 'Up to (qty)';
                upTo.value = tier.upTo == null ? '' : String(tier.upTo);
                upTo.setAttribute('aria-label', 'Up to quantity');

                const price = document.createElement('input');
                price.type = 'number';
                price.min = '0';
                const currency = (currencyEl?.value || 'USD').toUpperCase();
                // Set step based on currency (2 decimals for most, 0 for JPY)
                price.step = currency === 'JPY' ? '1' : '0.01';
                const currencySymbol = getCurrencySymbol(currency);
                price.placeholder = `Price per agent (${currencySymbol})`;
                price.value = tier.price != null ? String(tier.price) : '';
                price.setAttribute('aria-label', `Price in ${currency}`);

                const del = document.createElement('button');
                del.type = 'button';
                del.textContent = 'Remove';
                del.style.padding = '8px 10px';
                del.style.borderRadius = '8px';
                del.style.border = '1px solid var(--border)';
                del.style.background = 'var(--panel)';
                del.style.color = 'var(--text)';

                del.addEventListener('click', () => {
                    const arr = readTiers(kind);
                    arr.splice(idx, 1);
                    renderTierEditor(kind, arr);
                    compute();
                });

                for (const el of [upTo, price]) {
                    el.addEventListener('input', () => {
                        const arr = readTiers(kind);
                        arr[idx] = { upTo: upTo.value === '' ? null : Number(upTo.value), price: Number(price.value) };
                        renderTierEditor(kind, arr);
                        // Update USD base values when tier is edited
                        updateUSDBaseValues();
                        compute();
                    });
                    el.addEventListener('change', () => {
                        updateUSDBaseValues();
                        compute();
                    });
                }

                row.appendChild(upTo);
                row.appendChild(price);
                row.appendChild(del);
                return row;
            }

            function renderTierEditor(kind, tiers) {
                const container = kind === 'adv' ? tiersAdvContainer : tiersEssContainer;
                if (!container) {
                    console.error(`Container not found for ${kind} tiers`);
                    return;
                }
                console.log(`renderTierEditor(${kind}):`, { tiersCount: tiers ? tiers.length : 0, tiers });
                container.innerHTML = '';
                const current = tiers && tiers.length ? tiers : (kind === 'adv' ? defaults.tiersAdv : defaults.tiersEss);
                if (!current || current.length === 0) {
                    console.warn(`No tiers to render for ${kind}, using defaults`);
                    const defaultTiers = kind === 'adv' ? defaults.tiersAdv : defaults.tiersEss;
                    console.log(`Rendering ${defaultTiers.length} default tiers for ${kind}`);
                    defaultTiers.forEach((t, i) => {
                        const row = makeTierRow(kind, i, t);
                        container.appendChild(row);
                        console.log(`Appended tier ${i} to ${kind} container`);
                    });
                } else {
                    console.log(`Rendering ${current.length} tiers for ${kind}`);
                    current.forEach((t, i) => {
                        const row = makeTierRow(kind, i, t);
                        container.appendChild(row);
                        console.log(`Appended tier ${i} to ${kind} container`);
                    });
                }
                console.log(`After renderTierEditor(${kind}): container has ${container.children.length} children`);
                // Save to storage after render
                save();
            }

            function readTiers(kind) {
                const container = kind === 'adv' ? tiersAdvContainer : tiersEssContainer;
                const rows = Array.from(container.children);
                return rows.map(row => {
                    const [upToEl, priceEl] = row.querySelectorAll('input');
                    const upToVal = upToEl.value === '' ? null : Number(upToEl.value);
                    const priceVal = Number(priceEl.value);
                    return { upTo: upToVal, price: priceVal };
                });
            }

            // Multi-currency conversion
            async function getExchangeRates() {
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < 60 * 60 * 1000)) {
                        return { rates: cached.rates, base: baseCurrency };
                    }
                } catch {}
                // If no cache, try to fetch
                try {
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${baseCurrency}`);
                    if (response.ok) {
                        const data = await response.json();
                        const rates = data.rates || {};
                        localStorage.setItem(CACHE_KEY, JSON.stringify({
                            rates,
                            timestamp: Date.now(),
                            base: baseCurrency
                        }));
                        return { rates, base: baseCurrency };
                    }
                } catch {}
                return null;
            }

            function convertToAllCurrencies(value, baseCurrency, rates) {
                if (!rates || !isFinite(value) || value <= 0) return {};
                const allCurrencies = ['USD', 'EUR', 'JPY', 'AUD', 'MXN'];
                const converted = {};
                for (const code of allCurrencies) {
                    if (code === baseCurrency) {
                        converted[code] = value;
                    } else if (rates[code]) {
                        converted[code] = value * rates[code];
                    }
                }
                return converted;
            }

            function updateMultiCurrencyDisplay(data) {
                if (!showMultiCurrencyEl.checked) {
                    multiCurrencyPanel.style.display = 'none';
                    return;
                }
                multiCurrencyPanel.style.display = '';
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                
                getExchangeRates().then(result => {
                    if (!result || !result.rates) {
                        multiCurrencyDisplay.innerHTML = '<div class="hint">Exchange rates not available. Click "Update exchange rates" to fetch rates.</div>';
                        return;
                    }
                    
                    const { rates } = result;
                    const allCurrencies = ['USD', 'EUR', 'JPY', 'AUD', 'MXN'];
                    let html = '';
                    
                    for (const code of allCurrencies) {
                        const converted = convertToAllCurrencies(data.budget || 0, baseCurrency, rates);
                        const budgetVal = converted[code] || 0;
                        const advLeftVal = convertToAllCurrencies(data.advLeft || 0, baseCurrency, rates)[code] || 0;
                        const essLeftVal = convertToAllCurrencies(data.essLeft || 0, baseCurrency, rates)[code] || 0;
                        const avgAdvVal = convertToAllCurrencies(data.avgAdv || 0, baseCurrency, rates)[code] || 0;
                        const avgEssVal = convertToAllCurrencies(data.avgEss || 0, baseCurrency, rates)[code] || 0;
                        
                        html += `<div class="result" style="padding:12px;">
                            <h3 style="font-size:13px; margin-bottom:8px; color:var(--accent);">${code}</h3>
                            <div style="display:grid; gap:6px; font-size:12px;">
                                <div style="display:flex; justify-content:space-between;"><span>Budget:</span> <strong>${fmtCurrency(budgetVal, code)}</strong></div>
                                <div style="display:flex; justify-content:space-between;"><span>Unspent (Adv):</span> <strong>${fmtCurrency(advLeftVal, code)}</strong></div>
                                <div style="display:flex; justify-content:space-between;"><span>Unspent (Ess):</span> <strong>${fmtCurrency(essLeftVal, code)}</strong></div>
                                ${data.showAvg ? `<div style="display:flex; justify-content:space-between;"><span>Avg/agent (Adv):</span> <strong>${fmtCurrency(avgAdvVal, code)}</strong></div>` : ''}
                                ${data.showAvg ? `<div style="display:flex; justify-content:space-between;"><span>Avg/agent (Ess):</span> <strong>${fmtCurrency(avgEssVal, code)}</strong></div>` : ''}
                            </div>
                        </div>`;
                    }
                    
                    multiCurrencyDisplay.innerHTML = html;
                });
            }

            function compute() {
                const budget = parseNum(budgetEl.value);
                const priceAdv = parseNum(priceAdvEl.value);
                const priceEss = parseNum(priceEssEl.value);
                const currency = (currencyEl.value || 'USD').toUpperCase();
                let rounding = (roundingEl.value || 'down').toLowerCase();
                if (rounding !== 'down' && rounding !== 'nearest') rounding = 'down';
                const showAvg = !!showAvgEl.checked;

                currencyTagValue.textContent = currency;

                const tiersAdv = normalizeTiers(readTiers('adv'));
                const tiersEss = normalizeTiers(readTiers('ess'));

                let advAgents, advSpent, advLeft;
                if (tiersAdv.length && isFinite(budget)) {
                    const res = maxAgentsUnderBudget(budget, tiersAdv, rounding);
                    advAgents = res.agents; advSpent = res.spent; advLeft = res.leftover;
                } else {
                    const raw = (isFinite(budget) && isFinite(priceAdv) && priceAdv > 0) ? budget / priceAdv : NaN;
                    advAgents = rounding === 'nearest' ? Math.round(raw) : Math.floor(raw);
                    advSpent = isFinite(advAgents) ? advAgents * priceAdv : NaN;
                    advLeft = isFinite(budget) ? budget - advSpent : NaN;
                }

                let essAgents, essSpent, essLeft;
                if (tiersEss.length && isFinite(budget)) {
                    const res = maxAgentsUnderBudget(budget, tiersEss, rounding);
                    essAgents = res.agents; essSpent = res.spent; essLeft = res.leftover;
                } else {
                    const raw = (isFinite(budget) && isFinite(priceEss) && priceEss > 0) ? budget / priceEss : NaN;
                    essAgents = rounding === 'nearest' ? Math.round(raw) : Math.floor(raw);
                    essSpent = isFinite(essAgents) ? essAgents * priceEss : NaN;
                    essLeft = isFinite(budget) ? budget - essSpent : NaN;
                }

                advCountEl.textContent = fmtInt(advAgents);
                essCountEl.textContent = fmtInt(essAgents);
                leftoverAdvEl.textContent = fmtCurrency(advLeft, currency);
                leftoverEssEl.textContent = fmtCurrency(essLeft, currency);

                // Effective average price (spent / agents)
                const avgAdv = isFinite(advSpent) && isFinite(advAgents) && advAgents > 0 ? (advSpent / advAgents) : NaN;
                const avgEss = isFinite(essSpent) && isFinite(essAgents) && essAgents > 0 ? (essSpent / essAgents) : NaN;
                avgPriceAdvEl.textContent = isFinite(avgAdv) ? fmtCurrency(avgAdv, currency) : '‚Äì';
                avgPriceEssEl.textContent = isFinite(avgEss) ? fmtCurrency(avgEss, currency) : '‚Äì';
                resAvgAdv.style.display = showAvg ? '' : 'none';
                resAvgEss.style.display = showAvg ? '' : 'none';

                // Update multi-currency display
                updateMultiCurrencyDisplay({
                    budget,
                    advLeft,
                    essLeft,
                    avgAdv: isFinite(avgAdv) ? avgAdv : 0,
                    avgEss: isFinite(avgEss) ? avgEss : 0,
                    showAvg
                });

                save();
            }

            const inputs = [budgetEl, priceAdvEl, priceEssEl, currencyEl, roundingEl, showAvgEl];
            for (const el of inputs) {
                el.addEventListener('input', compute);
                el.addEventListener('change', compute);
            }

            // Update tier headers when currency changes
            currencyEl.addEventListener('change', () => {
                updateTierHeaders();
                compute();
            });

            showMultiCurrencyEl.addEventListener('change', () => {
                compute();
                save();
            });

            addTierAdvBtn.addEventListener('click', () => {
                const tiers = readTiers('adv');
                tiers.push({ upTo: '', price: '' });
                renderTierEditor('adv', tiers);
                compute();
            });

            addTierEssBtn.addEventListener('click', () => {
                const tiers = readTiers('ess');
                tiers.push({ upTo: '', price: '' });
                renderTierEditor('ess', tiers);
                compute();
            });

            // Reset to default tiers
            resetTierAdvBtn.addEventListener('click', () => {
                if (confirm('Reset Advantage tiers to default values? This will replace all current tiers.')) {
                    renderTierEditor('adv', defaults.tiersAdv);
                    compute();
                }
            });

            resetTierEssBtn.addEventListener('click', () => {
                if (confirm('Reset Essentials tiers to default values? This will replace all current tiers.')) {
                    renderTierEditor('ess', defaults.tiersEss);
                    compute();
                }
            });

            // Exchange rate fetching
            async function fetchExchangeRates() {
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                const CACHE_DURATION = 60 * 60 * 1000; // 1 hour
                
                // Check cache first
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < CACHE_DURATION)) {
                        displayRates(cached.rates, baseCurrency);
                        return;
                    }
                } catch {}

                if (fetchRatesBtn) {
                    fetchRatesBtn.textContent = 'Updating...';
                    fetchRatesBtn.disabled = true;
                }
                
                try {
                    // Using exchangerate-api.io free tier (no API key needed for basic usage)
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${baseCurrency}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    const rates = data.rates || {};
                    
                    // Cache the rates
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        rates,
                        timestamp: Date.now(),
                        base: baseCurrency
                    }));
                    
                    displayRates(rates, baseCurrency);
                    // Trigger recompute to update multi-currency display
                    if (showMultiCurrencyEl && showMultiCurrencyEl.checked) {
                        compute();
                    }
                    // Update synthetics calculator costs
                    if (typeof renderConfigList === 'function') {
                        renderConfigList();
                    }
                } catch (err) {
                    ratesDisplayEl.textContent = 'Error: ' + (err.message || 'Failed to fetch rates');
                    resRates.style.display = '';
                } finally {
                    if (fetchRatesBtn) {
                        fetchRatesBtn.textContent = 'Update Rates';
                        fetchRatesBtn.disabled = false;
                    }
                }
            }

            function displayRates(rates, baseCurrency) {
                const allCurrencies = ['USD', 'EUR', 'JPY', 'AUD', 'MXN'];
                const currencies = allCurrencies.filter(c => c !== baseCurrency);
                const lines = currencies.map(code => {
                    const rate = rates[code];
                    if (!rate) return null;
                    return `${code}: ${rate.toFixed(4)}`;
                }).filter(Boolean);
                
                if (lines.length > 0) {
                    ratesDisplayEl.textContent = `vs ${baseCurrency}: ${lines.join(' ‚Ä¢ ')}`;
                    resRates.style.display = '';
                } else {
                    ratesDisplayEl.textContent = 'No rates available';
                    resRates.style.display = '';
                }
            }

            if (fetchRatesBtn) {
                fetchRatesBtn.addEventListener('click', fetchExchangeRates);
            }
            
            // Unified currency change handler (updates all pages)
            function updateUnifiedCurrency() {
                if (!unifiedCurrencyEl) return;
                const baseCurrency = (unifiedCurrencyEl.value || 'USD').toUpperCase();
                
                // Update all currency tags
                const flowcalcCurrencyTagValue = document.getElementById('flowcalcCurrencyTagValue');
                if (currencyTagValue) currencyTagValue.textContent = baseCurrency;
                if (syntheticsCurrencyTagValue) syntheticsCurrencyTagValue.textContent = baseCurrency;
                if (flowcalcCurrencyTagValue) flowcalcCurrencyTagValue.textContent = baseCurrency;
                
                // Save currency preference
                try {
                    const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    saved.currency = unifiedCurrencyEl.value;
                    saved.syntheticsCurrency = unifiedCurrencyEl.value;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(saved));
                } catch {}
                
                // Update EPA calculator
                compute();
                
                // Update synthetics calculator
                if (typeof renderConfigList === 'function') {
                    renderConfigList();
                }
                
                // Update flow calculator
                if (typeof calculateFlowUnits === 'function') {
                    calculateFlowUnits();
                }
                if (typeof calculateAWSCosts === 'function') {
                    calculateAWSCosts();
                }
                
                // Try to load cached rates for new currency, or fetch if not available
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < 60 * 60 * 1000)) {
                        if (typeof displayRates === 'function') {
                            displayRates(cached.rates, baseCurrency);
                        }
                    } else {
                        // Cache expired or doesn't exist, fetch new rates
                        if (typeof fetchExchangeRates === 'function') {
                            fetchExchangeRates();
                        }
                    }
                } catch {
                    if (typeof fetchExchangeRates === 'function') {
                        fetchExchangeRates();
                    }
                }
            }
            
            if (unifiedCurrencyEl) {
                unifiedCurrencyEl.addEventListener('change', updateUnifiedCurrency);
            }
            
            // Legacy handler for backward compatibility
            if (currencyEl) {
                currencyEl.addEventListener('change', updateUnifiedCurrency);
            }
            
            // Initialize unified currency from localStorage on page load
            try {
                const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                const savedCurrency = saved.currency || saved.syntheticsCurrency || 'USD';
                if (unifiedCurrencyEl) {
                    unifiedCurrencyEl.value = savedCurrency;
                    updateUnifiedCurrency();
                }
                // Load cached rates on page load
                const baseCurrency = savedCurrency.toUpperCase();
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                if (cached.rates && typeof displayRates === 'function') {
                    displayRates(cached.rates, baseCurrency);
                }
            } catch {}

            function getTagList() {
                // Handle multi-select dropdown
                if (agentTagsEl.multiple) {
                    return Array.from(agentTagsEl.selectedOptions)
                        .map(option => option.value)
                        .filter(Boolean);
                }
                // Fallback for text input (if still used elsewhere)
                return (agentTagsEl.value || '')
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(Boolean);
            }

            // Load Account Groups from API
            async function loadAccountGroups() {
                const token = apiTokenEl.value.trim();
                if (!token) {
                    alert('Please enter an API token first');
                    return;
                }

                const btn = loadAccountGroupsBtn;
                const originalText = btn.textContent;
                btn.textContent = 'Loading...';
                btn.disabled = true;

                try {
                    // Use proxy endpoint or direct API
                    const url = USE_PROXY ? `${API_PROXY_BASE}/account-groups` : `${API_BASE}/account-groups`;
                    console.log('Fetching account groups from:', url);
                    
                    const resp = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/hal+json'
                        }
                    });

                    console.log('Response status:', resp.status, resp.statusText);

                    if (!resp.ok) {
                        let errorText = '';
                        try {
                            errorText = await resp.text();
                            console.error('Error response body:', errorText);
                        } catch (e) {
                            errorText = resp.statusText;
                        }
                        throw new Error(`API ${resp.status}: ${errorText || resp.statusText}`);
                    }

                    const data = await resp.json();
                    const accountGroups = data?.accountGroups || [];

                    // Clear existing options (except the first placeholder)
                    accountGroupIdEl.innerHTML = '<option value="">-- Select Account Group --</option>';

                    // Populate dropdown
                    accountGroups.forEach(ag => {
                        const option = document.createElement('option');
                        option.value = ag.aid || ag.accountGroupId || '';
                        const displayName = ag.accountGroupName || ag.organizationName || ag.aid || 'Unknown';
                        option.textContent = `${displayName} (${ag.aid})`;
                        accountGroupIdEl.appendChild(option);
                    });

                    // Auto-select if only one account group
                    if (accountGroups.length === 1) {
                        accountGroupIdEl.value = accountGroups[0].aid || accountGroups[0].accountGroupId || '';
                        accountGroupIdEl.dispatchEvent(new Event('change'));
                    }

                    save();
                } catch (err) {
                    let errorMsg = err?.message || String(err);
                    // Check for CORS or network errors
                    if (err.name === 'TypeError' && err.message.includes('Failed to fetch')) {
                        errorMsg = 'Network error: Failed to fetch. This may be a CORS issue. Make sure you are accessing the API from a domain that allows CORS, or use a CORS proxy.';
                    }
                    alert('Error loading account groups: ' + errorMsg);
                    console.error('Error loading account groups:', err);
                    // Show error in the account group dropdown too
                    accountGroupIdEl.innerHTML = `<option value="">Error: ${errorMsg}</option>`;
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            // Load Labels for selected Account Group
            async function loadLabels() {
                const token = apiTokenEl.value.trim();
                const accountGroupId = accountGroupIdEl.value;
                
                if (!token) {
                    agentTagsEl.innerHTML = '<option value="">-- Enter API token first --</option>';
                    return;
                }

                if (!accountGroupId) {
                    agentTagsEl.innerHTML = '<option value="">-- Select Account Group first --</option>';
                    return;
                }

                // Show loading state
                agentTagsEl.innerHTML = '<option value="">Loading labels...</option>';
                agentTagsEl.disabled = true;

                try {
                    // Use proxy endpoint or direct API
                    const url = USE_PROXY 
                        ? `${API_PROXY_BASE}/endpoint/labels?aid=${encodeURIComponent(accountGroupId)}`
                        : `${API_BASE}/endpoint/labels?aid=${encodeURIComponent(accountGroupId)}`;
                    const resp = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/hal+json'
                        }
                    });

                    if (!resp.ok) {
                        throw new Error(`API ${resp.status}: ${resp.statusText}`);
                    }

                    const data = await resp.json();
                    // Based on Postman collection: response has "labels" array with "id" and "name" fields
                    const labels = data?.labels || [];

                    // Clear and populate labels
                    agentTagsEl.innerHTML = '';
                    
                    if (labels.length === 0) {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '-- No labels found --';
                        agentTagsEl.appendChild(option);
                    } else {
                        labels.forEach(label => {
                            const option = document.createElement('option');
                            // Use label name as value (as per Postman collection structure)
                            option.value = label.name || label.id || '';
                            option.textContent = label.name || label.id || 'Unknown';
                            agentTagsEl.appendChild(option);
                        });
                    }

                    save();
                } catch (err) {
                    agentTagsEl.innerHTML = '<option value="">Error loading labels</option>';
                    console.error('Error loading labels:', err);
                } finally {
                    agentTagsEl.disabled = false;
                }
            }

            // Event listeners
            if (loadAccountGroupsBtn) {
                loadAccountGroupsBtn.addEventListener('click', loadAccountGroups);
            }

            if (accountGroupIdEl) {
                accountGroupIdEl.addEventListener('change', () => {
                    loadLabels();
                    save();
                });
            }

            // Load labels when API token changes (if account group is already selected)
            if (apiTokenEl) {
                apiTokenEl.addEventListener('blur', () => {
                    if (accountGroupIdEl.value) {
                        loadLabels();
                    }
                });
            }

            dryRunEl.addEventListener('change', () => { save(); });

            const workflowInputs = [
                apiTokenEl,
                accountGroupIdEl,
                agentTagsEl,
                schedulerFrequencyEl
            ];
            workflowInputs.forEach(el => {
                el.addEventListener('input', () => save());
                el.addEventListener('change', () => save());
            });

            async function fetchLicenseCounts() {
                const tags = getTagList();
                if (dryRunEl.checked) {
                    const simulated = {
                        Advantage: Math.max(0, Number(advCountEl.textContent.replace(/[^0-9]/g, '')) || 0),
                        Essentials: Math.max(0, Number(essCountEl.textContent.replace(/[^0-9]/g, '')) || 0)
                    };
                    currentAdvCountEl.textContent = fmtInt(simulated.Advantage);
                    currentEssCountEl.textContent = fmtInt(simulated.Essentials);
                    lastCountStatusEl.textContent = 'Dry run at ' + new Date().toLocaleTimeString();
                    return;
                }
                const token = apiTokenEl.value.trim();
                const accountGroupId = accountGroupIdEl.value;
                
                if (!token) {
                    lastCountStatusEl.textContent = 'Missing API token';
                    return;
                }
                
                if (!accountGroupId) {
                    lastCountStatusEl.textContent = 'Please select an Account Group';
                    return;
                }

                const base = USE_PROXY ? API_PROXY_BASE : API_BASE.replace(/\/$/, '');
                const path = USE_PROXY ? '/endpoint/agents' : AGENTS_ENDPOINT;
                const params = new URLSearchParams();
                params.append('aid', accountGroupId);
                tags.forEach(tag => params.append('tag', tag));
                const finalUrl = USE_PROXY 
                    ? `${base}${path}?${params.toString()}`
                    : `${base}${path}?${params.toString()}`;
                try {
                    lastCountStatusEl.textContent = 'Fetching‚Ä¶';
                    const resp = await fetch(finalUrl, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!resp.ok) {
                        const text = await resp.text().catch(() => '');
                        throw new Error(`API ${resp.status}: ${text || resp.statusText}`);
                    }
                    const data = await resp.json();
                    const agents = data?.endpointAgents || data?.agents || data?.items || [];
                    const counts = { Advantage: 0, Essentials: 0 };
                    agents.forEach(agent => {
                        const type = agent?.licenseType || agent?.license || '';
                        if (type && counts[type] !== undefined) counts[type] += 1;
                    });
                    currentAdvCountEl.textContent = fmtInt(counts.Advantage);
                    currentEssCountEl.textContent = fmtInt(counts.Essentials);
                    lastCountStatusEl.textContent = `Updated at ${new Date().toLocaleTimeString()}`;
                } catch (err) {
                    lastCountStatusEl.textContent = 'Error: ' + (err?.message || String(err));
                }
            }

            refreshCountsBtn.addEventListener('click', fetchLicenseCounts);

            // ---------- EPA Scheduler ----------
            function timeToMinutes(t) {
                const m = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/.exec((t || '').trim());
                if (!m) return NaN;
                return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
            }

            function makeSchedulerEntryRow(entry = {}) {
                // Read-only list item
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr 1.2fr 1fr 1fr 1fr auto auto';
                row.style.gap = '8px';
                row.style.padding = '12px';
                row.style.borderBottom = '1px solid var(--border)';
                row.style.alignItems = 'center';
                row.className = 'scheduler-row';

                const orgNameEl = document.createElement('div');
                orgNameEl.textContent = entry.orgName || '-';
                orgNameEl.style.color = 'var(--text)';

                const accountGroupEl = document.createElement('div');
                accountGroupEl.textContent = entry.accountGroup || '-';
                accountGroupEl.style.color = 'var(--text)';

                const labelEl = document.createElement('div');
                labelEl.textContent = entry.label || '-';
                labelEl.style.color = 'var(--text)';
                labelEl.style.fontWeight = '500';

                const fromEl = document.createElement('div');
                fromEl.textContent = entry.from || '-';
                fromEl.style.color = 'var(--text)';

                const toEl = document.createElement('div');
                toEl.textContent = entry.to || '-';
                toEl.style.color = 'var(--text)';

                const actionEl = document.createElement('div');
                actionEl.textContent = entry.action ? entry.action.charAt(0).toUpperCase() + entry.action.slice(1) : '-';
                actionEl.style.color = entry.action === 'enable' ? 'var(--accent-2)' : 'var(--muted)';
                actionEl.style.fontWeight = '500';

                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.textContent = 'Edit';
                editBtn.style.padding = '6px 12px';
                editBtn.style.borderRadius = '6px';
                editBtn.style.border = '1px solid var(--border)';
                editBtn.style.background = 'var(--panel)';
                editBtn.style.color = 'var(--text)';
                editBtn.style.cursor = 'pointer';
                editBtn.style.fontSize = '13px';

                editBtn.addEventListener('click', () => {
                    openLabelModal('update', entry);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.textContent = 'Delete';
                deleteBtn.style.padding = '6px 12px';
                deleteBtn.style.borderRadius = '6px';
                deleteBtn.style.border = '1px solid var(--border)';
                deleteBtn.style.background = 'var(--danger)';
                deleteBtn.style.color = 'white';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.fontSize = '13px';

                deleteBtn.addEventListener('click', () => {
                    if (confirm(`Are you sure you want to delete the schedule for label "${entry.label}"?`)) {
                        const entries = readSchedulerEntries();
                        const updatedEntries = entries.filter(e => 
                            !(e.label === entry.label && e.accountGroup === entry.accountGroup && e.from === entry.from && e.to === entry.to)
                        );
                        
                        // Save to localStorage
                        try {
                            const data = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                            data.schedulerEntries = updatedEntries;
                            localStorage.setItem('teBudgetCalc', JSON.stringify(data));
                        } catch (err) {
                            console.error('Failed to save entries:', err);
                        }

                        renderSchedulerEntries(updatedEntries);
                        save();
                        resetSchedulerState();
                    }
                });

                row.append(orgNameEl, accountGroupEl, labelEl, fromEl, toEl, actionEl, editBtn, deleteBtn);
                return row;
            }

            function renderSchedulerEntries(entries) {
                schedulerListEl.innerHTML = '';
                const entryList = entries && entries.length ? entries : [];
                
                if (!entryList.length) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.style.padding = '24px';
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = 'var(--muted)';
                    emptyMsg.textContent = 'No schedules configured. Click "Add schedule" to create one.';
                    schedulerListEl.appendChild(emptyMsg);
                    return;
                }
                
                // Add header row for column labels
                const headerRow = document.createElement('div');
                headerRow.style.display = 'grid';
                headerRow.style.gridTemplateColumns = '1fr 1fr 1.2fr 1fr 1fr 1fr auto auto';
                headerRow.style.gap = '8px';
                headerRow.style.padding = '12px';
                headerRow.style.borderBottom = '2px solid var(--border)';
                headerRow.style.fontWeight = '600';
                headerRow.style.color = 'var(--muted)';
                headerRow.style.fontSize = '13px';
                ['Org Name', 'Account Group', 'Label', 'From', 'To', 'Action', '', ''].forEach(text => {
                    const cell = document.createElement('div');
                    cell.textContent = text;
                    headerRow.appendChild(cell);
                });
                schedulerListEl.appendChild(headerRow);
                
                // Group entries by OrgName
                const grouped = {};
                entryList.forEach(entry => {
                    const orgName = entry.orgName || '(No Org Name)';
                    if (!grouped[orgName]) {
                        grouped[orgName] = [];
                    }
                    grouped[orgName].push(entry);
                });
                
                // Sort org names for consistent display
                const sortedOrgNames = Object.keys(grouped).sort();
                
                // Render each group with a header
                sortedOrgNames.forEach((orgName, index) => {
                    // Create group container
                    const groupContainer = document.createElement('div');
                    groupContainer.style.marginTop = index > 0 ? '16px' : '8px';
                    
                    // Create group header (clickable)
                    const header = document.createElement('div');
                    header.style.marginBottom = '8px';
                    header.style.padding = '8px 0';
                    header.style.borderBottom = '1px solid var(--border)';
                    header.style.fontWeight = '600';
                    header.style.color = 'var(--text)';
                    header.style.cursor = 'pointer';
                    header.style.display = 'flex';
                    header.style.alignItems = 'center';
                    header.style.gap = '8px';
                    header.style.userSelect = 'none';
                    
                    // Chevron icon (expanded by default)
                    const chevron = document.createElement('span');
                    chevron.textContent = '‚ñº';
                    chevron.style.fontSize = '10px';
                    chevron.style.transition = 'transform 0.2s';
                    
                    const orgNameText = document.createElement('span');
                    orgNameText.textContent = orgName;
                    
                    header.appendChild(chevron);
                    header.appendChild(orgNameText);
                    
                    // Create container for rows
                    const rowsContainer = document.createElement('div');
                    rowsContainer.className = 'scheduler-group-rows';
                    
                    // Render rows for this group
                    grouped[orgName].forEach(entry => {
                        rowsContainer.appendChild(makeSchedulerEntryRow(entry));
                    });
                    
                    // Toggle collapse/expand on header click
                    header.addEventListener('click', () => {
                        const isCollapsed = rowsContainer.style.display === 'none';
                        rowsContainer.style.display = isCollapsed ? '' : 'none';
                        chevron.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
                        chevron.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(-90deg)';
                    });
                    
                    groupContainer.appendChild(header);
                    groupContainer.appendChild(rowsContainer);
                    schedulerListEl.appendChild(groupContainer);
                });
            }

            function readSchedulerEntries() {
                // Read from localStorage since the list is now read-only
                try {
                    const data = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    return data.schedulerEntries || [];
                } catch {
                    return [];
                }
            }

            // ========== Label Management Modal ==========
            const labelManagementModal = document.getElementById('labelManagementModal');
            const closeLabelModalBtn = document.getElementById('closeLabelModal');
            const tabCreateLabel = document.getElementById('tabCreateLabel');
            const tabUpdateLabel = document.getElementById('tabUpdateLabel');
            const createLabelContent = document.getElementById('createLabelContent');
            const updateLabelContent = document.getElementById('updateLabelContent');
            const labelScheduleContainer = document.getElementById('labelScheduleContainer');
            const addAnotherLabelBtn = document.getElementById('addAnotherLabel');
            const submitCreateLabelBtn = document.getElementById('submitCreateLabel');
            const cancelCreateLabelBtn = document.getElementById('cancelCreateLabel');
            const retrieveLabelBtn = document.getElementById('retrieveLabel');
            let currentEditEntry = null;
            let labelEntryCount = 0;

            function openLabelModal(mode = 'create', entry = null) {
                if (!labelManagementModal) {
                    console.error('Label management modal not found');
                    return;
                }
                currentEditEntry = entry;
                labelManagementModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                if (mode === 'create') {
                    switchTab('create');
                    resetCreateForm();
                    addLabelEntry(entry || null);
                } else {
                    switchTab('update');
                    if (entry) {
                        document.getElementById('updateAccountId').value = entry.accountGroup || '';
                        document.getElementById('updateTransactionId').value = entry.label || '';
                    }
                }
            }

            function closeLabelModal() {
                if (!labelManagementModal) return;
                labelManagementModal.style.display = 'none';
                document.body.style.overflow = '';
                currentEditEntry = null;
            }

            addSchedulerEntryBtn.addEventListener('click', () => {
                openLabelModal('create');
            });

            function switchTab(tab) {
                if (!createLabelContent || !updateLabelContent || !tabCreateLabel || !tabUpdateLabel) return;
                if (tab === 'create') {
                    createLabelContent.style.display = '';
                    updateLabelContent.style.display = 'none';
                    tabCreateLabel.style.borderBottomColor = 'var(--accent)';
                    tabCreateLabel.style.background = 'var(--panel)';
                    tabCreateLabel.style.color = 'var(--text)';
                    tabUpdateLabel.style.borderBottomColor = 'transparent';
                    tabUpdateLabel.style.background = 'transparent';
                    tabUpdateLabel.style.color = 'var(--muted)';
                } else {
                    createLabelContent.style.display = 'none';
                    updateLabelContent.style.display = '';
                    tabUpdateLabel.style.borderBottomColor = 'var(--accent)';
                    tabUpdateLabel.style.background = 'var(--panel)';
                    tabUpdateLabel.style.color = 'var(--text)';
                    tabCreateLabel.style.borderBottomColor = 'transparent';
                    tabCreateLabel.style.background = 'transparent';
                    tabCreateLabel.style.color = 'var(--muted)';
                }
            }

            function resetCreateForm() {
                if (!labelScheduleContainer || !addAnotherLabelBtn) return;
                labelEntryCount = 0;
                labelScheduleContainer.innerHTML = '';
                const modalAccountId = document.getElementById('modalAccountId');
                const modalToken = document.getElementById('modalToken');
                if (modalAccountId) modalAccountId.value = '';
                if (modalToken) modalToken.value = '';
                const singleRadio = document.querySelector('input[name="creationMode"][value="single"]');
                if (singleRadio) singleRadio.checked = true;
                addAnotherLabelBtn.style.display = 'none';
            }

            function addLabelEntry(entry = null) {
                if (!labelScheduleContainer) return;
                labelEntryCount++;
                const entryDiv = document.createElement('div');
                entryDiv.className = 'label-entry';
                entryDiv.style.marginBottom = '24px';
                entryDiv.style.padding = '16px';
                entryDiv.style.border = '1px solid var(--border)';
                entryDiv.style.borderRadius = '8px';
                entryDiv.style.background = 'var(--bg)';

                const labelTag = document.createElement('div');
                labelTag.textContent = `Label ${labelEntryCount}`;
                labelTag.style.display = 'inline-block';
                labelTag.style.padding = '4px 8px';
                labelTag.style.marginBottom = '12px';
                labelTag.style.background = 'var(--accent)';
                labelTag.style.color = 'white';
                labelTag.style.borderRadius = '4px';
                labelTag.style.fontSize = '12px';
                labelTag.style.fontWeight = '500';

                const enableLabelDiv = document.createElement('div');
                enableLabelDiv.style.display = 'flex';
                enableLabelDiv.style.alignItems = 'center';
                enableLabelDiv.style.justifyContent = 'space-between';
                enableLabelDiv.style.marginBottom = '16px';

                const enableLabelLabel = document.createElement('label');
                enableLabelLabel.textContent = 'Enable Label';
                enableLabelLabel.style.color = 'var(--text)';
                enableLabelLabel.style.fontSize = '14px';
                enableLabelLabel.style.cursor = 'pointer';

                const enableToggle = document.createElement('input');
                enableToggle.type = 'checkbox';
                enableToggle.checked = entry ? (entry.action === 'enable') : true;
                enableToggle.style.cursor = 'pointer';
                enableToggle.style.width = '40px';
                enableToggle.style.height = '20px';

                enableLabelLabel.appendChild(enableToggle);
                enableLabelDiv.appendChild(enableLabelLabel);

                const labelNameInput = document.createElement('input');
                labelNameInput.type = 'text';
                labelNameInput.placeholder = 'e.g., Production Label';
                labelNameInput.value = entry ? (entry.label || '') : '';
                labelNameInput.required = true;
                labelNameInput.style.width = '100%';
                labelNameInput.style.padding = '10px 12px';
                labelNameInput.style.marginBottom = '16px';
                labelNameInput.style.borderRadius = '8px';
                labelNameInput.style.border = '1px solid var(--border)';
                labelNameInput.style.background = 'var(--panel)';
                labelNameInput.style.color = 'var(--text)';
                labelNameInput.style.outline = 'none';

                const labelNameLabel = document.createElement('label');
                labelNameLabel.textContent = 'Label Name ';
                labelNameLabel.innerHTML += '<span style="color: var(--danger);">*</span>';
                labelNameLabel.style.display = 'block';
                labelNameLabel.style.marginBottom = '6px';
                labelNameLabel.style.fontSize = '13px';
                labelNameLabel.style.color = 'var(--text)';

                const scheduleDatesDiv = document.createElement('div');
                scheduleDatesDiv.style.display = 'grid';
                scheduleDatesDiv.style.gridTemplateColumns = '1fr 1fr';
                scheduleDatesDiv.style.gap = '16px';

                const fromDiv = document.createElement('div');
                const fromLabel = document.createElement('label');
                fromLabel.textContent = 'From ';
                fromLabel.innerHTML += '<span style="color: var(--danger);">*</span>';
                fromLabel.style.display = 'block';
                fromLabel.style.marginBottom = '6px';
                fromLabel.style.fontSize = '13px';
                fromLabel.style.color = 'var(--text)';

                const fromInput = document.createElement('input');
                fromInput.type = 'time';
                fromInput.value = entry ? (entry.from || '') : '';
                fromInput.required = true;
                fromInput.style.width = '100%';
                fromInput.style.padding = '10px 12px';
                fromInput.style.borderRadius = '8px';
                fromInput.style.border = '1px solid var(--border)';
                fromInput.style.background = 'var(--panel)';
                fromInput.style.color = 'var(--text)';
                fromInput.style.outline = 'none';

                fromDiv.appendChild(fromLabel);
                fromDiv.appendChild(fromInput);

                const toDiv = document.createElement('div');
                const toLabel = document.createElement('label');
                toLabel.textContent = 'To ';
                toLabel.innerHTML += '<span style="color: var(--danger);">*</span>';
                toLabel.style.display = 'block';
                toLabel.style.marginBottom = '6px';
                toLabel.style.fontSize = '13px';
                toLabel.style.color = 'var(--text)';

                const toInput = document.createElement('input');
                toInput.type = 'time';
                toInput.value = entry ? (entry.to || '') : '';
                toInput.required = true;
                toInput.style.width = '100%';
                toInput.style.padding = '10px 12px';
                toInput.style.borderRadius = '8px';
                toInput.style.border = '1px solid var(--border)';
                toInput.style.background = 'var(--panel)';
                toInput.style.color = 'var(--text)';
                toInput.style.outline = 'none';

                toDiv.appendChild(toLabel);
                toDiv.appendChild(toInput);

                scheduleDatesDiv.appendChild(fromDiv);
                scheduleDatesDiv.appendChild(toDiv);

                entryDiv.appendChild(labelTag);
                entryDiv.appendChild(enableLabelDiv);
                entryDiv.appendChild(labelNameLabel);
                entryDiv.appendChild(labelNameInput);
                entryDiv.appendChild(scheduleDatesDiv);

                labelScheduleContainer.appendChild(entryDiv);
            }

            if (tabCreateLabel) {
                tabCreateLabel.addEventListener('click', () => switchTab('create'));
            }
            if (tabUpdateLabel) {
                tabUpdateLabel.addEventListener('click', () => switchTab('update'));
            }
            if (closeLabelModalBtn) {
                closeLabelModalBtn.addEventListener('click', closeLabelModal);
            }
            if (cancelCreateLabelBtn) {
                cancelCreateLabelBtn.addEventListener('click', closeLabelModal);
            }

            // Close modal when clicking outside
            if (labelManagementModal) {
                labelManagementModal.addEventListener('click', (e) => {
                    if (e.target === labelManagementModal) {
                        closeLabelModal();
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && labelManagementModal.style.display === 'block') {
                    closeLabelModal();
                }
            });

            // Handle creation mode change
            document.querySelectorAll('input[name="creationMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (addAnotherLabelBtn) {
                        addAnotherLabelBtn.style.display = e.target.value === 'multiple' ? 'block' : 'none';
                    }
                });
            });

            if (addAnotherLabelBtn) {
                addAnotherLabelBtn.addEventListener('click', () => {
                    addLabelEntry();
                });
            }

            if (submitCreateLabelBtn) {
                submitCreateLabelBtn.addEventListener('click', async () => {
                const accountId = document.getElementById('modalAccountId').value.trim();
                const token = document.getElementById('modalToken').value.trim();
                
                if (!accountId || !token) {
                    alert('Please fill in Account ID and Token');
                    return;
                }

                // Fetch Org Name from API using Account Group ID
                let orgName = accountId; // Default to accountId if API call fails
                try {
                    const base = USE_PROXY ? API_PROXY_BASE : API_BASE.replace(/\/$/, '');
                    if (token) {
                        const orgUrl = USE_PROXY 
                            ? `${base}/account-groups/${accountId}`
                            : `${base}/account-groups/${accountId}`;
                        const orgResp = await fetch(orgUrl, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/hal+json'
                            }
                        });
                        if (orgResp.ok) {
                            const orgData = await orgResp.json();
                            orgName = orgData.accountGroup?.name || orgData.name || accountId;
                        }
                    }
                } catch (err) {
                    console.warn('Could not fetch org name, using account ID:', err);
                    orgName = accountId;
                }

                const entries = Array.from(labelScheduleContainer.querySelectorAll('.label-entry'));
                const newEntries = [];

                entries.forEach(entryDiv => {
                    const labelInput = entryDiv.querySelector('input[type="text"]');
                    const enableToggle = entryDiv.querySelector('input[type="checkbox"]');
                    const fromInput = entryDiv.querySelectorAll('input[type="time"]')[0];
                    const toInput = entryDiv.querySelectorAll('input[type="time"]')[1];

                    const label = labelInput.value.trim();
                    const from = fromInput.value;
                    const to = toInput.value;

                    if (label && from && to) {
                        newEntries.push({
                            orgName: orgName,
                            accountGroup: accountId,
                            label: label,
                            from: from,
                            to: to,
                            action: enableToggle.checked ? 'enable' : 'disable',
                            token: token
                        });
                    }
                });

                if (newEntries.length === 0) {
                    alert('Please fill in at least one valid label entry');
                    return;
                }

                // Get existing entries and add new ones
                const existingEntries = readSchedulerEntries();
                const updatedEntries = currentEditEntry 
                    ? existingEntries.map(e => e.label === currentEditEntry.label ? newEntries[0] : e)
                    : [...existingEntries, ...newEntries];

                // Save to localStorage
                try {
                    const data = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    data.schedulerEntries = updatedEntries;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(data));
                } catch (err) {
                    console.error('Failed to save entries:', err);
                }

                renderSchedulerEntries(updatedEntries);
                save();
                resetSchedulerState();
                closeLabelModal();
                });
            }

            if (retrieveLabelBtn) {
                retrieveLabelBtn.addEventListener('click', () => {
                const accountId = document.getElementById('updateAccountId').value.trim();
                const transactionId = document.getElementById('updateTransactionId').value.trim();
                
                if (!accountId || !transactionId) {
                    alert('Please fill in Account ID and Transaction ID');
                    return;
                }

                // Find the entry by label (using transactionId as label identifier)
                const entries = readSchedulerEntries();
                const entry = entries.find(e => e.label === transactionId || e.accountGroup === accountId);
                
                if (entry) {
                    switchTab('create');
                    resetCreateForm();
                    addLabelEntry(entry);
                    document.getElementById('modalAccountId').value = entry.accountGroup || accountId;
                    document.getElementById('modalToken').value = ''; // Don't auto-fill token
                } else {
                    alert('Label not found');
                }
                });
            }

            // Initialize create form with one entry
            if (labelScheduleContainer) {
                // This will be called when modal opens
            }

            function getSchedulerFrequencyMs() {
                const freq = Number(schedulerFrequencyEl.value);
                const safe = isFinite(freq) && freq >= 15 ? freq : 60;
                return safe * 1000;
            }

            function logScheduler(message) {
                const timestamp = new Date().toISOString();
                schedulerLogEl.value += `[${timestamp}] ${message}\n`;
                schedulerLogEl.scrollTop = schedulerLogEl.scrollHeight;
            }

            function formatSnapshot(instructions) {
                const entries = Object.entries(instructions || {});
                if (!entries.length) return '‚Äì';
                return entries.map(([label, action]) => `${label}: ${action}`).join(', ');
            }

            function computeCurrentInstructions(entries) {
                const now = new Date();
                const minutes = now.getHours() * 60 + now.getMinutes();
                const instructions = {};
                for (const entry of entries) {
                    const fromM = timeToMinutes(entry.from);
                    const toM = timeToMinutes(entry.to);
                    if (!isFinite(fromM) || !isFinite(toM)) continue;
                    const wraps = toM <= fromM;
                    const inRange = wraps ? (minutes >= fromM || minutes < toM) : (minutes >= fromM && minutes < toM);
                    if (inRange && instructions[entry.label] === undefined) {
                        instructions[entry.label] = entry.action;
                    }
                }
                return instructions;
            }

            const lastSchedulerActions = new Map();
            function resetSchedulerState() {
                lastSchedulerActions.clear();
                schedulerSnapshotEl.textContent = '‚Äì';
            }

            async function updateEndpointState(label, action, token, accountGroupId, orgName) {
                if (dryRunEl.checked) {
                    await new Promise(resolve => setTimeout(resolve, 150));
                    return { dryRun: true, label, action };
                }
                const base = USE_PROXY ? API_PROXY_BASE : API_BASE.replace(/\/$/, '');
                const path = USE_PROXY ? '/v6/endpoint-agents/state' : ENDPOINT_STATE_ENDPOINT;
                if (!token) throw new Error('Missing API configuration');
                const url = `${base}${path}`;
                const body = {
                    label,
                    action,
                    accountGroupId: accountGroupId || undefined,
                    orgName: orgName || undefined
                };
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    throw new Error(`API ${resp.status}: ${text || resp.statusText}`);
                }
                return resp.json().catch(() => ({}));
            }

            let schedulerTimer = null;
            let schedulerTickInFlight = false;

            async function runScheduler() {
                if (schedulerTickInFlight) return;
                if (!schedulerEnabledEl.checked) {
                    schedulerSnapshotEl.textContent = '‚Äì';
                    return;
                }
                schedulerTickInFlight = true;
                try {
                    const entries = readSchedulerEntries();
                    const instructions = computeCurrentInstructions(entries);
                    schedulerSnapshotEl.textContent = formatSnapshot(instructions);
                    const labels = Object.keys(instructions);
                    if (!labels.length) {
                        schedulerTickInFlight = false;
                        return;
                    }
                    for (const label of labels) {
                        const action = instructions[label];
                        if (!action) continue;
                        if (lastSchedulerActions.get(label) === action) continue;
                        
                        // Find the entry for this label to get token and accountGroupId
                        const entry = entries.find(e => e.label === label && e.action === action);
                        if (!entry || !entry.token) {
                            logScheduler(`Skipping ${label}: missing token`);
                            continue;
                        }
                        
                        try {
                            await updateEndpointState(label, action, entry.token, entry.accountGroup, entry.orgName);
                            lastSchedulerActions.set(label, action);
                            logScheduler(`Set ${label} ‚Üí ${action} at ${new Date().toLocaleTimeString()}`);
                        } catch (err) {
                            logScheduler(`Error ${label}: ${err?.message || err}`);
                        }
                    }
                } finally {
                    schedulerTickInFlight = false;
                }
            }

            function restartSchedulerTimer() {
                if (schedulerTimer) clearInterval(schedulerTimer);
                schedulerTimer = setInterval(runScheduler, getSchedulerFrequencyMs());
            }

            schedulerEnabledEl.addEventListener('change', () => {
                save();
                resetSchedulerState();
                runScheduler();
            });

            schedulerFrequencyEl.addEventListener('change', () => {
                save();
                restartSchedulerTimer();
            });


            restartSchedulerTimer();
            runScheduler();

            compute();

            // ========== Cloud and App Synthetics Calculator ==========
            const agentTypeEl = document.getElementById('agentType');
            const testIntervalEl = document.getElementById('testInterval');
            const testTypeEl = document.getElementById('testType');
            const testTypeParamsEl = document.getElementById('testTypeParams');
            const unitsResultEl = document.getElementById('unitsResult');
            const monthlyUnitsResultEl = document.getElementById('monthlyUnitsResult');
            const calculationDisplayEl = document.getElementById('calculationDisplay');

            const MONTHLY_DAYS = 24 * 31; // 24 hrs * 31 days

            // Test type parameter configurations
            const testTypeConfigs = {
                'bgp': { params: [] },
                'network-agent-server': { params: [{ id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 }] },
                'network-agent-agent': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'twoWay', label: 'Two-way testing', type: 'checkbox', default: false }
                ]},
                'dns-server': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'numServers', label: 'Number of Servers', type: 'number', default: 1 }
                ]},
                'dns-trace': { params: [{ id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 }] },
                'http-server': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'timeout', label: 'Timeout (seconds)', type: 'number', default: 5 }
                ]},
                'page-load': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'pageLoadTimeout', label: 'Page Load Timeout (seconds)', type: 'number', default: 5 },
                    { id: 'pageLoadInterval', label: 'Page Load Interval (minutes)', type: 'number', default: 5 },
                    { id: 'httpTimeout', label: 'HTTP Timeout (seconds)', type: 'number', default: 5 },
                    { id: 'httpInterval', label: 'HTTP Interval (minutes)', type: 'number', default: 1 }
                ]},
                'transaction': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'timeout', label: 'Timeout (seconds)', type: 'number', default: 5 }
                ]},
                'sip-rtp': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'timeout', label: 'Timeout (seconds)', type: 'number', default: 5 }
                ]},
                'voice-calls': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'sipTimeout', label: 'SIP Timeout (seconds)', type: 'number', default: 5 },
                    { id: 'rtpTimeout', label: 'RTP Timeout (seconds)', type: 'number', default: 5 }
                ]}
            };

            function renderTestTypeParams() {
                const testType = testTypeEl.value;
                const config = testTypeConfigs[testType] || { params: [] };
                testTypeParamsEl.innerHTML = '';

                config.params.forEach(param => {
                    const control = document.createElement('div');
                    control.className = 'control';
                    const label = document.createElement('label');
                    label.setAttribute('for', param.id);
                    label.textContent = param.label;
                    control.appendChild(label);

                    if (param.type === 'checkbox') {
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = param.id;
                        input.name = param.id;
                        input.checked = param.default || false;
                        input.addEventListener('change', calculateSynthetics);
                        control.appendChild(input);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = param.id;
                        input.name = param.id;
                        input.min = '1';
                        input.step = param.id.includes('Timeout') || param.id.includes('Interval') ? '1' : '1';
                        input.value = param.default || '1';
                        input.addEventListener('input', calculateSynthetics);
                        control.appendChild(input);
                    }

                    testTypeParamsEl.appendChild(control);
                });
                calculateSynthetics();
            }

            function calculateSynthetics() {
                const agentType = agentTypeEl.value;
                const interval = parseFloat(testIntervalEl.value) || 1;
                const testType = testTypeEl.value;
                const isCloud = agentType === 'cloud';
                const multiplier = isCloud ? 2 : 1;

                let units = 0;
                const config = testTypeConfigs[testType] || { params: [] };

                // Get parameter values
                const params = {};
                config.params.forEach(param => {
                    const el = document.getElementById(param.id);
                    if (el) {
                        if (param.type === 'checkbox') {
                            params[param.id] = el.checked;
                        } else {
                            params[param.id] = parseFloat(el.value) || param.default || 1;
                        }
                    }
                });

                // Calculate based on test type
                // Formula: (60/interval) * 24 * 31 for interval-based calculations
                switch(testType) {
                    case 'bgp':
                        units = 8 * ((60 / 15) * MONTHLY_DAYS);
                        break;
                    case 'network-agent-server':
                        units = 5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'network-agent-agent':
                        const agentCount = params.twoWay ? (params.numAgents || 1) * 2 : (params.numAgents || 1);
                        units = 5 * ((60 / interval) * MONTHLY_DAYS) * agentCount;
                        break;
                    case 'dns-server':
                        units = 5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1) * (params.numServers || 1);
                        break;
                    case 'dns-trace':
                        units = 5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'http-server':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'page-load':
                        const pageLoadTimeout = params.pageLoadTimeout || 5;
                        const pageLoadInterval = params.pageLoadInterval || 5;
                        const httpTimeout = params.httpTimeout || 5;
                        const httpInterval = params.httpInterval || 1;
                        const part1 = pageLoadTimeout / pageLoadInterval;
                        const part2 = httpTimeout * ((1 / httpInterval) - (1 / pageLoadInterval));
                        // Page Load formula: multiply by 60 mins * 24 hrs * 31 days (44,640 minutes in a month)
                        const monthlyMinutes = 60 * 24 * 31; // 60 mins * 24 hrs * 31 days
                        units = (part1 + part2) * monthlyMinutes * (params.numAgents || 1);
                        break;
                    case 'transaction':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'sip-rtp':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'voice-calls':
                        const sipTimeout = params.sipTimeout || 5;
                        const rtpTimeout = params.rtpTimeout || 5;
                        units = (sipTimeout + rtpTimeout) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                }

                // Store base units (this is C - Cloud units, the standard)
                const cloudUnits = units;
                
                // Calculate E (Enterprise units) = C / 2
                const enterpriseUnits = cloudUnits / 2;

                // Apply agent type multiplier: use Cloud units for cloud, Enterprise units for enterprise
                if (isCloud) {
                    units = cloudUnits;
                } else {
                    units = enterpriseUnits;
                }

                // Build calculation breakdown
                let calcBreakdown = '';
                const intervalCalc = `(60 / ${interval}) * 24 * 31`;
                const intervalValue = (60 / interval) * MONTHLY_DAYS;
                
                switch(testType) {
                    case 'bgp':
                        calcBreakdown = `C = 8 units * (60 mins * 24 hrs * 31 days) / 15 mins\n`;
                        calcBreakdown += `C = 8 * ((60 / 15) * 24 * 31)\n`;
                        calcBreakdown += `C = 8 * ${((60 / 15) * MONTHLY_DAYS).toFixed(2)}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'network-agent-server':
                        calcBreakdown = `C = 5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = 5 * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = 5 * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'network-agent-agent':
                        const agentCount = params.twoWay ? (params.numAgents || 1) * 2 : (params.numAgents || 1);
                        const twoWayNote = params.twoWay ? ` (two-way: ${params.numAgents || 1} * 2)` : '';
                        calcBreakdown = `C = 5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${agentCount} agents${twoWayNote}\n`;
                        calcBreakdown += `C = 5 * ${intervalCalc} * ${agentCount}\n`;
                        calcBreakdown += `C = 5 * ${intervalValue.toFixed(2)} * ${agentCount}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'dns-server':
                        calcBreakdown = `C = 5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents * ${params.numServers || 1} servers\n`;
                        calcBreakdown += `C = 5 * ${intervalCalc} * ${params.numAgents || 1} * ${params.numServers || 1}\n`;
                        calcBreakdown += `C = 5 * ${intervalValue.toFixed(2)} * ${params.numAgents || 1} * ${params.numServers || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'dns-trace':
                        calcBreakdown = `C = 5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = 5 * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = 5 * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'http-server':
                        const timeout = params.timeout || 5;
                        calcBreakdown = `C = timeout (secs) * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = ${timeout} * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${timeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'page-load':
                        const pageLoadTimeout = params.pageLoadTimeout || 5;
                        const pageLoadInterval = params.pageLoadInterval || 5;
                        const httpTimeout = params.httpTimeout || 5;
                        const httpInterval = params.httpInterval || 1;
                        const part1 = pageLoadTimeout / pageLoadInterval;
                        const part2 = httpTimeout * ((1 / httpInterval) - (1 / pageLoadInterval));
                        const monthlyMinutes = 60 * 24 * 31; // 60 mins * 24 hrs * 31 days
                        calcBreakdown = `C = ((page load timeout (secs) / page load interval (mins)) + (HTTP timeout (secs) * (1 / HTTP interval (mins) - 1 / page load interval (mins)))) * 60 mins * 24 hrs * 31 days * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = ((${pageLoadTimeout} / ${pageLoadInterval}) + (${httpTimeout} * (1/${httpInterval} - 1/${pageLoadInterval}))) * 60 * 24 * 31 * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = (${part1.toFixed(2)} + ${part2.toFixed(2)}) * ${monthlyMinutes} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'transaction':
                        const transTimeout = params.timeout || 5;
                        calcBreakdown = `C = timeout * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = ${transTimeout} * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${transTimeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'sip-rtp':
                        const sipRtpTimeout = params.timeout || 5;
                        calcBreakdown = `C = timeout * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = ${sipRtpTimeout} * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${sipRtpTimeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                    case 'voice-calls':
                        const sipTimeout = params.sipTimeout || 5;
                        const rtpTimeout = params.rtpTimeout || 5;
                        const totalTimeout = sipTimeout + rtpTimeout;
                        calcBreakdown = `C = (SIP timeout + RTP timeout) * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = (${sipTimeout} + ${rtpTimeout}) * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${totalTimeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${cloudUnits.toFixed(2)}\n\n`;
                        calcBreakdown += `E = C / 2\n`;
                        calcBreakdown += `E = ${cloudUnits.toFixed(2)} / 2\n`;
                        calcBreakdown += `E = ${enterpriseUnits.toFixed(2)}`;
                        break;
                }

                // Add final result based on agent type
                if (isCloud) {
                    calcBreakdown += `\n\nCloud agent selected: C = ${cloudUnits.toFixed(2)} units`;
                } else {
                    calcBreakdown += `\n\nEnterprise agent selected: E = ${enterpriseUnits.toFixed(2)} units`;
                }

                // Display results
                unitsResultEl.textContent = Math.round(units).toLocaleString();
                monthlyUnitsResultEl.textContent = Math.round(units).toLocaleString();
                calculationDisplayEl.textContent = calcBreakdown;
            }

            // ========== Configuration List Management ==========
            const addToConfigListBtn = document.getElementById('addToConfigList');
            const clearConfigListBtn = document.getElementById('clearConfigList');
            const configListEl = document.getElementById('configList');
            const totalUnitsDisplayEl = document.getElementById('totalUnitsDisplay');
            const totalCostDisplayEl = document.getElementById('totalCostDisplay');
            const contractDurationEl = document.getElementById('contractDuration');
            // Use unified currency selector for synthetics
            const syntheticsCurrencyEl = unifiedCurrencyEl;
            const syntheticsCurrencyTagValue = document.getElementById('syntheticsCurrencyTagValue');
            const syntheticsFetchRatesBtn = unifiedFetchRatesBtn;
            const UNIT_COST_USD = 0.85; // Cost per unit per month in USD
            let configList = [];
            
            // Get current unit cost based on selected currency
            function getUnitCost() {
                const currency = (syntheticsCurrencyEl?.value || 'USD').toUpperCase();
                if (currency === 'USD') {
                    return UNIT_COST_USD;
                }
                // Try to get exchange rate from cache
                try {
                    const CACHE_KEY = `teExchangeRates_USD`;
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.rates[currency]) {
                        return UNIT_COST_USD * cached.rates[currency];
                    }
                } catch {}
                return UNIT_COST_USD; // Fallback to USD if no rate available
            }

            // Load saved configurations
            function loadConfigList() {
                try {
                    const saved = localStorage.getItem('teSyntheticsConfigs');
                    if (saved) {
                        configList = JSON.parse(saved);
                        // Migrate old configs that might have originalUnits or unrounded units
                        configList = configList.map(config => {
                            if (config.originalUnits !== undefined) {
                                // Already migrated
                                return config;
                            } else if (config.units > 1000) {
                                // Old format - likely has unrounded units, migrate it
                                const roundedUnits = Math.ceil(config.units / 1000);
                                return {
                                    ...config,
                                    originalUnits: config.units,
                                    units: roundedUnits
                                };
                            }
                            // Assume it's already rounded (for new configs)
                            return config;
                        });
                        saveConfigList(); // Save migrated configs
                        renderConfigList();
                    }
                } catch (e) {
                    console.error('Failed to load config list:', e);
                }
            }

            // Save configurations
            function saveConfigList() {
                try {
                    localStorage.setItem('teSyntheticsConfigs', JSON.stringify(configList));
                } catch (e) {
                    console.error('Failed to save config list:', e);
                }
            }

            // Get current configuration
            function getCurrentConfig() {
                const agentType = agentTypeEl.value;
                const interval = parseFloat(testIntervalEl.value) || 1;
                const testType = testTypeEl.value;
                const params = {};
                
                // Get all parameter values
                const config = testTypeConfigs[testType] || { params: [] };
                config.params.forEach(param => {
                    const el = document.getElementById(param.id);
                    if (el) {
                        if (param.type === 'checkbox') {
                            params[param.id] = el.checked;
                        } else {
                            params[param.id] = parseFloat(el.value) || param.default || 1;
                        }
                    }
                });

                // Calculate units for this config
                const isCloud = agentType === 'cloud';
                let cloudUnits = 0;

                switch(testType) {
                    case 'bgp':
                        cloudUnits = 8 * ((60 / 15) * MONTHLY_DAYS);
                        break;
                    case 'network-agent-server':
                        cloudUnits = 5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'network-agent-agent':
                        const agentCount = params.twoWay ? (params.numAgents || 1) * 2 : (params.numAgents || 1);
                        cloudUnits = 5 * ((60 / interval) * MONTHLY_DAYS) * agentCount;
                        break;
                    case 'dns-server':
                        cloudUnits = 5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1) * (params.numServers || 1);
                        break;
                    case 'dns-trace':
                        cloudUnits = 5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'http-server':
                        cloudUnits = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'page-load':
                        const pageLoadTimeout = params.pageLoadTimeout || 5;
                        const pageLoadInterval = params.pageLoadInterval || 5;
                        const httpTimeout = params.httpTimeout || 5;
                        const httpInterval = params.httpInterval || 1;
                        const part1 = pageLoadTimeout / pageLoadInterval;
                        const part2 = httpTimeout * ((1 / httpInterval) - (1 / pageLoadInterval));
                        // Page Load formula: multiply by 60 mins * 24 hrs * 31 days (44,640 minutes in a month)
                        const monthlyMinutes = 60 * 24 * 31; // 60 mins * 24 hrs * 31 days
                        cloudUnits = (part1 + part2) * monthlyMinutes * (params.numAgents || 1);
                        break;
                    case 'transaction':
                        cloudUnits = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'sip-rtp':
                        cloudUnits = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'voice-calls':
                        const sipTimeout = params.sipTimeout || 5;
                        const rtpTimeout = params.rtpTimeout || 5;
                        cloudUnits = (sipTimeout + rtpTimeout) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                }
                // Calculate E (Enterprise units) = C / 2
                const enterpriseUnits = cloudUnits / 2;
                // Apply agent type: use Cloud units for cloud, Enterprise units for enterprise
                const units = isCloud ? cloudUnits : enterpriseUnits;

                // Divide by 1000 and round up
                const roundedUnits = Math.ceil(units / 1000);

                return {
                    id: Date.now(),
                    agentType,
                    interval,
                    testType,
                    params,
                    units: roundedUnits,
                    originalUnits: Math.round(units) // Keep original for reference if needed
                };
            }

            // Get test type display name
            function getTestTypeName(testType) {
                const names = {
                    'bgp': 'BGP Routing',
                    'network-agent-server': 'Network, Agent to Server',
                    'network-agent-agent': 'Network, Agent to Agent',
                    'dns-server': 'DNS Server',
                    'dns-trace': 'DNS Trace, DNSSEC',
                    'http-server': 'HTTP Server',
                    'page-load': 'Page Load',
                    'transaction': 'Transaction',
                    'sip-rtp': 'SIP Server, RTP Stream',
                    'voice-calls': 'Voice Calls'
                };
                return names[testType] || testType;
            }

            // Format configuration summary
            function formatConfigSummary(config) {
                let summary = `${getTestTypeName(config.testType)} - ${config.agentType === 'cloud' ? 'Cloud' : 'Enterprise'}`;
                summary += ` - ${config.interval} min interval`;
                
                if (config.params.numAgents) {
                    summary += ` - ${config.params.numAgents} agent${config.params.numAgents > 1 ? 's' : ''}`;
                }
                if (config.params.numServers) {
                    summary += ` - ${config.params.numServers} server${config.params.numServers > 1 ? 's' : ''}`;
                }
                if (config.params.twoWay) {
                    summary += ' - Two-way';
                }
                if (config.params.timeout) {
                    summary += ` - ${config.params.timeout}s timeout`;
                }
                if (config.params.sipTimeout && config.params.rtpTimeout) {
                    summary += ` - SIP:${config.params.sipTimeout}s, RTP:${config.params.rtpTimeout}s`;
                }
                
                return summary;
            }

            // Format currency
            function formatCurrency(amount) {
                const currency = (syntheticsCurrencyEl?.value || 'USD').toUpperCase();
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }

            // Render configuration list
            function renderConfigList() {
                if (configList.length === 0) {
                    configListEl.innerHTML = `
                        <div style="text-align:center; padding:40px; color:var(--muted); font-size:14px;">
                            No configurations added yet. Configure a test above and click "Add to Configuration List".
                        </div>
                    `;
                    totalUnitsDisplayEl.textContent = '0';
                    const contractMonths = parseInt(contractDurationEl.value) || 12;
                    const contractYears = contractMonths / 12;
                    const costText = contractYears === 1 ? 'Total Cost (1 Year):' : 
                                    contractYears === 3 ? 'Total Cost (3 Years):' : 
                                    'Total Cost (5 Years):';
                    const totalCostLabelEl = document.getElementById('totalCostLabel');
                    if (totalCostLabelEl) {
                        totalCostLabelEl.textContent = costText;
                    }
                    totalCostDisplayEl.textContent = '$0.00';
                    return;
                }

                let html = '<table style="width:100%; border-collapse:collapse;">';
                html += '<thead><tr style="border-bottom:1px solid var(--border);">';
                html += '<th style="text-align:left; padding:8px; font-size:13px; color:var(--muted); font-weight:500;">Configuration</th>';
                html += '<th style="text-align:right; padding:8px; font-size:13px; color:var(--muted); font-weight:500;">Units (√ó1000)</th>';
                html += '<th style="text-align:right; padding:8px; font-size:13px; color:var(--muted); font-weight:500;">Cost/Month</th>';
                html += '<th style="width:60px; padding:8px;"></th>';
                html += '</tr></thead><tbody>';

                const contractMonths = parseInt(contractDurationEl.value) || 12;
                const contractYears = contractMonths / 12;
                
                // Sum original units, then divide by 1000 and round up
                const unitCost = getUnitCost();
                let totalOriginalUnits = 0;
                let totalCost = 0;
                configList.forEach((config, index) => {
                    const monthlyCost = config.units * unitCost;
                    const totalCostForConfig = monthlyCost * contractMonths;
                    // Sum original units for total calculation
                    totalOriginalUnits += (config.originalUnits || config.units * 1000);
                    totalCost += totalCostForConfig;
                    html += '<tr style="border-bottom:1px solid var(--border);">';
                    html += `<td style="padding:12px 8px; font-size:13px; color:var(--text);">${formatConfigSummary(config)}</td>`;
                    html += `<td style="text-align:right; padding:12px 8px; font-size:13px; color:var(--text); font-weight:500;">${config.units.toLocaleString()}</td>`;
                    html += `<td style="text-align:right; padding:12px 8px; font-size:13px; color:var(--text); font-weight:500;">${formatCurrency(monthlyCost)}</td>`;
                    html += `<td style="text-align:center; padding:12px 8px;">`;
                    html += `<button type="button" class="remove-config-btn" data-index="${index}" style="padding:4px 8px; border-radius:4px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:11px;">Remove</button>`;
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                configListEl.innerHTML = html;

                // Add event listeners to remove buttons
                configListEl.querySelectorAll('.remove-config-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        configList.splice(index, 1);
                        saveConfigList();
                        renderConfigList();
                    });
                });

                // Calculate total units: sum original units, divide by 1000, round up
                const totalRoundedUnits = Math.ceil(totalOriginalUnits / 1000);
                totalUnitsDisplayEl.textContent = totalRoundedUnits.toLocaleString();
                
                // Update total cost label and display
                const totalCostLabelEl = document.getElementById('totalCostLabel');
                const costText = contractYears === 1 ? 'Total Cost (1 Year):' : 
                                contractYears === 3 ? 'Total Cost (3 Years):' : 
                                'Total Cost (5 Years):';
                if (totalCostLabelEl) {
                    totalCostLabelEl.textContent = costText;
                }
                totalCostDisplayEl.textContent = formatCurrency(totalCost);
            }

            // Add current configuration to list
            addToConfigListBtn.addEventListener('click', () => {
                const config = getCurrentConfig();
                configList.push(config);
                saveConfigList();
                renderConfigList();
            });

            // Clear all configurations
            clearConfigListBtn.addEventListener('click', () => {
                if (configList.length > 0 && confirm('Are you sure you want to clear all configurations?')) {
                    configList = [];
                    saveConfigList();
                    renderConfigList();
                }
            });

            // Create CCW Estimate button
            const createCCWEstimateBtn = document.getElementById('createCCWEstimate');
            if (createCCWEstimateBtn) {
                createCCWEstimateBtn.addEventListener('click', () => {
                    // Mockup: Show alert with Bill of Materials summary, then open CCW
                    const contractMonths = parseInt(contractDurationEl.value) || 12;
                    const contractYears = contractMonths / 12;
                    
                    const unitCost = getUnitCost();
                    let totalOriginalUnits = 0;
                    let totalCost = 0;
                    configList.forEach(config => {
                        const monthlyCost = config.units * unitCost;
                        const totalCostForConfig = monthlyCost * contractMonths;
                        totalOriginalUnits += (config.originalUnits || config.units * 1000);
                        totalCost += totalCostForConfig;
                    });
                    
                    const totalRoundedUnits = Math.ceil(totalOriginalUnits / 1000);
                    
                    const bomSummary = `Bill of Materials Summary:\n\n` +
                        `Total Configurations: ${configList.length}\n` +
                        `Total Units (√ó1000): ${totalRoundedUnits.toLocaleString()}\n` +
                        `Contract Duration: ${contractYears} Year${contractYears > 1 ? 's' : ''}\n` +
                        `Total Cost: ${formatCurrency(totalCost)}\n\n` +
                        `Opening CCW (Cisco Commerce Workspace)...`;
                    
                    // Show summary alert (mockup)
                    alert(bomSummary);
                    
                    // Open CCW in new tab
                    window.open('http://cisco.com/go/ccw', '_blank');
                });
            }

            // Update cost when contract duration changes
            contractDurationEl.addEventListener('change', () => {
                renderConfigList();
            });

            // Exchange rates and currency changes are handled by the unified handlers above

            // Currency is initialized by the unified handler below

            // Event listeners
            agentTypeEl.addEventListener('change', calculateSynthetics);
            testIntervalEl.addEventListener('change', calculateSynthetics);
            testTypeEl.addEventListener('change', () => {
                renderTestTypeParams();
            });

            // Initialize
            renderTestTypeParams();
            loadConfigList();

            // Flow Calculator
            const dailyFlowsEl = document.getElementById('dailyFlows');
            const flowUnitCostEl = document.getElementById('flowUnitCost');
            const flowVpcCountEl = document.getElementById('flowVpcCount');
            const flowTrafficGBEl = document.getElementById('flowTrafficGB');
            const flowLogRetentionEl = document.getElementById('flowLogRetention');
            const flowMethodResultEl = document.getElementById('flowMethodResult');
            const flowFPSResultEl = document.getElementById('flowFPSResult');
            const flowUnitsResultEl = document.getElementById('flowUnitsResult');
            const flowMonthlyCostResultEl = document.getElementById('flowMonthlyCostResult');
            const flowYearlyCostResultEl = document.getElementById('flowYearlyCostResult');

            // AWS Cost Calculator
            const awsFlowLogGBEl = document.getElementById('awsFlowLogGB');
            const awsS3StorageGBEl = document.getElementById('awsS3StorageGB');
            const awsPutRequestsEl = document.getElementById('awsPutRequests');
            const awsSNSRequestsEl = document.getElementById('awsSNSRequests');
            const awsDataTransferGBEl = document.getElementById('awsDataTransferGB');
            const awsFlowLogCostEl = document.getElementById('awsFlowLogCost');
            const awsS3StorageCostEl = document.getElementById('awsS3StorageCost');
            const awsPutCostEl = document.getElementById('awsPutCost');
            const awsSNSCostEl = document.getElementById('awsSNSCost');
            const awsTransferCostEl = document.getElementById('awsTransferCost');
            const awsTotalCostEl = document.getElementById('awsTotalCost');

            // AWS Pricing constants (based on standard AWS pricing)
            const AWS_FLOW_LOG_CAPTURE_PER_GB = 0.50;
            const AWS_S3_STORAGE_PER_GB = 0.023;
            const AWS_S3_PUT_PER_1000 = 0.005;
            const AWS_SNS_PER_MILLION = 0.50;
            const AWS_DATA_TRANSFER_PER_GB = 0.09;

            // Format currency for flow calculator
            function formatFlowCurrency(amount) {
                const currency = (unifiedCurrencyEl?.value || 'USD').toUpperCase();
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }

            // Get flow unit cost in selected currency
            function getFlowUnitCost() {
                const baseUnitCost = parseFloat(flowUnitCostEl?.value) || 0.85; // Base cost in USD
                const currency = (unifiedCurrencyEl?.value || 'USD').toUpperCase();
                if (currency === 'USD') {
                    return baseUnitCost;
                }
                // Try to get exchange rate from cache
                try {
                    const CACHE_KEY = `teExchangeRates_USD`;
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.rates[currency]) {
                        return baseUnitCost * cached.rates[currency];
                    }
                } catch {}
                return baseUnitCost; // Fallback to USD if no rate available
            }

            function calculateFlowUnits() {
                if (!dailyFlowsEl || !flowUnitCostEl) return;

                const dailyFlows = parseFloat(dailyFlowsEl.value) || 0;
                const unitCost = getFlowUnitCost();
                const vpcCount = parseFloat(flowVpcCountEl?.value) || 0;
                const trafficGB = parseFloat(flowTrafficGBEl?.value) || 0;
                const retention = parseFloat(flowLogRetentionEl?.value) || 1;

                let units = 0;
                let fps = 0;
                let method = '';

                // Use Daily Flow Estimate if daily flows > 0, otherwise use Cloud Size Estimate
                if (dailyFlows > 0) {
                    method = 'Daily Flow Estimate';
                    // Calculate Flows Per Second (FPS)
                    // Daily flows / (24 hours * 60 minutes * 60 seconds) = daily flows / 86400
                    fps = dailyFlows / 86400;
                    
                    // Calculate units: 240 units per 1000 FPS
                    // Formula: (FPS / 1000) * 240
                    units = (fps / 1000) * 240;
                } else if (vpcCount > 0 && trafficGB > 0) {
                    method = 'Cloud Size Estimate';
                    // Flow units calculation: Based on VPCs, traffic volume, and retention
                    const baseUnits = vpcCount * (trafficGB / 100); // Base units from VPCs and traffic
                    const retentionMultiplier = 1 + (retention - 1) * 0.1; // Slight increase for retention
                    units = Math.ceil(baseUnits * retentionMultiplier);
                } else {
                    // No valid input
                    if (flowMethodResultEl) flowMethodResultEl.textContent = '‚Äì';
                    if (flowFPSResultEl) flowFPSResultEl.textContent = '‚Äì';
                    if (flowUnitsResultEl) flowUnitsResultEl.textContent = '‚Äì';
                    if (flowMonthlyCostResultEl) flowMonthlyCostResultEl.textContent = '‚Äì';
                    if (flowYearlyCostResultEl) flowYearlyCostResultEl.textContent = '‚Äì';
                    return;
                }

                // Calculate costs
                const monthlyCost = units * unitCost;
                const yearlyCost = monthlyCost * 12;

                // Update display
                if (flowMethodResultEl) {
                    flowMethodResultEl.textContent = method;
                }
                if (flowFPSResultEl) {
                    if (method === 'Daily Flow Estimate') {
                        flowFPSResultEl.textContent = fps.toFixed(2) + ' FPS';
                    } else {
                        flowFPSResultEl.textContent = 'N/A';
                    }
                }
                if (flowUnitsResultEl) {
                    flowUnitsResultEl.textContent = units.toFixed(2) + ' units';
                }
                if (flowMonthlyCostResultEl) {
                    flowMonthlyCostResultEl.textContent = formatFlowCurrency(monthlyCost);
                }
                if (flowYearlyCostResultEl) {
                    flowYearlyCostResultEl.textContent = formatFlowCurrency(yearlyCost);
                }
            }

            // Get AWS costs in selected currency
            function getAWSCostInCurrency(usdAmount) {
                const currency = (unifiedCurrencyEl?.value || 'USD').toUpperCase();
                if (currency === 'USD') {
                    return usdAmount;
                }
                // Try to get exchange rate from cache
                try {
                    const CACHE_KEY = `teExchangeRates_USD`;
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.rates[currency]) {
                        return usdAmount * cached.rates[currency];
                    }
                } catch {}
                return usdAmount; // Fallback to USD if no rate available
            }

            function calculateAWSCosts() {
                if (!awsFlowLogGBEl || !awsS3StorageGBEl || !awsPutRequestsEl || 
                    !awsSNSRequestsEl || !awsDataTransferGBEl) return;

                const flowLogGB = parseFloat(awsFlowLogGBEl.value) || 0;
                const s3StorageGB = parseFloat(awsS3StorageGBEl.value) || 0;
                const putRequests = parseFloat(awsPutRequestsEl.value) || 0;
                const snsRequests = parseFloat(awsSNSRequestsEl.value) || 0;
                const dataTransferGB = parseFloat(awsDataTransferGBEl.value) || 0;

                // Calculate individual costs in USD
                const flowLogCostUSD = flowLogGB * AWS_FLOW_LOG_CAPTURE_PER_GB;
                const s3StorageCostUSD = s3StorageGB * AWS_S3_STORAGE_PER_GB;
                const putCostUSD = putRequests * AWS_S3_PUT_PER_1000;
                const snsCostUSD = snsRequests * AWS_SNS_PER_MILLION;
                const transferCostUSD = dataTransferGB * AWS_DATA_TRANSFER_PER_GB;

                const totalCostUSD = flowLogCostUSD + s3StorageCostUSD + putCostUSD + snsCostUSD + transferCostUSD;

                // Convert to selected currency
                const flowLogCost = getAWSCostInCurrency(flowLogCostUSD);
                const s3StorageCost = getAWSCostInCurrency(s3StorageCostUSD);
                const putCost = getAWSCostInCurrency(putCostUSD);
                const snsCost = getAWSCostInCurrency(snsCostUSD);
                const transferCost = getAWSCostInCurrency(transferCostUSD);
                const totalCost = getAWSCostInCurrency(totalCostUSD);

                // Update display
                if (awsFlowLogCostEl) awsFlowLogCostEl.textContent = formatFlowCurrency(flowLogCost);
                if (awsS3StorageCostEl) awsS3StorageCostEl.textContent = formatFlowCurrency(s3StorageCost);
                if (awsPutCostEl) awsPutCostEl.textContent = formatFlowCurrency(putCost);
                if (awsSNSCostEl) awsSNSCostEl.textContent = formatFlowCurrency(snsCost);
                if (awsTransferCostEl) awsTransferCostEl.textContent = formatFlowCurrency(transferCost);
                if (awsTotalCostEl) awsTotalCostEl.textContent = formatFlowCurrency(totalCost);
            }

            // Add event listeners for flow calculator
            if (dailyFlowsEl) dailyFlowsEl.addEventListener('input', calculateFlowUnits);
            if (flowUnitCostEl) flowUnitCostEl.addEventListener('input', calculateFlowUnits);
            if (flowVpcCountEl) flowVpcCountEl.addEventListener('input', calculateFlowUnits);
            if (flowTrafficGBEl) flowTrafficGBEl.addEventListener('input', calculateFlowUnits);
            if (flowLogRetentionEl) flowLogRetentionEl.addEventListener('input', calculateFlowUnits);

            // Add event listeners for AWS cost calculator
            if (awsFlowLogGBEl) awsFlowLogGBEl.addEventListener('input', calculateAWSCosts);
            if (awsS3StorageGBEl) awsS3StorageGBEl.addEventListener('input', calculateAWSCosts);
            if (awsPutRequestsEl) awsPutRequestsEl.addEventListener('input', calculateAWSCosts);
            if (awsSNSRequestsEl) awsSNSRequestsEl.addEventListener('input', calculateAWSCosts);
            if (awsDataTransferGBEl) awsDataTransferGBEl.addEventListener('input', calculateAWSCosts);

            // Initialize calculations
            calculateFlowUnits();
            calculateAWSCosts();

            // Integration Guide Modal handlers
            const viewIntegrationGuideBtn = document.getElementById('viewIntegrationGuide');
            const integrationGuideModal = document.getElementById('integrationGuideModal');
            const closeIntegrationGuideBtn = document.getElementById('closeIntegrationGuide');

            if (viewIntegrationGuideBtn && integrationGuideModal) {
                viewIntegrationGuideBtn.addEventListener('click', () => {
                    integrationGuideModal.style.display = 'block';
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                });
            }

            if (closeIntegrationGuideBtn && integrationGuideModal) {
                closeIntegrationGuideBtn.addEventListener('click', () => {
                    integrationGuideModal.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling
                });
            }

            // Close modal when clicking outside of it
            if (integrationGuideModal) {
                integrationGuideModal.addEventListener('click', (e) => {
                    if (e.target === integrationGuideModal) {
                        integrationGuideModal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && integrationGuideModal && integrationGuideModal.style.display === 'block') {
                    integrationGuideModal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });
        })();
    </script>

    <!-- Jotform Chatbot Integration -->
    <script src='https://cdn.jotfor.ms/agent/embedjs/0195f27e6f707272a077e5c889a970d6564e/embed.js'></script>
</body>
</html>


