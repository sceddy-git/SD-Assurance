<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ThousandEyes Endpoint Agents Budget Calculator and Operational Enablement</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0b0c10;
            --panel: #15161a;
            --text: #e8ecef;
            --muted: #9aa4ad;
            --accent: #2ea8ff;
            --accent-2: #7bd389;
            --border: #24262c;
            --danger: #ef476f;
        }

        :root[data-theme="light"] {
            --bg: #f5f7fa;
            --panel: #ffffff;
            --text: #1a1d29;
            --muted: #6b7280;
            --accent: #0066cc;
            --accent-2: #059669;
            --border: #e5e7eb;
            --danger: #dc2626;
        }

        :root[data-theme="light"] body {
            background: linear-gradient(180deg, #f5f7fa 0%, #e8ecef 100%);
        }

        :root[data-theme="light"] .container {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        :root[data-theme="light"] input[type="number"],
        :root[data-theme="light"] input[type="text"],
        :root[data-theme="light"] select {
            background: #ffffff;
            border-color: #d1d5db;
            color: var(--text);
        }

        :root[data-theme="light"] .panel {
            background: #f9fafb;
        }

        :root[data-theme="light"] .result {
            background: #ffffff;
        }

        :root[data-theme="light"] .tag {
            background: #f3f4f6;
            border-color: #e5e7eb;
        }

        :root[data-theme="light"] button {
            background: var(--panel);
        }

        :root[data-theme="light"] button:hover {
            background: #f3f4f6;
        }

        :root[data-theme="light"] .sidebar {
            background: #f9fafb;
        }

        :root[data-theme="light"] .sidebar-nav button.active {
            background: var(--accent);
            color: white;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            background: linear-gradient(180deg, #0b0c10 0%, #0f1117 100%);
            color: var(--text);
            min-height: 100svh;
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 0;
        }

        .sidebar {
            background: color-mix(in oklab, var(--panel) 96%, black 4%);
            border-right: 1px solid var(--border);
            padding: 20px;
            min-height: 100vh;
            position: sticky;
            top: 0;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 16px;
            margin: 0 0 16px 0;
            color: var(--text);
            font-weight: 600;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-nav button {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--muted);
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .sidebar-nav button:hover {
            background: color-mix(in oklab, var(--panel) 90%, black 10%);
            color: var(--text);
        }

        .sidebar-nav button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .main-content {
            padding: 24px;
            overflow-y: auto;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        .container {
            width: 100%;
            max-width: 880px;
            background: color-mix(in oklab, var(--panel) 92%, black 8%);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 4px 4px 16px 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            letter-spacing: 0.2px;
        }

        .subtle {
            color: var(--muted);
            font-size: 13px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 760px) {
            .grid {
                grid-template-columns: 1.2fr 1fr;
            }
        }

        .panel {
            background: color-mix(in oklab, var(--panel) 94%, black 6%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .row-1 { display: grid; grid-template-columns: 1fr; gap: 12px; }

        label { font-size: 13px; color: var(--muted); }
        .control { display: grid; gap: 6px; }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 12px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0f1117;
            color: var(--text);
            outline: none;
        }
        input::placeholder { color: #6b7280; }
        select { cursor: pointer; }

        .hint { font-size: 12px; color: var(--muted); }

        .results {
            display: grid;
            gap: 12px;
        }

        .result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #0f1218;
        }

        .result h3 { margin: 0; font-size: 14px; font-weight: 600; color: var(--muted); }
        .result .value { font-size: 28px; font-weight: 700; letter-spacing: 0.4px; }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
            background: #0f1218;
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 999px;
        }

        footer { margin-top: 8px; color: var(--muted); font-size: 12px; text-align: right; }
        .danger { color: var(--danger); }
        .ok { color: var(--accent-2); }
        .accent { color: var(--accent); }

        .stack { display: grid; gap: 10px; }
        .stack-lg { display: grid; gap: 16px; }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        #configList table {
            width: 100%;
            border-collapse: collapse;
        }

        #configList table tbody tr:hover {
            background: color-mix(in oklab, var(--panel) 95%, black 5%);
        }

        #configList table th,
        #configList table td {
            padding: 12px 8px;
        }

        #configList table th {
            font-size: 13px;
            color: var(--muted);
            font-weight: 500;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        #configList table th:last-child {
            text-align: center;
            width: 60px;
        }

        #configList table td {
            font-size: 13px;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }

        #configList table td:last-child {
            text-align: center;
        }

        .remove-config-btn:hover {
            background: color-mix(in oklab, var(--panel) 90%, black 10%) !important;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <h2>ThousandEyes</h2>
        <nav class="sidebar-nav">
            <button class="nav-btn active" data-page="endpoint">Endpoint Experience</button>
            <button class="nav-btn" data-page="synthetics">Cloud and App Synthetics</button>
        </nav>
    </aside>
    <div class="main-content">
        <div id="page-endpoint" class="page-content">
            <main class="container" role="main">
        <header>
            <div>
                <h1>ThousandEyes Endpoint Agents Budget Calculator and Operational Enablement</h1>
                <div class="subtle">Enter your budget and per‚Äëagent costs to estimate how many Endpoint Agents you can purchase for Advantage and Essentials.</div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="tag" aria-live="polite" id="currencyTag">Currency: <strong class="accent" id="currencyTagValue">USD</strong></div>
                <button id="themeToggle" type="button" style="padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;" title="Toggle light/dark mode">üåô</button>
            </div>
        </header>

        <nav style="display:flex; gap:8px; margin:8px 0 16px 0;">
            <button class="tab-btn" data-tab="calc" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text);">EPA Calculator</button>
            <button class="tab-btn" data-tab="flows" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted);">EPA Licensing</button>
            <button class="tab-btn" data-tab="scheduler" style="padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted);">EPA Scheduler</button>
        </nav>

        <section id="tab-calc" class="grid" aria-label="Calculator">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="budget">Total budget</label>
                        <input id="budget" name="budget" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 25000" aria-describedby="budgetHint">
                        <div class="hint" id="budgetHint">Total amount available to spend (same billing term as prices).</div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="priceAdv">Advantage price per agent (flat)</label>
                        <input id="priceAdv" name="priceAdv" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 50">
                        <div class="hint">Used only if tiers are empty. Otherwise the tiered scale applies.</div>
                    </div>
                    <div class="control">
                        <label for="priceEss">Essentials price per agent (flat)</label>
                        <input id="priceEss" name="priceEss" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 35">
                        <div class="hint">Used only if tiers are empty. Otherwise the tiered scale applies.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="panel">
                        <div class="stack">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <label>Advantage tiers</label>
                                <button id="addTierAdv" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text);">Add tier</button>
                            </div>
                            <div class="hint">Threshold-based pricing: "Up to" defines the maximum quantity for that tier. If you cross a threshold, ALL agents are priced at that tier's rate. Leave last "Up to" empty for no cap.</div>
                            <div id="tiers-adv" class="stack"></div>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="panel">
                        <div class="stack">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                                <label>Essentials tiers</label>
                                <button id="addTierEss" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text);">Add tier</button>
                            </div>
                            <div class="hint">Threshold-based pricing: "Up to" defines the maximum quantity for that tier. If you cross a threshold, ALL agents are priced at that tier's rate. Leave last "Up to" empty for no cap.</div>
                            <div id="tiers-ess" class="stack"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="currency">Currency</label>
                        <select id="currency" name="currency" aria-describedby="curHint">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro (Europe)</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                            <option value="AUD">AUD - Australian Dollar</option>
                            <option value="MXN">MXN - Mexican Peso</option>
                        </select>
                        <div class="hint" id="curHint">Select currency for price formatting. <button id="fetchRates" type="button" style="margin-top:4px; padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:11px;">Update exchange rates</button></div>
                    </div>
                    <div class="control">
                        <label for="rounding">Rounding</label>
                        <input id="rounding" name="rounding" type="text" value="down" aria-describedby="roundHint">
                        <div class="hint" id="roundHint">"down" to floor to whole agents, "nearest" to round to nearest.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="showAvg">Display options</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="showAvg" name="showAvg" type="checkbox">
                            <span class="hint">Show effective average price at computed quantity</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result" id="res-adv">
                    <h3>Advantage agents</h3>
                    <div class="value" id="advCount">‚Äì</div>
                </div>
                <div class="result" id="res-ess">
                    <h3>Essentials agents</h3>
                    <div class="value" id="essCount">‚Äì</div>
                </div>
                <div class="result" id="res-leftover-adv">
                    <h3>Unspent budget (Advantage)</h3>
                    <div class="value" id="leftoverAdv">‚Äì</div>
                </div>
                <div class="result" id="res-leftover-ess">
                    <h3>Unspent budget (Essentials)</h3>
                    <div class="value" id="leftoverEss">‚Äì</div>
                </div>
                <div class="result" id="res-avg-adv" style="display:none;">
                    <h3>Effective average price (Advantage)</h3>
                    <div class="value" id="avgPriceAdv">‚Äì</div>
                </div>
                <div class="result" id="res-avg-ess" style="display:none;">
                    <h3>Effective average price (Essentials)</h3>
                    <div class="value" id="avgPriceEss">‚Äì</div>
                </div>
                <div class="result" id="res-rates" style="display:none;">
                    <h3>Exchange rates (vs USD)</h3>
                    <div class="value" id="ratesDisplay" style="font-size:14px; line-height:1.6;">‚Äì</div>
                </div>
            </div>

            <div class="panel" id="multiCurrencyPanel" style="display:none;">
                <div class="stack">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                        <label>Multi-currency view</label>
                        <input id="showMultiCurrency" name="showMultiCurrency" type="checkbox">
                    </div>
                    <div class="hint">Display all values converted to all supported currencies using real-time exchange rates.</div>
                    <div id="multiCurrencyDisplay" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-top:8px;"></div>
                </div>
            </div>
        </section>

        <section id="tab-flows" class="stack-lg" aria-label="EPA Licensing" style="display:none;">
            <div class="panel stack-lg">
                <div class="row">
                    <div class="control">
                        <label for="apiBase">ThousandEyes API base URL</label>
                        <input id="apiBase" name="apiBase" type="text" placeholder="https://api.thousandeyes.com/v7">
                        <div class="hint">Set your API base. Must allow CORS in browser context.</div>
                    </div>
                    <div class="control">
                        <label for="apiToken">API Token</label>
                        <input id="apiToken" name="apiToken" type="text" placeholder="TE Bearer token">
                        <div class="hint">Stored only in your browser. Do not share.</div>
                    </div>
                </div>
                <div class="row">
                    <div class="control">
                        <label for="accountGroupId">Account Group ID</label>
                        <input id="accountGroupId" name="accountGroupId" type="text" placeholder="e.g. 12345">
                    </div>
                    <div class="control">
                        <label for="switchEndpoint">License switch endpoint path</label>
                        <input id="switchEndpoint" name="switchEndpoint" type="text" placeholder="/v6/endpoint-agents/license">
                        <div class="hint">Full URL will be base + path. Body will include desired license.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="control">
                        <label for="agentTags">Endpoint agent tags</label>
                        <input id="agentTags" name="agentTags" type="text" placeholder="tagA, tagB">
                        <div class="hint">Comma-separated tags to include when switching licenses or counting agents.</div>
                    </div>
                    <div class="control">
                        <label for="agentsEndpoint">Agents list endpoint path</label>
                        <input id="agentsEndpoint" name="agentsEndpoint" type="text" placeholder="/v6/endpoint-agents">
                        <div class="hint">Used for counting licenses per type.</div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <label for="dryRun">Dry run mode</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="dryRun" name="dryRun" type="checkbox">
                            <span class="hint">Skip live API calls and just log what would happen.</span>
                        </div>
                    </div>
                </div>

                <div class="row-1">
                    <div class="control">
                        <button id="refreshCounts" type="button" style="padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); width:100%;">Refresh license counts</button>
                        <div class="hint">Runs the ThousandEyes agent list endpoint (filtered by tags) and summarizes Advantage vs Essentials counts.</div>
                    </div>
                </div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result">
                    <h3>Advantage agents (current)</h3>
                    <div class="value" id="currentAdvCount">‚Äì</div>
                </div>
                <div class="result">
                    <h3>Essentials agents (current)</h3>
                    <div class="value" id="currentEssCount">‚Äì</div>
                </div>
                <div class="result">
                    <h3>Last refresh status</h3>
                    <div class="value" id="lastCountStatus">‚Äì</div>
                </div>
            </div>
        </section>

        <section id="tab-scheduler" class="stack-lg" aria-label="EPA Scheduler" style="display:none;">
            <div class="panel stack-lg">
                <div class="row-1">
                    <div class="control">
                        <label for="schedulerEnabled">Scheduler</label>
                        <div style="display:flex; align-items:center; gap:10px; padding:10px 0;">
                            <input id="schedulerEnabled" name="schedulerEnabled" type="checkbox">
                            <span class="hint">Enable automatic EPA endpoint toggling while this page is open. Uses API base/token + dry run toggle from EPA Licensing.</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="control">
                        <label for="stateEndpoint">Endpoint control API path</label>
                        <input id="stateEndpoint" name="stateEndpoint" type="text" placeholder="/v6/endpoint-agents/state">
                        <div class="hint">POST target that accepts { label, action } with action = enable | disable.</div>
                    </div>
                    <div class="control">
                        <label for="schedulerFrequency">Check frequency (seconds)</label>
                        <input id="schedulerFrequency" name="schedulerFrequency" type="number" min="15" step="15" value="60">
                        <div class="hint">How often to evaluate schedules. Minimum 15s.</div>
                    </div>
                </div>
            </div>

            <div class="panel stack-lg">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                    <label>EPA schedules</label>
                    <button id="addSchedulerEntry" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--panel); color:var(--text);">Add schedule</button>
                </div>
                <div class="hint">Each row controls endpoints matching a label for the specified time window. Leave ‚Äúto‚Äù earlier than ‚Äúfrom‚Äù to span midnight.</div>
                <div id="schedulerList" class="stack"></div>
            </div>

            <div class="panel results" aria-live="polite">
                <div class="result">
                    <h3>Active instructions right now</h3>
                    <div class="value" id="schedulerSnapshot">‚Äì</div>
                </div>
                <div class="result">
                    <h3>Scheduler log</h3>
                    <div class="value" id="schedulerLog">‚Äì</div>
                </div>
            </div>
        </section>

        <footer>
            Sample calculator. Enter your actual ThousandEyes pricing for accurate results.
        </footer>
            </main>
        </div>

        <div id="page-synthetics" class="page-content" style="display:none;">
            <main class="container" role="main">
                <header>
                    <div>
                        <h1>Cloud and App Synthetics Units Calculator</h1>
                        <div class="subtle">Calculate units based on agent type, test interval, and test type.</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="tag" aria-live="polite" id="syntheticsCurrencyTag">Currency: <strong class="accent" id="syntheticsCurrencyTagValue">USD</strong></div>
                        <button id="syntheticsThemeToggle" type="button" style="padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;" title="Toggle light/dark mode">üåô</button>
                    </div>
                </header>

                <section class="grid" aria-label="Synthetics Calculator">
                    <div class="panel stack-lg">
                        <div class="row">
                            <div class="control">
                                <label for="agentType">Agent Type</label>
                                <select id="agentType" name="agentType">
                                    <option value="enterprise">Enterprise</option>
                                    <option value="cloud">Cloud</option>
                                </select>
                                <div class="hint">Cloud agents use 2x the unit calculation.</div>
                            </div>
                            <div class="control">
                                <label for="testInterval">Test Interval (minutes)</label>
                                <select id="testInterval" name="testInterval">
                                    <option value="1">1 minute</option>
                                    <option value="2">2 minutes</option>
                                    <option value="5">5 minutes</option>
                                    <option value="10">10 minutes</option>
                                    <option value="15">15 minutes</option>
                                </select>
                            </div>
                        </div>

                        <div class="row-1">
                            <div class="control">
                                <label for="testType">Test Type</label>
                                <select id="testType" name="testType">
                                    <option value="bgp">BGP Routing</option>
                                    <option value="network-agent-server">Network, Agent to Server</option>
                                    <option value="network-agent-agent">Network, Agent to Agent</option>
                                    <option value="dns-server">DNS Server</option>
                                    <option value="dns-trace">DNS Trace, DNSSEC</option>
                                    <option value="http-server">HTTP Server</option>
                                    <option value="page-load">Page Load</option>
                                    <option value="transaction">Transaction</option>
                                    <option value="sip-rtp">SIP Server, RTP Stream</option>
                                    <option value="voice-calls">Voice Calls</option>
                                </select>
                            </div>
                        </div>

                        <div id="testTypeParams" class="stack-lg"></div>
                    </div>

                    <div class="panel results" aria-live="polite">
                        <div class="result">
                            <h3>Units (C)</h3>
                            <div class="value" id="unitsResult">‚Äì</div>
                        </div>
                        <div class="result">
                            <h3>Monthly Units</h3>
                            <div class="value" id="monthlyUnitsResult">‚Äì</div>
                        </div>
                    </div>
                </section>

                <div class="panel" style="margin-top:16px;">
                    <div class="stack">
                        <label>Calculation Breakdown</label>
                        <div id="calculationDisplay" style="font-family:monospace; font-size:13px; line-height:1.8; color:var(--muted); padding:12px; background:color-mix(in oklab, var(--panel) 90%, black 10%); border-radius:8px; border:1px solid var(--border);">
                            Select test type and enter parameters to see calculation
                        </div>
                        <button id="addToConfigList" type="button" style="margin-top:12px; padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--accent); color:white; cursor:pointer; font-size:14px; font-weight:500;">
                            Add to Configuration List
                        </button>
                    </div>
                </div>

                <div class="panel" style="margin-top:16px;">
                    <div class="stack-lg">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                            <label style="margin:0;">Test Configurations</label>
                            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <label for="contractDuration" style="font-size:13px; color:var(--muted);">Contract:</label>
                                    <select id="contractDuration" style="padding:4px 8px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-size:13px; cursor:pointer;">
                                        <option value="12">1 Year</option>
                                        <option value="36">3 Years</option>
                                        <option value="60">5 Years</option>
                                    </select>
                                </div>
                                <div style="font-size:14px; color:var(--muted);">
                                    Total Units (√ó1000): <strong class="accent" id="totalUnitsDisplay">0</strong>
                                </div>
                                <div style="font-size:14px; color:var(--muted);">
                                    <span id="totalCostLabel">Total Cost (1 Year):</span> <strong class="accent" id="totalCostDisplay">$0.00</strong>
                                </div>
                                <button id="clearConfigList" type="button" style="padding:6px 12px; border-radius:6px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:12px;">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        <div id="configList" style="min-height:100px;">
                            <div style="text-align:center; padding:40px; color:var(--muted); font-size:14px;">
                                No configurations added yet. Configure a test above and click "Add to Configuration List".
                            </div>
                        </div>
                    </div>
                </div>

                <footer>
                    Units calculator for Cloud and App Synthetics tests.
                </footer>
            </main>
        </div>
    </div>

    <script>
        (function() {
            // Page navigation
            const navButtons = document.querySelectorAll('.nav-btn');
            const pageEndpoint = document.getElementById('page-endpoint');
            const pageSynthetics = document.getElementById('page-synthetics');
            let activePage = 'endpoint';

            function setPage(page) {
                activePage = page;
                pageEndpoint.style.display = page === 'endpoint' ? '' : 'none';
                pageSynthetics.style.display = page === 'synthetics' ? '' : 'none';
                navButtons.forEach(btn => {
                    const isActive = btn.dataset.page === page;
                    btn.classList.toggle('active', isActive);
                });
                try {
                    const state = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    state.activePage = activePage;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(state));
                } catch {}
            }

            navButtons.forEach(btn => btn.addEventListener('click', () => setPage(btn.dataset.page)));

            // Load saved page
            try {
                const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                if (saved.activePage) setPage(saved.activePage);
            } catch {}

            // Tabs
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabCalc = document.getElementById('tab-calc');
            const tabFlows = document.getElementById('tab-flows');
            const tabScheduler = document.getElementById('tab-scheduler');
            let activeTab = 'calc';
            function setTab(tab) {
                activeTab = tab;
                tabCalc.style.display = tab === 'calc' ? '' : 'none';
                tabFlows.style.display = tab === 'flows' ? '' : 'none';
                tabScheduler.style.display = tab === 'scheduler' ? '' : 'none';
                tabButtons.forEach(btn => {
                    const isActive = btn.dataset.tab === tab;
                    btn.style.background = isActive ? 'var(--panel)' : 'transparent';
                    btn.style.color = isActive ? 'var(--text)' : 'var(--muted)';
                });
                try {
                    const state = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                    state.activeTab = activeTab;
                    localStorage.setItem('teBudgetCalc', JSON.stringify(state));
                } catch {}
            }
            tabButtons.forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            const syntheticsThemeToggle = document.getElementById('syntheticsThemeToggle');
            const root = document.documentElement;
            const THEME_KEY = 'teTheme';
            
            function setTheme(theme) {
                root.setAttribute('data-theme', theme);
                const icon = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                const title = theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode';
                if (themeToggle) {
                    themeToggle.textContent = icon;
                    themeToggle.title = title;
                }
                if (syntheticsThemeToggle) {
                    syntheticsThemeToggle.textContent = icon;
                    syntheticsThemeToggle.title = title;
                }
                try {
                    localStorage.setItem(THEME_KEY, theme);
                } catch {}
            }
            
            function initTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved === 'light' || saved === 'dark') {
                        setTheme(saved);
                    } else {
                        // Default to dark, or detect system preference
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        setTheme(prefersDark ? 'dark' : 'light');
                    }
                } catch {
                    setTheme('dark');
                }
            }
            
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const current = root.getAttribute('data-theme') || 'dark';
                    setTheme(current === 'light' ? 'dark' : 'light');
                });
            }
            
            if (syntheticsThemeToggle) {
                syntheticsThemeToggle.addEventListener('click', () => {
                    const current = root.getAttribute('data-theme') || 'dark';
                    setTheme(current === 'light' ? 'dark' : 'light');
                });
            }
            
            initTheme();
            
            const budgetEl = document.getElementById('budget');
            const priceAdvEl = document.getElementById('priceAdv');
            const priceEssEl = document.getElementById('priceEss');
            const currencyEl = document.getElementById('currency');
            const roundingEl = document.getElementById('rounding');
            const showAvgEl = document.getElementById('showAvg');
            const fetchRatesBtn = document.getElementById('fetchRates');
            const ratesDisplayEl = document.getElementById('ratesDisplay');
            const resRates = document.getElementById('res-rates');

            const advCountEl = document.getElementById('advCount');
            const essCountEl = document.getElementById('essCount');
            const leftoverAdvEl = document.getElementById('leftoverAdv');
            const leftoverEssEl = document.getElementById('leftoverEss');
            const currencyTagValue = document.getElementById('currencyTagValue');
            const avgPriceAdvEl = document.getElementById('avgPriceAdv');
            const avgPriceEssEl = document.getElementById('avgPriceEss');
            const resAvgAdv = document.getElementById('res-avg-adv');
            const resAvgEss = document.getElementById('res-avg-ess');
            const showMultiCurrencyEl = document.getElementById('showMultiCurrency');
            const multiCurrencyPanel = document.getElementById('multiCurrencyPanel');
            const multiCurrencyDisplay = document.getElementById('multiCurrencyDisplay');

            const tiersAdvContainer = document.getElementById('tiers-adv');
            const tiersEssContainer = document.getElementById('tiers-ess');
            const addTierAdvBtn = document.getElementById('addTierAdv');
            const addTierEssBtn = document.getElementById('addTierEss');

            // Workflows elements
            const apiBaseEl = document.getElementById('apiBase');
            const apiTokenEl = document.getElementById('apiToken');
            const accountGroupIdEl = document.getElementById('accountGroupId');
            const switchEndpointEl = document.getElementById('switchEndpoint');
            const agentTagsEl = document.getElementById('agentTags');
            const agentsEndpointEl = document.getElementById('agentsEndpoint');
            const dryRunEl = document.getElementById('dryRun');
            const refreshCountsBtn = document.getElementById('refreshCounts');
            const currentAdvCountEl = document.getElementById('currentAdvCount');
            const currentEssCountEl = document.getElementById('currentEssCount');
            const lastCountStatusEl = document.getElementById('lastCountStatus');
            // Scheduler elements
            const schedulerEnabledEl = document.getElementById('schedulerEnabled');
            const stateEndpointEl = document.getElementById('stateEndpoint');
            const schedulerFrequencyEl = document.getElementById('schedulerFrequency');
            const schedulerListEl = document.getElementById('schedulerList');
            const addSchedulerEntryBtn = document.getElementById('addSchedulerEntry');
            const schedulerSnapshotEl = document.getElementById('schedulerSnapshot');
            const schedulerLogEl = document.getElementById('schedulerLog');

            // Defaults you can adjust
            const defaults = {
                budget: '',
                priceAdv: '',
                priceEss: '',
                currency: 'USD',
                rounding: 'down',
                showAvg: false,
                showMultiCurrency: false,
                tiersAdv: [
                    { upTo: 500, price: 50 },
                    { upTo: 2000, price: 45 },
                    { upTo: null, price: 40 }
                ],
                tiersEss: [
                    { upTo: 500, price: 35 },
                    { upTo: 2000, price: 30 },
                    { upTo: null, price: 25 }
                ],
                // workflows defaults
                activeTab: 'calc',
                apiBase: 'https://api.thousandeyes.com/v7',
                apiToken: '',
                accountGroupId: '',
                switchEndpoint: '/v6/endpoint-agents/license',
                agentTags: '',
                agentsEndpoint: '/v6/endpoint-agents',
                dryRun: true,
                schedulerEnabled: false,
                stateEndpoint: '/v6/endpoint-agents/state',
                schedulerFrequency: 60,
                schedulerEntries: [
                    { label: 'EPA-Branch-1', from: '08:00', to: '18:00', action: 'enable' },
                    { label: 'EPA-Branch-1', from: '18:00', to: '08:00', action: 'disable' }
                ]
            };

            // Load saved values from localStorage
            try {
                const saved = JSON.parse(localStorage.getItem('teBudgetCalc') || '{}');
                const blended = { ...defaults, ...saved };
                for (const [k, v] of Object.entries(blended)) {
                    const el = document.getElementById(k);
                    if (!el || typeof v === 'undefined' || v === null) continue;
                    if (el.type === 'checkbox') el.checked = Boolean(v); else el.value = v;
                }
                // render tiers from saved
                renderTierEditor('adv', blended.tiersAdv || defaults.tiersAdv);
                renderTierEditor('ess', blended.tiersEss || defaults.tiersEss);
                // set active tab
                setTab(blended.activeTab || 'calc');
                // seed API/config to inputs
                apiBaseEl.value = blended.apiBase || defaults.apiBase;
                apiTokenEl.value = blended.apiToken || defaults.apiToken;
                accountGroupIdEl.value = blended.accountGroupId || defaults.accountGroupId;
                switchEndpointEl.value = blended.switchEndpoint || defaults.switchEndpoint;
                agentTagsEl.value = blended.agentTags || defaults.agentTags;
                agentsEndpointEl.value = blended.agentsEndpoint || defaults.agentsEndpoint;
                dryRunEl.checked = blended.dryRun !== undefined ? !!blended.dryRun : defaults.dryRun;
                schedulerEnabledEl.checked = blended.schedulerEnabled || false;
                stateEndpointEl.value = blended.stateEndpoint || defaults.stateEndpoint;
                schedulerFrequencyEl.value = blended.schedulerFrequency || defaults.schedulerFrequency;
                renderSchedulerEntries(blended.schedulerEntries || defaults.schedulerEntries);
            } catch {}

            function save() {
                const data = {
                    budget: budgetEl.value,
                    priceAdv: priceAdvEl.value,
                    priceEss: priceEssEl.value,
                    currency: (currencyEl.value || 'USD').toUpperCase(),
                    rounding: (roundingEl.value || 'down').toLowerCase(),
                    showAvg: !!showAvgEl.checked,
                    showMultiCurrency: !!showMultiCurrencyEl.checked,
                    tiersAdv: readTiers('adv'),
                    tiersEss: readTiers('ess'),
                    // workflows
                    activeTab,
                    apiBase: apiBaseEl.value,
                    apiToken: apiTokenEl.value,
                    accountGroupId: accountGroupIdEl.value,
                    switchEndpoint: switchEndpointEl.value,
                    agentTags: agentTagsEl.value,
                    agentsEndpoint: agentsEndpointEl.value,
                    dryRun: !!dryRunEl.checked,
                    schedulerEnabled: !!schedulerEnabledEl.checked,
                    stateEndpoint: stateEndpointEl.value,
                    schedulerFrequency: schedulerFrequencyEl.value,
                    schedulerEntries: readSchedulerEntries()
                };
                localStorage.setItem('teBudgetCalc', JSON.stringify(data));
            }

            function fmtCurrency(n, currency) {
                if (!isFinite(n)) return '‚Äì';
                try {
                    return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(n);
                } catch {
                    return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(n);
                }
            }

            function fmtInt(n) {
                if (!isFinite(n)) return '‚Äì';
                return new Intl.NumberFormat().format(n);
            }

            function parseNum(input) {
                const val = typeof input === 'string' ? input.trim() : (input?.toString?.() ?? '');
                if (val === '') return NaN;
                const n = Number(val);
                return isFinite(n) ? n : NaN;
            }

            function normalizeTiers(tiersRaw) {
                const tiers = (tiersRaw || [])
                    .map(t => ({ upTo: (t.upTo === null || t.upTo === '' || t.upTo === undefined) ? null : Number(t.upTo), price: Number(t.price) }))
                    .filter(t => isFinite(t.price) && t.price > 0 && (t.upTo === null || (isFinite(t.upTo) && t.upTo > 0)));
                tiers.sort((a, b) => {
                    if (a.upTo === null) return 1;
                    if (b.upTo === null) return -1;
                    return a.upTo - b.upTo;
                });
                // ensure last tier is open-ended
                if (!tiers.length || tiers[tiers.length - 1].upTo !== null) tiers.push({ upTo: null, price: tiers.length ? tiers[tiers.length - 1].price : NaN });
                // remove duplicates with same upTo keeping lowest price
                const compact = [];
                for (const t of tiers) {
                    const last = compact[compact.length - 1];
                    if (last && last.upTo === t.upTo) last.price = Math.min(last.price, t.price); else compact.push(t);
                }
                return compact.filter(t => isFinite(t.price));
            }

            function costForQuantity(quantity, tiers) {
                // Threshold-based pricing: find the tier the quantity qualifies for, apply that price to ALL agents
                if (!tiers.length || quantity <= 0) return 0;
                // Tiers are sorted by upTo ascending
                // Find the first tier where quantity <= upTo (or upTo is null for open-ended)
                let applicableTier = tiers[tiers.length - 1]; // Default to last tier (open-ended)
                for (const tier of tiers) {
                    const threshold = tier.upTo === null ? Infinity : tier.upTo;
                    if (quantity <= threshold) {
                        applicableTier = tier;
                        break; // Found the applicable tier
                    }
                }
                // Apply the tier price to ALL agents
                return quantity * applicableTier.price;
            }

            function maxAgentsUnderBudget(budget, tiers, roundingMode) {
                if (!isFinite(budget) || budget <= 0 || !tiers.length) return { agents: NaN, spent: NaN, leftover: NaN };
                const tiersNorm = normalizeTiers(tiers);
                // Exponential then binary search to find maximum agents where cost <= budget
                let low = 0, high = 1;
                while (costForQuantity(high, tiersNorm) <= budget && high < 1e9) {
                    low = high;
                    high *= 2;
                }
                while (low < high) {
                    const mid = Math.floor((low + high + 1) / 2);
                    const cost = costForQuantity(mid, tiersNorm);
                    if (cost <= budget) low = mid; else high = mid - 1;
                }
                let agents = low;
                if (roundingMode === 'nearest') {
                    // Try +/- 1 around low to approximate nearest under monotonic cost
                    const costLow = costForQuantity(low, tiersNorm);
                    const costUp = costForQuantity(low + 1, tiersNorm);
                    if (Math.abs(budget - costUp) < Math.abs(budget - costLow) && costUp <= budget) agents = low + 1;
                }
                const spent = costForQuantity(agents, tiersNorm);
                const leftover = budget - spent;
                return { agents, spent, leftover };
            }

            function makeTierRow(kind, idx, tier) {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr auto';
                row.style.gap = '8px';
                row.dataset.index = String(idx);

                const upTo = document.createElement('input');
                upTo.type = 'number';
                upTo.min = '1';
                upTo.step = '1';
                upTo.placeholder = 'Up to (qty)';
                upTo.value = tier.upTo == null ? '' : String(tier.upTo);
                upTo.setAttribute('aria-label', 'Up to quantity');

                const price = document.createElement('input');
                price.type = 'number';
                price.min = '0';
                price.step = '0.01';
                price.placeholder = 'Price per agent';
                price.value = tier.price != null ? String(tier.price) : '';
                price.setAttribute('aria-label', 'Price');

                const del = document.createElement('button');
                del.type = 'button';
                del.textContent = 'Remove';
                del.style.padding = '8px 10px';
                del.style.borderRadius = '8px';
                del.style.border = '1px solid var(--border)';
                del.style.background = '#0f1218';
                del.style.color = 'var(--text)';

                del.addEventListener('click', () => {
                    const arr = readTiers(kind);
                    arr.splice(idx, 1);
                    renderTierEditor(kind, arr);
                    compute();
                });

                for (const el of [upTo, price]) {
                    el.addEventListener('input', () => {
                        const arr = readTiers(kind);
                        arr[idx] = { upTo: upTo.value === '' ? null : Number(upTo.value), price: Number(price.value) };
                        renderTierEditor(kind, arr);
                        compute();
                    });
                    el.addEventListener('change', () => {
                        compute();
                    });
                }

                row.appendChild(upTo);
                row.appendChild(price);
                row.appendChild(del);
                return row;
            }

            function renderTierEditor(kind, tiers) {
                const container = kind === 'adv' ? tiersAdvContainer : tiersEssContainer;
                container.innerHTML = '';
                const current = tiers && tiers.length ? tiers : [{ upTo: 500, price: 50 }, { upTo: null, price: 40 }];
                current.forEach((t, i) => container.appendChild(makeTierRow(kind, i, t)));
                // Save to storage after render
                save();
            }

            function readTiers(kind) {
                const container = kind === 'adv' ? tiersAdvContainer : tiersEssContainer;
                const rows = Array.from(container.children);
                return rows.map(row => {
                    const [upToEl, priceEl] = row.querySelectorAll('input');
                    const upToVal = upToEl.value === '' ? null : Number(upToEl.value);
                    const priceVal = Number(priceEl.value);
                    return { upTo: upToVal, price: priceVal };
                });
            }

            // Multi-currency conversion
            async function getExchangeRates() {
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < 60 * 60 * 1000)) {
                        return { rates: cached.rates, base: baseCurrency };
                    }
                } catch {}
                // If no cache, try to fetch
                try {
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${baseCurrency}`);
                    if (response.ok) {
                        const data = await response.json();
                        const rates = data.rates || {};
                        localStorage.setItem(CACHE_KEY, JSON.stringify({
                            rates,
                            timestamp: Date.now(),
                            base: baseCurrency
                        }));
                        return { rates, base: baseCurrency };
                    }
                } catch {}
                return null;
            }

            function convertToAllCurrencies(value, baseCurrency, rates) {
                if (!rates || !isFinite(value) || value <= 0) return {};
                const allCurrencies = ['USD', 'EUR', 'JPY', 'AUD', 'MXN'];
                const converted = {};
                for (const code of allCurrencies) {
                    if (code === baseCurrency) {
                        converted[code] = value;
                    } else if (rates[code]) {
                        converted[code] = value * rates[code];
                    }
                }
                return converted;
            }

            function updateMultiCurrencyDisplay(data) {
                if (!showMultiCurrencyEl.checked) {
                    multiCurrencyPanel.style.display = 'none';
                    return;
                }
                multiCurrencyPanel.style.display = '';
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                
                getExchangeRates().then(result => {
                    if (!result || !result.rates) {
                        multiCurrencyDisplay.innerHTML = '<div class="hint">Exchange rates not available. Click "Update exchange rates" to fetch rates.</div>';
                        return;
                    }
                    
                    const { rates } = result;
                    const allCurrencies = ['USD', 'EUR', 'JPY', 'AUD', 'MXN'];
                    let html = '';
                    
                    for (const code of allCurrencies) {
                        const converted = convertToAllCurrencies(data.budget || 0, baseCurrency, rates);
                        const budgetVal = converted[code] || 0;
                        const advLeftVal = convertToAllCurrencies(data.advLeft || 0, baseCurrency, rates)[code] || 0;
                        const essLeftVal = convertToAllCurrencies(data.essLeft || 0, baseCurrency, rates)[code] || 0;
                        const avgAdvVal = convertToAllCurrencies(data.avgAdv || 0, baseCurrency, rates)[code] || 0;
                        const avgEssVal = convertToAllCurrencies(data.avgEss || 0, baseCurrency, rates)[code] || 0;
                        
                        html += `<div class="result" style="padding:12px;">
                            <h3 style="font-size:13px; margin-bottom:8px; color:var(--accent);">${code}</h3>
                            <div style="display:grid; gap:6px; font-size:12px;">
                                <div style="display:flex; justify-content:space-between;"><span>Budget:</span> <strong>${fmtCurrency(budgetVal, code)}</strong></div>
                                <div style="display:flex; justify-content:space-between;"><span>Unspent (Adv):</span> <strong>${fmtCurrency(advLeftVal, code)}</strong></div>
                                <div style="display:flex; justify-content:space-between;"><span>Unspent (Ess):</span> <strong>${fmtCurrency(essLeftVal, code)}</strong></div>
                                ${data.showAvg ? `<div style="display:flex; justify-content:space-between;"><span>Avg/agent (Adv):</span> <strong>${fmtCurrency(avgAdvVal, code)}</strong></div>` : ''}
                                ${data.showAvg ? `<div style="display:flex; justify-content:space-between;"><span>Avg/agent (Ess):</span> <strong>${fmtCurrency(avgEssVal, code)}</strong></div>` : ''}
                            </div>
                        </div>`;
                    }
                    
                    multiCurrencyDisplay.innerHTML = html;
                });
            }

            function compute() {
                const budget = parseNum(budgetEl.value);
                const priceAdv = parseNum(priceAdvEl.value);
                const priceEss = parseNum(priceEssEl.value);
                const currency = (currencyEl.value || 'USD').toUpperCase();
                let rounding = (roundingEl.value || 'down').toLowerCase();
                if (rounding !== 'down' && rounding !== 'nearest') rounding = 'down';
                const showAvg = !!showAvgEl.checked;

                currencyTagValue.textContent = currency;

                const tiersAdv = normalizeTiers(readTiers('adv'));
                const tiersEss = normalizeTiers(readTiers('ess'));

                let advAgents, advSpent, advLeft;
                if (tiersAdv.length && isFinite(budget)) {
                    const res = maxAgentsUnderBudget(budget, tiersAdv, rounding);
                    advAgents = res.agents; advSpent = res.spent; advLeft = res.leftover;
                } else {
                    const raw = (isFinite(budget) && isFinite(priceAdv) && priceAdv > 0) ? budget / priceAdv : NaN;
                    advAgents = rounding === 'nearest' ? Math.round(raw) : Math.floor(raw);
                    advSpent = isFinite(advAgents) ? advAgents * priceAdv : NaN;
                    advLeft = isFinite(budget) ? budget - advSpent : NaN;
                }

                let essAgents, essSpent, essLeft;
                if (tiersEss.length && isFinite(budget)) {
                    const res = maxAgentsUnderBudget(budget, tiersEss, rounding);
                    essAgents = res.agents; essSpent = res.spent; essLeft = res.leftover;
                } else {
                    const raw = (isFinite(budget) && isFinite(priceEss) && priceEss > 0) ? budget / priceEss : NaN;
                    essAgents = rounding === 'nearest' ? Math.round(raw) : Math.floor(raw);
                    essSpent = isFinite(essAgents) ? essAgents * priceEss : NaN;
                    essLeft = isFinite(budget) ? budget - essSpent : NaN;
                }

                advCountEl.textContent = fmtInt(advAgents);
                essCountEl.textContent = fmtInt(essAgents);
                leftoverAdvEl.textContent = fmtCurrency(advLeft, currency);
                leftoverEssEl.textContent = fmtCurrency(essLeft, currency);

                // Effective average price (spent / agents)
                const avgAdv = isFinite(advSpent) && isFinite(advAgents) && advAgents > 0 ? (advSpent / advAgents) : NaN;
                const avgEss = isFinite(essSpent) && isFinite(essAgents) && essAgents > 0 ? (essSpent / essAgents) : NaN;
                avgPriceAdvEl.textContent = isFinite(avgAdv) ? fmtCurrency(avgAdv, currency) : '‚Äì';
                avgPriceEssEl.textContent = isFinite(avgEss) ? fmtCurrency(avgEss, currency) : '‚Äì';
                resAvgAdv.style.display = showAvg ? '' : 'none';
                resAvgEss.style.display = showAvg ? '' : 'none';

                // Update multi-currency display
                updateMultiCurrencyDisplay({
                    budget,
                    advLeft,
                    essLeft,
                    avgAdv: isFinite(avgAdv) ? avgAdv : 0,
                    avgEss: isFinite(avgEss) ? avgEss : 0,
                    showAvg
                });

                save();
            }

            const inputs = [budgetEl, priceAdvEl, priceEssEl, currencyEl, roundingEl, showAvgEl];
            for (const el of inputs) {
                el.addEventListener('input', compute);
                el.addEventListener('change', compute);
            }

            showMultiCurrencyEl.addEventListener('change', () => {
                compute();
                save();
            });

            addTierAdvBtn.addEventListener('click', () => {
                const tiers = readTiers('adv');
                tiers.push({ upTo: '', price: '' });
                renderTierEditor('adv', tiers);
                compute();
            });

            addTierEssBtn.addEventListener('click', () => {
                const tiers = readTiers('ess');
                tiers.push({ upTo: '', price: '' });
                renderTierEditor('ess', tiers);
                compute();
            });

            // Exchange rate fetching
            async function fetchExchangeRates() {
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                const CACHE_DURATION = 60 * 60 * 1000; // 1 hour
                
                // Check cache first
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < CACHE_DURATION)) {
                        displayRates(cached.rates, baseCurrency);
                        return;
                    }
                } catch {}

                fetchRatesBtn.textContent = 'Updating...';
                fetchRatesBtn.disabled = true;
                
                try {
                    // Using exchangerate-api.io free tier (no API key needed for basic usage)
                    const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${baseCurrency}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    const rates = data.rates || {};
                    
                    // Cache the rates
                    localStorage.setItem(CACHE_KEY, JSON.stringify({
                        rates,
                        timestamp: Date.now(),
                        base: baseCurrency
                    }));
                    
                    displayRates(rates, baseCurrency);
                    // Trigger recompute to update multi-currency display
                    if (showMultiCurrencyEl.checked) {
                        compute();
                    }
                } catch (err) {
                    ratesDisplayEl.textContent = 'Error: ' + (err.message || 'Failed to fetch rates');
                    resRates.style.display = '';
                } finally {
                    fetchRatesBtn.textContent = 'Update exchange rates';
                    fetchRatesBtn.disabled = false;
                }
            }

            function displayRates(rates, baseCurrency) {
                const allCurrencies = ['USD', 'EUR', 'JPY', 'AUD', 'MXN'];
                const currencies = allCurrencies.filter(c => c !== baseCurrency);
                const lines = currencies.map(code => {
                    const rate = rates[code];
                    if (!rate) return null;
                    return `${code}: ${rate.toFixed(4)}`;
                }).filter(Boolean);
                
                if (lines.length > 0) {
                    ratesDisplayEl.textContent = `vs ${baseCurrency}: ${lines.join(' ‚Ä¢ ')}`;
                    resRates.style.display = '';
                } else {
                    ratesDisplayEl.textContent = 'No rates available';
                    resRates.style.display = '';
                }
            }

            fetchRatesBtn.addEventListener('click', fetchExchangeRates);
            
            // Refresh rates when currency changes
            currencyEl.addEventListener('change', () => {
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                // Update header currency tag immediately
                currencyTagValue.textContent = baseCurrency;
                compute();
                // Try to load cached rates for new currency, or fetch if not available
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                try {
                    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                    if (cached.rates && cached.timestamp && (Date.now() - cached.timestamp < 60 * 60 * 1000)) {
                        displayRates(cached.rates, baseCurrency);
                    } else {
                        // Cache expired or doesn't exist, fetch new rates
                        fetchExchangeRates();
                    }
                } catch {
                    fetchExchangeRates();
                }
            });
            
            // Load cached rates on page load
            try {
                const baseCurrency = (currencyEl.value || 'USD').toUpperCase();
                const CACHE_KEY = `teExchangeRates_${baseCurrency}`;
                const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
                if (cached.rates) displayRates(cached.rates, baseCurrency);
            } catch {}

            function getTagList() {
                return (agentTagsEl.value || '')
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(Boolean);
            }
            dryRunEl.addEventListener('change', () => { save(); });

            const workflowInputs = [
                apiBaseEl,
                apiTokenEl,
                accountGroupIdEl,
                switchEndpointEl,
                agentTagsEl,
                agentsEndpointEl,
                stateEndpointEl,
                schedulerFrequencyEl
            ];
            workflowInputs.forEach(el => {
                el.addEventListener('input', () => save());
                el.addEventListener('change', () => save());
            });

            async function fetchLicenseCounts() {
                const tags = getTagList();
                if (dryRunEl.checked) {
                    const simulated = {
                        Advantage: Math.max(0, Number(advCountEl.textContent.replace(/[^0-9]/g, '')) || 0),
                        Essentials: Math.max(0, Number(essCountEl.textContent.replace(/[^0-9]/g, '')) || 0)
                    };
                    currentAdvCountEl.textContent = fmtInt(simulated.Advantage);
                    currentEssCountEl.textContent = fmtInt(simulated.Essentials);
                    lastCountStatusEl.textContent = 'Dry run at ' + new Date().toLocaleTimeString();
                    return;
                }
                const base = (apiBaseEl.value || '').replace(/\/$/, '');
                const path = agentsEndpointEl.value || '';
                const token = apiTokenEl.value.trim();
                if (!base || !path || !token) {
                    lastCountStatusEl.textContent = 'Missing API configuration';
                    return;
                }
                const url = new URL(base + path, window.location.origin);
                const params = new URLSearchParams();
                tags.forEach(tag => params.append('tag', tag));
                const finalUrl = params.toString() ? `${base + path}?${params.toString()}` : base + path;
                try {
                    lastCountStatusEl.textContent = 'Fetching‚Ä¶';
                    const resp = await fetch(finalUrl, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!resp.ok) {
                        const text = await resp.text().catch(() => '');
                        throw new Error(`API ${resp.status}: ${text || resp.statusText}`);
                    }
                    const data = await resp.json();
                    const agents = data?.endpointAgents || data?.agents || data?.items || [];
                    const counts = { Advantage: 0, Essentials: 0 };
                    agents.forEach(agent => {
                        const type = agent?.licenseType || agent?.license || '';
                        if (type && counts[type] !== undefined) counts[type] += 1;
                    });
                    currentAdvCountEl.textContent = fmtInt(counts.Advantage);
                    currentEssCountEl.textContent = fmtInt(counts.Essentials);
                    lastCountStatusEl.textContent = `Updated at ${new Date().toLocaleTimeString()}`;
                } catch (err) {
                    lastCountStatusEl.textContent = 'Error: ' + (err?.message || String(err));
                }
            }

            refreshCountsBtn.addEventListener('click', fetchLicenseCounts);

            // ---------- EPA Scheduler ----------
            function timeToMinutes(t) {
                const m = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/.exec((t || '').trim());
                if (!m) return NaN;
                return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
            }

            function makeSchedulerEntryRow(entry = {}) {
                const row = document.createElement('div');
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1.2fr 1fr 1fr 1fr auto';
                row.style.gap = '8px';
                row.className = 'scheduler-row';

                const labelEl = document.createElement('input');
                labelEl.type = 'text';
                labelEl.placeholder = 'Label (case-sensitive)';
                labelEl.value = entry.label || '';

                const fromEl = document.createElement('input');
                fromEl.type = 'text';
                fromEl.placeholder = 'From HH:MM';
                fromEl.value = entry.from || '';

                const toEl = document.createElement('input');
                toEl.type = 'text';
                toEl.placeholder = 'To HH:MM';
                toEl.value = entry.to || '';

                const actionEl = document.createElement('select');
                ['enable', 'disable'].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt.charAt(0).toUpperCase() + opt.slice(1);
                    actionEl.appendChild(option);
                });
                actionEl.value = entry.action || 'enable';

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.textContent = 'Remove';
                delBtn.style.padding = '8px 10px';
                delBtn.style.borderRadius = '8px';
                delBtn.style.border = '1px solid var(--border)';
                delBtn.style.background = '#0f1218';
                delBtn.style.color = 'var(--text)';

                delBtn.addEventListener('click', () => {
                    row.remove();
                    save();
                    resetSchedulerState();
                });

                [labelEl, fromEl, toEl, actionEl].forEach(el => {
                    el.addEventListener('input', () => { save(); resetSchedulerState(); });
                    el.addEventListener('change', () => { save(); resetSchedulerState(); });
                });

                row.append(labelEl, fromEl, toEl, actionEl, delBtn);
                return row;
            }

            function renderSchedulerEntries(entries) {
                schedulerListEl.innerHTML = '';
                (entries && entries.length ? entries : []).forEach(entry => {
                    schedulerListEl.appendChild(makeSchedulerEntryRow(entry));
                });
                if (!schedulerListEl.children.length) {
                    schedulerListEl.appendChild(makeSchedulerEntryRow());
                }
            }

            function readSchedulerEntries() {
                const rows = Array.from(schedulerListEl.querySelectorAll('.scheduler-row'));
                return rows.map(row => {
                    const [labelEl, fromEl, toEl, actionEl] = row.querySelectorAll('input, select');
                    return {
                        label: labelEl.value.trim(),
                        from: fromEl.value.trim(),
                        to: toEl.value.trim(),
                        action: actionEl.value
                    };
                }).filter(e => e.label && e.from && e.to && e.action);
            }

            addSchedulerEntryBtn.addEventListener('click', () => {
                schedulerListEl.appendChild(makeSchedulerEntryRow());
                save();
                resetSchedulerState();
            });

            function getSchedulerFrequencyMs() {
                const freq = Number(schedulerFrequencyEl.value);
                const safe = isFinite(freq) && freq >= 15 ? freq : 60;
                return safe * 1000;
            }

            function logScheduler(message) {
                schedulerLogEl.textContent = message;
            }

            function formatSnapshot(instructions) {
                const entries = Object.entries(instructions || {});
                if (!entries.length) return '‚Äì';
                return entries.map(([label, action]) => `${label}: ${action}`).join(', ');
            }

            function computeCurrentInstructions(entries) {
                const now = new Date();
                const minutes = now.getHours() * 60 + now.getMinutes();
                const instructions = {};
                for (const entry of entries) {
                    const fromM = timeToMinutes(entry.from);
                    const toM = timeToMinutes(entry.to);
                    if (!isFinite(fromM) || !isFinite(toM)) continue;
                    const wraps = toM <= fromM;
                    const inRange = wraps ? (minutes >= fromM || minutes < toM) : (minutes >= fromM && minutes < toM);
                    if (inRange && instructions[entry.label] === undefined) {
                        instructions[entry.label] = entry.action;
                    }
                }
                return instructions;
            }

            const lastSchedulerActions = new Map();
            function resetSchedulerState() {
                lastSchedulerActions.clear();
                schedulerSnapshotEl.textContent = '‚Äì';
            }

            async function updateEndpointState(label, action) {
                if (dryRunEl.checked) {
                    await new Promise(resolve => setTimeout(resolve, 150));
                    return { dryRun: true, label, action };
                }
                const base = (apiBaseEl.value || '').replace(/\/$/, '');
                const path = stateEndpointEl.value || '';
                const token = apiTokenEl.value.trim();
                if (!base || !path || !token) throw new Error('Missing API configuration');
                const url = base + path;
                const body = {
                    label,
                    action,
                    accountGroupId: accountGroupIdEl.value || undefined
                };
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    throw new Error(`API ${resp.status}: ${text || resp.statusText}`);
                }
                return resp.json().catch(() => ({}));
            }

            let schedulerTimer = null;
            let schedulerTickInFlight = false;

            async function runScheduler() {
                if (schedulerTickInFlight) return;
                if (!schedulerEnabledEl.checked) {
                    schedulerSnapshotEl.textContent = '‚Äì';
                    return;
                }
                schedulerTickInFlight = true;
                try {
                    const entries = readSchedulerEntries();
                    const instructions = computeCurrentInstructions(entries);
                    schedulerSnapshotEl.textContent = formatSnapshot(instructions);
                    const labels = Object.keys(instructions);
                    if (!labels.length) {
                        schedulerTickInFlight = false;
                        return;
                    }
                    for (const label of labels) {
                        const action = instructions[label];
                        if (!action) continue;
                        if (lastSchedulerActions.get(label) === action) continue;
                        try {
                            await updateEndpointState(label, action);
                            lastSchedulerActions.set(label, action);
                            logScheduler(`Set ${label} ‚Üí ${action} at ${new Date().toLocaleTimeString()}`);
                        } catch (err) {
                            logScheduler(`Error ${label}: ${err?.message || err}`);
                        }
                    }
                } finally {
                    schedulerTickInFlight = false;
                }
            }

            function restartSchedulerTimer() {
                if (schedulerTimer) clearInterval(schedulerTimer);
                schedulerTimer = setInterval(runScheduler, getSchedulerFrequencyMs());
            }

            schedulerEnabledEl.addEventListener('change', () => {
                save();
                resetSchedulerState();
                runScheduler();
            });

            schedulerFrequencyEl.addEventListener('change', () => {
                save();
                restartSchedulerTimer();
            });

            stateEndpointEl.addEventListener('change', () => {
                save();
                resetSchedulerState();
            });

            restartSchedulerTimer();
            runScheduler();

            compute();

            // ========== Cloud and App Synthetics Calculator ==========
            const agentTypeEl = document.getElementById('agentType');
            const testIntervalEl = document.getElementById('testInterval');
            const testTypeEl = document.getElementById('testType');
            const testTypeParamsEl = document.getElementById('testTypeParams');
            const unitsResultEl = document.getElementById('unitsResult');
            const monthlyUnitsResultEl = document.getElementById('monthlyUnitsResult');
            const calculationDisplayEl = document.getElementById('calculationDisplay');

            const MONTHLY_DAYS = 24 * 31; // 24 hrs * 31 days

            // Test type parameter configurations
            const testTypeConfigs = {
                'bgp': { params: [] },
                'network-agent-server': { params: [{ id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 }] },
                'network-agent-agent': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'twoWay', label: 'Two-way testing', type: 'checkbox', default: false }
                ]},
                'dns-server': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'numServers', label: 'Number of Servers', type: 'number', default: 1 }
                ]},
                'dns-trace': { params: [{ id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 }] },
                'http-server': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'timeout', label: 'Timeout (seconds)', type: 'number', default: 5 }
                ]},
                'page-load': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'pageLoadTimeout', label: 'Page Load Timeout (seconds)', type: 'number', default: 5 },
                    { id: 'pageLoadInterval', label: 'Page Load Interval (minutes)', type: 'number', default: 5 },
                    { id: 'httpTimeout', label: 'HTTP Timeout (seconds)', type: 'number', default: 5 },
                    { id: 'httpInterval', label: 'HTTP Interval (minutes)', type: 'number', default: 1 }
                ]},
                'transaction': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'timeout', label: 'Timeout (seconds)', type: 'number', default: 5 }
                ]},
                'sip-rtp': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'timeout', label: 'Timeout (seconds)', type: 'number', default: 5 }
                ]},
                'voice-calls': { params: [
                    { id: 'numAgents', label: 'Number of Agents', type: 'number', default: 1 },
                    { id: 'sipTimeout', label: 'SIP Timeout (seconds)', type: 'number', default: 5 },
                    { id: 'rtpTimeout', label: 'RTP Timeout (seconds)', type: 'number', default: 5 }
                ]}
            };

            function renderTestTypeParams() {
                const testType = testTypeEl.value;
                const config = testTypeConfigs[testType] || { params: [] };
                testTypeParamsEl.innerHTML = '';

                config.params.forEach(param => {
                    const control = document.createElement('div');
                    control.className = 'control';
                    const label = document.createElement('label');
                    label.setAttribute('for', param.id);
                    label.textContent = param.label;
                    control.appendChild(label);

                    if (param.type === 'checkbox') {
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = param.id;
                        input.name = param.id;
                        input.checked = param.default || false;
                        input.addEventListener('change', calculateSynthetics);
                        control.appendChild(input);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = param.id;
                        input.name = param.id;
                        input.min = '1';
                        input.step = param.id.includes('Timeout') || param.id.includes('Interval') ? '1' : '1';
                        input.value = param.default || '1';
                        input.addEventListener('input', calculateSynthetics);
                        control.appendChild(input);
                    }

                    testTypeParamsEl.appendChild(control);
                });
                calculateSynthetics();
            }

            function calculateSynthetics() {
                const agentType = agentTypeEl.value;
                const interval = parseFloat(testIntervalEl.value) || 1;
                const testType = testTypeEl.value;
                const isCloud = agentType === 'cloud';
                const multiplier = isCloud ? 2 : 1;

                let units = 0;
                const config = testTypeConfigs[testType] || { params: [] };

                // Get parameter values
                const params = {};
                config.params.forEach(param => {
                    const el = document.getElementById(param.id);
                    if (el) {
                        if (param.type === 'checkbox') {
                            params[param.id] = el.checked;
                        } else {
                            params[param.id] = parseFloat(el.value) || param.default || 1;
                        }
                    }
                });

                // Calculate based on test type
                // Formula: (60/interval) * 24 * 31 for interval-based calculations
                switch(testType) {
                    case 'bgp':
                        units = 8 * ((60 / 15) * MONTHLY_DAYS);
                        break;
                    case 'network-agent-server':
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'network-agent-agent':
                        const agentCount = params.twoWay ? (params.numAgents || 1) * 2 : (params.numAgents || 1);
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * agentCount;
                        break;
                    case 'dns-server':
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1) * (params.numServers || 1);
                        break;
                    case 'dns-trace':
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'http-server':
                        units = ((params.timeout || 5) / 2) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'page-load':
                        const pageLoadTimeout = params.pageLoadTimeout || 5;
                        const pageLoadInterval = params.pageLoadInterval || 5;
                        const httpTimeout = params.httpTimeout || 5;
                        const httpInterval = params.httpInterval || 1;
                        const part1 = pageLoadTimeout / pageLoadInterval;
                        const part2 = httpTimeout * ((1 / httpInterval) - (1 / pageLoadInterval));
                        units = (part1 + part2) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'transaction':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'sip-rtp':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'voice-calls':
                        const sipTimeout = params.sipTimeout || 5;
                        const rtpTimeout = params.rtpTimeout || 5;
                        units = (sipTimeout + rtpTimeout) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                }

                // Store base units before applying multiplier
                const baseUnits = units;

                // Build calculation breakdown
                let calcBreakdown = '';
                const intervalCalc = `(60 / ${interval}) * 24 * 31`;
                const intervalValue = (60 / interval) * MONTHLY_DAYS;
                
                switch(testType) {
                    case 'bgp':
                        calcBreakdown = `C = 8 units * (60 mins * 24 hrs * 31 days) / 15 mins\n`;
                        calcBreakdown += `C = 8 * ((60 / 15) * 24 * 31)\n`;
                        calcBreakdown += `C = 8 * ${((60 / 15) * MONTHLY_DAYS).toFixed(2)}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'network-agent-server':
                        calcBreakdown = `C = 2.5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = 2.5 * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = 2.5 * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'network-agent-agent':
                        const agentCount = params.twoWay ? (params.numAgents || 1) * 2 : (params.numAgents || 1);
                        const twoWayNote = params.twoWay ? ` (two-way: ${params.numAgents || 1} * 2)` : '';
                        calcBreakdown = `C = 2.5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${agentCount} agents${twoWayNote}\n`;
                        calcBreakdown += `C = 2.5 * ${intervalCalc} * ${agentCount}\n`;
                        calcBreakdown += `C = 2.5 * ${intervalValue.toFixed(2)} * ${agentCount}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'dns-server':
                        calcBreakdown = `C = 2.5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents * ${params.numServers || 1} servers\n`;
                        calcBreakdown += `C = 2.5 * ${intervalCalc} * ${params.numAgents || 1} * ${params.numServers || 1}\n`;
                        calcBreakdown += `C = 2.5 * ${intervalValue.toFixed(2)} * ${params.numAgents || 1} * ${params.numServers || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'dns-trace':
                        calcBreakdown = `C = 2.5 units * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = 2.5 * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = 2.5 * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'http-server':
                        const timeout = params.timeout || 5;
                        const timeoutHalf = timeout / 2;
                        calcBreakdown = `C = (timeout / 2) * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = (${timeout} / 2) * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${timeoutHalf} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'page-load':
                        const pageLoadTimeout = params.pageLoadTimeout || 5;
                        const pageLoadInterval = params.pageLoadInterval || 5;
                        const httpTimeout = params.httpTimeout || 5;
                        const httpInterval = params.httpInterval || 1;
                        const part1 = pageLoadTimeout / pageLoadInterval;
                        const part2 = httpTimeout * ((1 / httpInterval) - (1 / pageLoadInterval));
                        calcBreakdown = `C = ((page load timeout / page load interval) + (HTTP timeout * (1/HTTP interval - 1/page load interval))) * (60 mins * 24 hrs * 31 days) / ${interval} mins * agents\n`;
                        calcBreakdown += `C = ((${pageLoadTimeout} / ${pageLoadInterval}) + (${httpTimeout} * (1/${httpInterval} - 1/${pageLoadInterval}))) * ((60 / ${interval}) * 24 * 31) * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = (${part1.toFixed(2)} + ${part2.toFixed(2)}) * ${((60 / interval) * MONTHLY_DAYS).toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'transaction':
                        const transTimeout = params.timeout || 5;
                        calcBreakdown = `C = timeout * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = ${transTimeout} * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${transTimeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'sip-rtp':
                        const sipRtpTimeout = params.timeout || 5;
                        calcBreakdown = `C = timeout * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = ${sipRtpTimeout} * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${sipRtpTimeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                    case 'voice-calls':
                        const sipTimeout = params.sipTimeout || 5;
                        const rtpTimeout = params.rtpTimeout || 5;
                        const totalTimeout = sipTimeout + rtpTimeout;
                        calcBreakdown = `C = (SIP timeout + RTP timeout) * (60 mins * 24 hrs * 31 days) / ${interval} mins * ${params.numAgents || 1} agents\n`;
                        calcBreakdown += `C = (${sipTimeout} + ${rtpTimeout}) * ${intervalCalc} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${totalTimeout} * ${intervalValue.toFixed(2)} * ${params.numAgents || 1}\n`;
                        calcBreakdown += `C = ${baseUnits.toFixed(2)}`;
                        break;
                }

                // Apply cloud multiplier
                units = units * multiplier;

                // Add cloud multiplier to breakdown if needed
                if (isCloud) {
                    calcBreakdown += `\n\nCloud agent multiplier: 2x\n`;
                    calcBreakdown += `C = ${baseUnits.toFixed(2)} * 2\n`;
                }
                calcBreakdown += `\nC = ${units.toFixed(2)} units`;

                // Display results
                unitsResultEl.textContent = Math.round(units).toLocaleString();
                monthlyUnitsResultEl.textContent = Math.round(units).toLocaleString();
                calculationDisplayEl.textContent = calcBreakdown;
            }

            // ========== Configuration List Management ==========
            const addToConfigListBtn = document.getElementById('addToConfigList');
            const clearConfigListBtn = document.getElementById('clearConfigList');
            const configListEl = document.getElementById('configList');
            const totalUnitsDisplayEl = document.getElementById('totalUnitsDisplay');
            const totalCostDisplayEl = document.getElementById('totalCostDisplay');
            const contractDurationEl = document.getElementById('contractDuration');
            const UNIT_COST = 0.85; // Cost per unit per month
            let configList = [];

            // Load saved configurations
            function loadConfigList() {
                try {
                    const saved = localStorage.getItem('teSyntheticsConfigs');
                    if (saved) {
                        configList = JSON.parse(saved);
                        // Migrate old configs that might have originalUnits or unrounded units
                        configList = configList.map(config => {
                            if (config.originalUnits !== undefined) {
                                // Already migrated
                                return config;
                            } else if (config.units > 1000) {
                                // Old format - likely has unrounded units, migrate it
                                const roundedUnits = Math.ceil(config.units / 1000);
                                return {
                                    ...config,
                                    originalUnits: config.units,
                                    units: roundedUnits
                                };
                            }
                            // Assume it's already rounded (for new configs)
                            return config;
                        });
                        saveConfigList(); // Save migrated configs
                        renderConfigList();
                    }
                } catch (e) {
                    console.error('Failed to load config list:', e);
                }
            }

            // Save configurations
            function saveConfigList() {
                try {
                    localStorage.setItem('teSyntheticsConfigs', JSON.stringify(configList));
                } catch (e) {
                    console.error('Failed to save config list:', e);
                }
            }

            // Get current configuration
            function getCurrentConfig() {
                const agentType = agentTypeEl.value;
                const interval = parseFloat(testIntervalEl.value) || 1;
                const testType = testTypeEl.value;
                const params = {};
                
                // Get all parameter values
                const config = testTypeConfigs[testType] || { params: [] };
                config.params.forEach(param => {
                    const el = document.getElementById(param.id);
                    if (el) {
                        if (param.type === 'checkbox') {
                            params[param.id] = el.checked;
                        } else {
                            params[param.id] = parseFloat(el.value) || param.default || 1;
                        }
                    }
                });

                // Calculate units for this config
                const isCloud = agentType === 'cloud';
                const multiplier = isCloud ? 2 : 1;
                let units = 0;

                switch(testType) {
                    case 'bgp':
                        units = 8 * ((60 / 15) * MONTHLY_DAYS);
                        break;
                    case 'network-agent-server':
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'network-agent-agent':
                        const agentCount = params.twoWay ? (params.numAgents || 1) * 2 : (params.numAgents || 1);
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * agentCount;
                        break;
                    case 'dns-server':
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1) * (params.numServers || 1);
                        break;
                    case 'dns-trace':
                        units = 2.5 * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'http-server':
                        units = ((params.timeout || 5) / 2) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'page-load':
                        const pageLoadTimeout = params.pageLoadTimeout || 5;
                        const pageLoadInterval = params.pageLoadInterval || 5;
                        const httpTimeout = params.httpTimeout || 5;
                        const httpInterval = params.httpInterval || 1;
                        const part1 = pageLoadTimeout / pageLoadInterval;
                        const part2 = httpTimeout * ((1 / httpInterval) - (1 / pageLoadInterval));
                        units = (part1 + part2) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'transaction':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'sip-rtp':
                        units = (params.timeout || 5) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                    case 'voice-calls':
                        const sipTimeout = params.sipTimeout || 5;
                        const rtpTimeout = params.rtpTimeout || 5;
                        units = (sipTimeout + rtpTimeout) * ((60 / interval) * MONTHLY_DAYS) * (params.numAgents || 1);
                        break;
                }
                units = units * multiplier;

                // Divide by 1000 and round up
                const roundedUnits = Math.ceil(units / 1000);

                return {
                    id: Date.now(),
                    agentType,
                    interval,
                    testType,
                    params,
                    units: roundedUnits,
                    originalUnits: Math.round(units) // Keep original for reference if needed
                };
            }

            // Get test type display name
            function getTestTypeName(testType) {
                const names = {
                    'bgp': 'BGP Routing',
                    'network-agent-server': 'Network, Agent to Server',
                    'network-agent-agent': 'Network, Agent to Agent',
                    'dns-server': 'DNS Server',
                    'dns-trace': 'DNS Trace, DNSSEC',
                    'http-server': 'HTTP Server',
                    'page-load': 'Page Load',
                    'transaction': 'Transaction',
                    'sip-rtp': 'SIP Server, RTP Stream',
                    'voice-calls': 'Voice Calls'
                };
                return names[testType] || testType;
            }

            // Format configuration summary
            function formatConfigSummary(config) {
                let summary = `${getTestTypeName(config.testType)} - ${config.agentType === 'cloud' ? 'Cloud' : 'Enterprise'}`;
                summary += ` - ${config.interval} min interval`;
                
                if (config.params.numAgents) {
                    summary += ` - ${config.params.numAgents} agent${config.params.numAgents > 1 ? 's' : ''}`;
                }
                if (config.params.numServers) {
                    summary += ` - ${config.params.numServers} server${config.params.numServers > 1 ? 's' : ''}`;
                }
                if (config.params.twoWay) {
                    summary += ' - Two-way';
                }
                if (config.params.timeout) {
                    summary += ` - ${config.params.timeout}s timeout`;
                }
                if (config.params.sipTimeout && config.params.rtpTimeout) {
                    summary += ` - SIP:${config.params.sipTimeout}s, RTP:${config.params.rtpTimeout}s`;
                }
                
                return summary;
            }

            // Format currency
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }

            // Render configuration list
            function renderConfigList() {
                if (configList.length === 0) {
                    configListEl.innerHTML = `
                        <div style="text-align:center; padding:40px; color:var(--muted); font-size:14px;">
                            No configurations added yet. Configure a test above and click "Add to Configuration List".
                        </div>
                    `;
                    totalUnitsDisplayEl.textContent = '0';
                    const contractMonths = parseInt(contractDurationEl.value) || 12;
                    const contractYears = contractMonths / 12;
                    const costText = contractYears === 1 ? 'Total Cost (1 Year):' : 
                                    contractYears === 3 ? 'Total Cost (3 Years):' : 
                                    'Total Cost (5 Years):';
                    const totalCostLabelEl = document.getElementById('totalCostLabel');
                    if (totalCostLabelEl) {
                        totalCostLabelEl.textContent = costText;
                    }
                    totalCostDisplayEl.textContent = '$0.00';
                    return;
                }

                let html = '<table style="width:100%; border-collapse:collapse;">';
                html += '<thead><tr style="border-bottom:1px solid var(--border);">';
                html += '<th style="text-align:left; padding:8px; font-size:13px; color:var(--muted); font-weight:500;">Configuration</th>';
                html += '<th style="text-align:right; padding:8px; font-size:13px; color:var(--muted); font-weight:500;">Units (√ó1000)</th>';
                html += '<th style="text-align:right; padding:8px; font-size:13px; color:var(--muted); font-weight:500;">Cost/Month</th>';
                html += '<th style="width:60px; padding:8px;"></th>';
                html += '</tr></thead><tbody>';

                const contractMonths = parseInt(contractDurationEl.value) || 12;
                const contractYears = contractMonths / 12;
                
                // Sum original units, then divide by 1000 and round up
                let totalOriginalUnits = 0;
                let totalCost = 0;
                configList.forEach((config, index) => {
                    const monthlyCost = config.units * UNIT_COST;
                    const totalCostForConfig = monthlyCost * contractMonths;
                    // Sum original units for total calculation
                    totalOriginalUnits += (config.originalUnits || config.units * 1000);
                    totalCost += totalCostForConfig;
                    html += '<tr style="border-bottom:1px solid var(--border);">';
                    html += `<td style="padding:12px 8px; font-size:13px; color:var(--text);">${formatConfigSummary(config)}</td>`;
                    html += `<td style="text-align:right; padding:12px 8px; font-size:13px; color:var(--text); font-weight:500;">${config.units.toLocaleString()}</td>`;
                    html += `<td style="text-align:right; padding:12px 8px; font-size:13px; color:var(--text); font-weight:500;">${formatCurrency(monthlyCost)}</td>`;
                    html += `<td style="text-align:center; padding:12px 8px;">`;
                    html += `<button type="button" class="remove-config-btn" data-index="${index}" style="padding:4px 8px; border-radius:4px; border:1px solid var(--border); background:var(--panel); color:var(--text); cursor:pointer; font-size:11px;">Remove</button>`;
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                configListEl.innerHTML = html;

                // Add event listeners to remove buttons
                configListEl.querySelectorAll('.remove-config-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        configList.splice(index, 1);
                        saveConfigList();
                        renderConfigList();
                    });
                });

                // Calculate total units: sum original units, divide by 1000, round up
                const totalRoundedUnits = Math.ceil(totalOriginalUnits / 1000);
                totalUnitsDisplayEl.textContent = totalRoundedUnits.toLocaleString();
                
                // Update total cost label and display
                const totalCostLabelEl = document.getElementById('totalCostLabel');
                const costText = contractYears === 1 ? 'Total Cost (1 Year):' : 
                                contractYears === 3 ? 'Total Cost (3 Years):' : 
                                'Total Cost (5 Years):';
                if (totalCostLabelEl) {
                    totalCostLabelEl.textContent = costText;
                }
                totalCostDisplayEl.textContent = formatCurrency(totalCost);
            }

            // Add current configuration to list
            addToConfigListBtn.addEventListener('click', () => {
                const config = getCurrentConfig();
                configList.push(config);
                saveConfigList();
                renderConfigList();
            });

            // Clear all configurations
            clearConfigListBtn.addEventListener('click', () => {
                if (configList.length > 0 && confirm('Are you sure you want to clear all configurations?')) {
                    configList = [];
                    saveConfigList();
                    renderConfigList();
                }
            });

            // Update cost when contract duration changes
            contractDurationEl.addEventListener('change', () => {
                renderConfigList();
            });

            // Event listeners
            agentTypeEl.addEventListener('change', calculateSynthetics);
            testIntervalEl.addEventListener('change', calculateSynthetics);
            testTypeEl.addEventListener('change', () => {
                renderTestTypeParams();
            });

            // Initialize
            renderTestTypeParams();
            loadConfigList();
        })();
    </script>
</body>
</html>


